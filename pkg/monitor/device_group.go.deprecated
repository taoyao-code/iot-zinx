// DEPRECATED: æ­¤æ–‡ä»¶å·²åºŸå¼ƒï¼Œè¯·ä½¿ç”¨ pkg/core/connection_device_group.go
//
// åºŸå¼ƒåŸå› ï¼š
// 1. ä¸ pkg/core/connection_device_group.go å­˜åœ¨æ¶æ„å†²çª
// 2. ä¸ç¬¦åˆ"ä¸²è”è®¾å¤‡"æ¨¡å‹çš„ä¸šåŠ¡éœ€æ±‚
// 3. åŸºäº ICCID çš„è®¾å¤‡ç»„ç®¡ç†ä¸å®é™…çš„ TCP è¿æ¥ç®¡ç†ä¸åŒ¹é…
//
// è¿ç§»æŒ‡å—ï¼š
// - ä½¿ç”¨ core.GetGlobalConnectionGroupManager() æ›¿ä»£ monitor.GetGlobalDeviceGroupManager()
// - ä½¿ç”¨ ConnectionDeviceGroup æ›¿ä»£ DeviceGroup
// - è®¾å¤‡æ³¨å†Œä½¿ç”¨ RegisterDevice(conn, deviceID, physicalID, iccid)
// - è®¾å¤‡æŸ¥æ‰¾ä½¿ç”¨ GetConnectionByDeviceID(deviceID)

package monitor

import (
	"fmt"
	"sync"
	"sync/atomic"
	"time"

	"github.com/aceld/zinx/ziface"
	"github.com/bujia-iot/iot-zinx/internal/infrastructure/logger"
	"github.com/bujia-iot/iot-zinx/pkg/constants"
	"github.com/bujia-iot/iot-zinx/pkg/session"
	"github.com/sirupsen/logrus"
)

// ç±»å‹åˆ«åï¼Œé¿å…åœ¨åŒ¿åå‡½æ•°ä¸­çš„ç±»å‹å†²çª
type DeviceSession = session.DeviceSession

// DNYProtocolSender å®šä¹‰DNYåè®®å‘é€å™¨æ¥å£
// è¿™æ ·å¯ä»¥é¿å…å¾ªç¯å¯¼å…¥é—®é¢˜
type DNYProtocolSender interface {
	SendDNYData(conn ziface.IConnection, data []byte) error
}

// å…¨å±€DNYå‘é€å™¨
var globalDNYSender DNYProtocolSender

// SetDNYProtocolSender è®¾ç½®DNYåè®®å‘é€å™¨
// åœ¨ä¸»ç¨‹åºåˆå§‹åŒ–æ—¶è°ƒç”¨ï¼Œé¿å…å¾ªç¯ä¾èµ–
func SetDNYProtocolSender(sender DNYProtocolSender) {
	globalDNYSender = sender
}

// DeviceGroup è®¾å¤‡ç»„ï¼Œç®¡ç†åŒä¸€ICCIDä¸‹çš„å¤šä¸ªè®¾å¤‡
type DeviceGroup struct {
	ICCID     string                            // SIMå¡å·
	Devices   map[string]*session.DeviceSession // DeviceID -> DeviceSession
	CreatedAt time.Time                         // åˆ›å»ºæ—¶é—´
	UpdatedAt time.Time                         // æœ€åæ›´æ–°æ—¶é—´
	mutex     sync.RWMutex                      // è¯»å†™é”
}

// DeviceGroupManager è®¾å¤‡ç»„ç®¡ç†å™¨
type DeviceGroupManager struct {
	groups sync.Map // ICCID -> *DeviceGroup

	// ğŸ”§ æ–°å¢ï¼šå…¨å±€è®¾å¤‡ç»„ç®¡ç†é”ï¼Œç¡®ä¿è®¾å¤‡ç»„æ“ä½œçš„åŸå­æ€§
	globalGroupMutex sync.Mutex
}

// å…¨å±€è®¾å¤‡ç»„ç®¡ç†å™¨
var (
	globalDeviceGroupManager     *DeviceGroupManager
	globalDeviceGroupManagerOnce sync.Once
)

// GetDeviceGroupManager è·å–å…¨å±€è®¾å¤‡ç»„ç®¡ç†å™¨
func GetDeviceGroupManager() *DeviceGroupManager {
	globalDeviceGroupManagerOnce.Do(func() {
		globalDeviceGroupManager = &DeviceGroupManager{}
		logger.Info("è®¾å¤‡ç»„ç®¡ç†å™¨å·²åˆå§‹åŒ–")
	})
	return globalDeviceGroupManager
}

// NewDeviceGroup åˆ›å»ºæ–°çš„è®¾å¤‡ç»„
func NewDeviceGroup(iccid string) *DeviceGroup {
	return &DeviceGroup{
		ICCID:     iccid,
		Devices:   make(map[string]*session.DeviceSession),
		CreatedAt: time.Now(),
		UpdatedAt: time.Now(),
	}
}

// AddDevice å‘è®¾å¤‡ç»„æ·»åŠ è®¾å¤‡
func (dg *DeviceGroup) AddDevice(deviceID string, session *session.DeviceSession) {
	dg.mutex.Lock()
	defer dg.mutex.Unlock()

	// æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²å­˜åœ¨
	_, exists := dg.Devices[deviceID]

	dg.Devices[deviceID] = session
	dg.UpdatedAt = time.Now()

	// æ ¹æ®æ˜¯å¦ä¸ºæ–°è®¾å¤‡è®°å½•ä¸åŒçº§åˆ«çš„æ—¥å¿—
	if exists {
		logger.WithFields(logrus.Fields{
			"iccid":    dg.ICCID,
			"deviceID": deviceID,
			"total":    len(dg.Devices),
		}).Debug("è®¾å¤‡ä¼šè¯å·²æ›´æ–°")
	} else {
		logger.WithFields(logrus.Fields{
			"iccid":    dg.ICCID,
			"deviceID": deviceID,
			"total":    len(dg.Devices),
		}).Info("è®¾å¤‡å·²æ·»åŠ åˆ°è®¾å¤‡ç»„")
	}
}

// HasDevice æ£€æŸ¥è®¾å¤‡æ˜¯å¦å­˜åœ¨äºè®¾å¤‡ç»„ä¸­
func (dg *DeviceGroup) HasDevice(deviceID string) bool {
	dg.mutex.RLock()
	defer dg.mutex.RUnlock()

	_, exists := dg.Devices[deviceID]
	return exists
}

// RemoveDevice ä»è®¾å¤‡ç»„ç§»é™¤è®¾å¤‡
func (dg *DeviceGroup) RemoveDevice(deviceID string) {
	dg.mutex.Lock()
	defer dg.mutex.Unlock()

	delete(dg.Devices, deviceID)
	dg.UpdatedAt = time.Now()

	logger.WithFields(logrus.Fields{
		"iccid":    dg.ICCID,
		"deviceID": deviceID,
		"total":    len(dg.Devices),
	}).Info("è®¾å¤‡å·²ä»è®¾å¤‡ç»„ç§»é™¤")
}

// GetDevice è·å–è®¾å¤‡ç»„ä¸­çš„ç‰¹å®šè®¾å¤‡
func (dg *DeviceGroup) GetDevice(deviceID string) (*session.DeviceSession, bool) {
	dg.mutex.RLock()
	defer dg.mutex.RUnlock()

	session, exists := dg.Devices[deviceID]
	return session, exists
}

// GetAllDevices è·å–è®¾å¤‡ç»„ä¸­çš„æ‰€æœ‰è®¾å¤‡
func (dg *DeviceGroup) GetAllDevices() map[string]*session.DeviceSession {
	dg.mutex.RLock()
	defer dg.mutex.RUnlock()

	// è¿”å›å‰¯æœ¬ï¼Œé¿å…å¹¶å‘é—®é¢˜
	devices := make(map[string]*session.DeviceSession)
	for k, v := range dg.Devices {
		devices[k] = v
	}
	return devices
}

// GetDeviceCount è·å–è®¾å¤‡ç»„ä¸­çš„è®¾å¤‡æ•°é‡
func (dg *DeviceGroup) GetDeviceCount() int {
	dg.mutex.RLock()
	defer dg.mutex.RUnlock()

	return len(dg.Devices)
}

// GetOrCreateGroup è·å–æˆ–åˆ›å»ºè®¾å¤‡ç»„
func (dgm *DeviceGroupManager) GetOrCreateGroup(iccid string) *DeviceGroup {
	if group, exists := dgm.groups.Load(iccid); exists {
		return group.(*DeviceGroup)
	}

	// åˆ›å»ºæ–°çš„è®¾å¤‡ç»„
	newGroup := NewDeviceGroup(iccid)
	dgm.groups.Store(iccid, newGroup)

	logger.WithFields(logrus.Fields{
		"iccid": iccid,
	}).Info("åˆ›å»ºæ–°çš„è®¾å¤‡ç»„")

	return newGroup
}

// GetGroup è·å–è®¾å¤‡ç»„
func (dgm *DeviceGroupManager) GetGroup(iccid string) (*DeviceGroup, bool) {
	if group, exists := dgm.groups.Load(iccid); exists {
		return group.(*DeviceGroup), true
	}
	return nil, false
}

// AddDeviceToGroup å°†è®¾å¤‡æ·»åŠ åˆ°è®¾å¤‡ç»„
// ğŸ”§ é‡æ„ï¼šä½¿ç”¨å…¨å±€é”ç¡®ä¿è®¾å¤‡ç»„æ“ä½œçš„åŸå­æ€§
func (dgm *DeviceGroupManager) AddDeviceToGroup(iccid, deviceID string, session *session.DeviceSession) {
	// ğŸ”§ ä½¿ç”¨å…¨å±€è®¾å¤‡ç»„é”ï¼Œç¡®ä¿æ•´ä¸ªæ“ä½œçš„åŸå­æ€§
	dgm.globalGroupMutex.Lock()
	defer dgm.globalGroupMutex.Unlock()

	logFields := logrus.Fields{
		"iccid":     iccid,
		"deviceID":  deviceID,
		"operation": "AddDeviceToGroup",
	}

	// åˆ¤æ–­ICCIDæ˜¯å¦æœ‰æ•ˆ
	if iccid == "" {
		logger.WithFields(logFields).Warn("DeviceGroupManager: æ·»åŠ è®¾å¤‡åˆ°ç»„å¤±è´¥ï¼šICCIDä¸ºç©º")
		return
	}

	if session == nil {
		logger.WithFields(logFields).Warn("DeviceGroupManager: æ·»åŠ è®¾å¤‡åˆ°ç»„å¤±è´¥ï¼šä¼šè¯ä¸ºç©º")
		return
	}

	logger.WithFields(logFields).Info("DeviceGroupManager: å¼€å§‹æ·»åŠ è®¾å¤‡åˆ°ç»„")

	// ğŸ”§ å½»åº•æ¸…ç†è®¾å¤‡çš„æ—§ç»„å…³è”
	dgm.cleanupDeviceOldGroupAssociations(deviceID, iccid, logFields)

	// ğŸ”§ åŸå­æ€§æ·»åŠ è®¾å¤‡åˆ°æ–°ç»„
	group := dgm.GetOrCreateGroup(iccid)
	group.AddDevice(deviceID, session)

	// è®¾ç½®è®¾å¤‡çš„ICCIDå±æ€§
	session.ICCID = iccid

	logger.WithFields(logFields).WithField("groupSize", group.GetDeviceCount()).Info("DeviceGroupManager: è®¾å¤‡å·²æ·»åŠ åˆ°ç»„")
}

// ğŸ”§ æ–°å¢ï¼šæ¸…ç†è®¾å¤‡çš„æ—§ç»„å…³è”
func (dgm *DeviceGroupManager) cleanupDeviceOldGroupAssociations(deviceID, newICCID string, logFields logrus.Fields) {
	// æ³¨æ„ï¼šæ­¤æ–¹æ³•åœ¨å…¨å±€é”ä¿æŠ¤ä¸‹è°ƒç”¨ï¼Œæ— éœ€é¢å¤–åŠ é”

	// éå†æ‰€æœ‰è®¾å¤‡ç»„ï¼ŒæŸ¥æ‰¾è®¾å¤‡çš„æ—§å…³è”
	var oldGroups []string

	dgm.groups.Range(func(key, value interface{}) bool {
		iccid := key.(string)
		group := value.(*DeviceGroup)

		// è·³è¿‡ç›®æ ‡ç»„
		if iccid == newICCID {
			return true
		}

		// æ£€æŸ¥è®¾å¤‡æ˜¯å¦åœ¨æ­¤ç»„ä¸­
		if _, exists := group.GetDevice(deviceID); exists {
			oldGroups = append(oldGroups, iccid)
		}

		return true
	})

	// ä»æ—§ç»„ä¸­ç§»é™¤è®¾å¤‡
	for _, oldICCID := range oldGroups {
		if group, exists := dgm.GetGroup(oldICCID); exists {
			group.RemoveDevice(deviceID)

			logger.WithFields(logFields).WithFields(logrus.Fields{
				"oldICCID":     oldICCID,
				"oldGroupSize": group.GetDeviceCount(),
			}).Info("DeviceGroupManager: å·²ä»æ—§ç»„ä¸­ç§»é™¤è®¾å¤‡")

			// å¦‚æœæ—§ç»„ä¸ºç©ºï¼Œåˆ é™¤è¯¥ç»„
			if group.GetDeviceCount() == 0 {
				dgm.groups.Delete(oldICCID)
				logger.WithFields(logFields).WithField("deletedICCID", oldICCID).Info("DeviceGroupManager: å·²åˆ é™¤ç©ºçš„æ—§è®¾å¤‡ç»„")
			}
		}
	}

	if len(oldGroups) > 0 {
		logger.WithFields(logFields).WithFields(logrus.Fields{
			"cleanedGroups": oldGroups,
			"cleanedCount":  len(oldGroups),
		}).Info("DeviceGroupManager: è®¾å¤‡æ—§ç»„å…³è”æ¸…ç†å®Œæˆ")
	}
}

// RemoveDeviceFromGroup ä»è®¾å¤‡ç»„ç§»é™¤è®¾å¤‡
func (dgm *DeviceGroupManager) RemoveDeviceFromGroup(iccid, deviceID string) {
	if group, exists := dgm.GetGroup(iccid); exists {
		group.RemoveDevice(deviceID)

		// å¦‚æœè®¾å¤‡ç»„ä¸ºç©ºï¼Œåˆ é™¤è®¾å¤‡ç»„
		if group.GetDeviceCount() == 0 {
			dgm.groups.Delete(iccid)
			logger.WithFields(logrus.Fields{
				"iccid": iccid,
			}).Info("è®¾å¤‡ç»„å·²åˆ é™¤ï¼ˆæ— è®¾å¤‡ï¼‰")
		}
	}
}

// GetDeviceFromGroup ä»è®¾å¤‡ç»„è·å–ç‰¹å®šè®¾å¤‡
func (dgm *DeviceGroupManager) GetDeviceFromGroup(iccid, deviceID string) (*session.DeviceSession, bool) {
	if group, exists := dgm.GetGroup(iccid); exists {
		return group.GetDevice(deviceID)
	}
	return nil, false
}

// GetAllDevicesInGroup è·å–è®¾å¤‡ç»„ä¸­çš„æ‰€æœ‰è®¾å¤‡
func (dgm *DeviceGroupManager) GetAllDevicesInGroup(iccid string) map[string]*session.DeviceSession {
	if group, exists := dgm.GetGroup(iccid); exists {
		return group.GetAllDevices()
	}
	return make(map[string]*session.DeviceSession)
}

// BroadcastToGroup å‘è®¾å¤‡ç»„ä¸­çš„æ‰€æœ‰è®¾å¤‡å¹¿æ’­æ¶ˆæ¯
// ä¿®æ”¹ä¸ºæ”¯æŒç‹¬ç«‹é€šä¿¡æ¨¡å¼ï¼Œç¡®ä¿æ¶ˆæ¯æ­£ç¡®å‘é€åˆ°æ¯ä¸ªè®¾å¤‡
func (dgm *DeviceGroupManager) BroadcastToGroup(iccid string, data []byte) int {
	devices := dgm.GetAllDevicesInGroup(iccid)
	if len(devices) == 0 {
		return 0
	}

	// åˆ›å»ºå‰¯æœ¬ï¼Œé¿å…å¹¶å‘é—®é¢˜
	broadcastData := make([]byte, len(data))
	copy(broadcastData, data)

	// å¯¹äºå°æ•°é‡è®¾å¤‡ï¼Œç›´æ¥åŒæ­¥å‘é€
	if len(devices) <= 5 {
		return dgm.synchronousBroadcast(iccid, devices, broadcastData)
	} else {
		return dgm.concurrentBroadcast(iccid, devices, broadcastData)
	}
}

// synchronousBroadcast åŒæ­¥å¹¿æ’­ï¼ˆé€‚ç”¨äºå°‘é‡è®¾å¤‡ï¼‰
func (dgm *DeviceGroupManager) synchronousBroadcast(iccid string, devices map[string]*session.DeviceSession, data []byte) int {
	successCount := 0

	for deviceID, session := range devices {
		// ä¼˜åŒ–ï¼šæ£€æŸ¥è®¾å¤‡ä¼šè¯çŠ¶æ€ï¼Œé¿å…å‘ç¦»çº¿è®¾å¤‡å‘é€æ¶ˆæ¯
		if session.Status != constants.DeviceStatusOnline {
			continue
		}

		// ç›´æ¥è·å–è®¾å¤‡è¿æ¥ï¼ˆæ”¯æŒç›´è¿æ¨¡å¼ï¼Œä¸ä¾èµ–ä¸»ä»å…³ç³»ï¼‰
		if globalConnectionMonitor != nil {
			if conn, exists := globalConnectionMonitor.GetConnectionByDeviceId(deviceID); exists {
				var err error

				// å°è¯•ä½¿ç”¨DNYåè®®å‘é€
				if globalDNYSender != nil {
					err = globalDNYSender.SendDNYData(conn, data)
				} else {
					// å›é€€åˆ°åŸå§‹TCPå‘é€
					err = conn.SendMsg(0, data)
				}

				if err != nil {
					logger.WithFields(logrus.Fields{
						"deviceID": deviceID,
						"iccid":    iccid,
						"error":    err.Error(),
					}).Error("è®¾å¤‡ç»„å¹¿æ’­å¤±è´¥")
				} else {
					successCount++
				}
			} else {
				logger.WithFields(logrus.Fields{
					"deviceID": deviceID,
					"iccid":    iccid,
				}).Debug("è®¾å¤‡ä¸åœ¨çº¿ï¼Œè·³è¿‡å¹¿æ’­")
			}
		} else {
			logger.WithFields(logrus.Fields{
				"deviceID": deviceID,
				"iccid":    iccid,
			}).Error("å…¨å±€è¿æ¥ç›‘è§†å™¨æœªåˆå§‹åŒ–")
		}
	}

	logger.WithFields(logrus.Fields{
		"iccid":        iccid,
		"totalDevices": len(devices),
		"successCount": successCount,
		"mode":         "åŒæ­¥å¹¿æ’­",
	}).Info("è®¾å¤‡ç»„å¹¿æ’­å®Œæˆ")

	return successCount
}

// concurrentBroadcast å¹¶å‘å¹¿æ’­ï¼ˆé€‚ç”¨äºå¤§é‡è®¾å¤‡ï¼‰
func (dgm *DeviceGroupManager) concurrentBroadcast(iccid string, devices map[string]*session.DeviceSession, data []byte) int {
	// ç¡®å®šæ˜¯å¦ä¸ºDNYåè®®æ¶ˆæ¯
	isDNYProtocol := globalDNYSender != nil

	// è®°å½•å¼€å§‹æ—¶é—´
	startTime := time.Now()

	// ä½¿ç”¨å¹¶å‘é™åˆ¶ï¼Œé¿å…åˆ›å»ºè¿‡å¤šgoroutine
	maxConcurrent := 10
	if len(devices) < maxConcurrent {
		maxConcurrent = len(devices)
	}

	// åˆ›å»ºä¿¡å·é‡é€šé“é™åˆ¶å¹¶å‘æ•°
	semaphore := make(chan struct{}, maxConcurrent)

	// ç”¨äºç­‰å¾…æ‰€æœ‰å‘é€å®Œæˆ
	var wg sync.WaitGroup

	// ç”¨äºç»Ÿè®¡æˆåŠŸæ¬¡æ•°
	successCounter := int32(0)

	// é¦–å…ˆè¿‡æ»¤å‡ºæ‰€æœ‰åœ¨çº¿è®¾å¤‡
	activeDevices := make(map[string]*session.DeviceSession)
	for deviceID, session := range devices {
		if session.Status == constants.DeviceStatusOnline {
			activeDevices[deviceID] = session
		}
	}

	// å¯¹æ¯ä¸ªè®¾å¤‡å¹¶å‘å‘é€
	for deviceID, session := range activeDevices {
		wg.Add(1)

		// é™åˆ¶å¹¶å‘æ•°
		semaphore <- struct{}{}

		go func(deviceID string, devSession *DeviceSession) {
			defer wg.Done()
			defer func() { <-semaphore }() // é‡Šæ”¾ä¿¡å·é‡

			// ç›´æ¥è·å–è®¾å¤‡è¿æ¥ï¼ˆæ”¯æŒç›´è¿æ¨¡å¼ï¼‰
			if globalConnectionMonitor != nil {
				if conn, exists := globalConnectionMonitor.GetConnectionByDeviceId(deviceID); exists {
					var err error

					// æ ¹æ®åè®®ç±»å‹é€‰æ‹©å‘é€æ–¹å¼
					if isDNYProtocol {
						err = globalDNYSender.SendDNYData(conn, data)
					} else {
						err = conn.SendMsg(0, data)
					}

					if err != nil {
						logger.WithFields(logrus.Fields{
							"deviceID": deviceID,
							"iccid":    iccid,
							"error":    err.Error(),
						}).Error("è®¾å¤‡ç»„å¹¿æ’­å¤±è´¥")
					} else {
						atomic.AddInt32(&successCounter, 1)
					}
				}
			}
		}(deviceID, session)
	}

	// ç­‰å¾…æ‰€æœ‰å‘é€å®Œæˆ
	wg.Wait()
	close(semaphore)

	// ç»Ÿè®¡ç»“æœ
	finalSuccess := int(atomic.LoadInt32(&successCounter))
	elapsed := time.Since(startTime)

	logger.WithFields(logrus.Fields{
		"iccid":         iccid,
		"totalDevices":  len(devices),
		"activeDevices": len(activeDevices),
		"successCount":  finalSuccess,
		"elapsedMs":     elapsed.Milliseconds(),
		"mode":          "å¹¶å‘å¹¿æ’­",
		"protocol":      map[bool]string{true: "DNY", false: "åŸå§‹TCP"}[isDNYProtocol],
	}).Info("è®¾å¤‡ç»„å¹¿æ’­å®Œæˆ")

	return finalSuccess
}

// GetGroupStatistics è·å–è®¾å¤‡ç»„ç»Ÿè®¡ä¿¡æ¯
func (dgm *DeviceGroupManager) GetGroupStatistics() map[string]interface{} {
	var totalGroups, totalDevices int

	dgm.groups.Range(func(key, value interface{}) bool {
		totalGroups++
		if group, ok := value.(*DeviceGroup); ok {
			totalDevices += group.GetDeviceCount()
		}
		return true
	})

	return map[string]interface{}{
		"totalGroups":  totalGroups,
		"totalDevices": totalDevices,
	}
}

// ğŸ”§ æ–°å¢ï¼šè®¾å¤‡ç»„æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
func (dgm *DeviceGroupManager) CheckGroupIntegrity(context string) []string {
	dgm.globalGroupMutex.Lock()
	defer dgm.globalGroupMutex.Unlock()

	var issues []string
	deviceGroupMap := make(map[string]string) // deviceID -> iccid

	// éå†æ‰€æœ‰è®¾å¤‡ç»„ï¼Œæ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
	dgm.groups.Range(func(key, value interface{}) bool {
		iccid := key.(string)
		group := value.(*DeviceGroup)

		// æ£€æŸ¥è®¾å¤‡ç»„å†…éƒ¨ä¸€è‡´æ€§
		devices := group.GetAllDevices()
		for deviceID, session := range devices {
			// æ£€æŸ¥è®¾å¤‡æ˜¯å¦åœ¨å¤šä¸ªç»„ä¸­
			if existingICCID, exists := deviceGroupMap[deviceID]; exists {
				issues = append(issues, fmt.Sprintf("è®¾å¤‡ %s åŒæ—¶å­˜åœ¨äºå¤šä¸ªè®¾å¤‡ç»„: %s å’Œ %s", deviceID, existingICCID, iccid))
			} else {
				deviceGroupMap[deviceID] = iccid
			}

			// æ£€æŸ¥è®¾å¤‡ä¼šè¯çš„ICCIDæ˜¯å¦ä¸ç»„ICCIDä¸€è‡´
			if session.ICCID != iccid {
				issues = append(issues, fmt.Sprintf("è®¾å¤‡ %s åœ¨ç»„ %s ä¸­ï¼Œä½†ä¼šè¯ICCIDä¸º %s", deviceID, iccid, session.ICCID))
			}

			// æ£€æŸ¥è®¾å¤‡ä¼šè¯æ˜¯å¦ä¸ºç©º
			if session == nil {
				issues = append(issues, fmt.Sprintf("è®¾å¤‡ %s åœ¨ç»„ %s ä¸­çš„ä¼šè¯ä¸ºç©º", deviceID, iccid))
			}
		}

		// æ£€æŸ¥ç©ºè®¾å¤‡ç»„
		if len(devices) == 0 {
			issues = append(issues, fmt.Sprintf("å‘ç°ç©ºè®¾å¤‡ç»„: %s", iccid))
		}

		return true
	})

	if len(issues) > 0 {
		logger.WithFields(logrus.Fields{
			"context":    context,
			"issueCount": len(issues),
			"issues":     issues,
		}).Error("DeviceGroupManager: è®¾å¤‡ç»„æ•°æ®å®Œæ•´æ€§æ£€æŸ¥å‘ç°é—®é¢˜")
	} else {
		logger.WithField("context", context).Debug("DeviceGroupManager: è®¾å¤‡ç»„æ•°æ®å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡")
	}

	return issues
}

// ğŸ”§ æ–°å¢ï¼šæ¸…ç†åƒµå°¸è®¾å¤‡ç»„
func (dgm *DeviceGroupManager) CleanupZombieGroups(context string) int {
	dgm.globalGroupMutex.Lock()
	defer dgm.globalGroupMutex.Unlock()

	var zombieGroups []string

	// æŸ¥æ‰¾ç©ºçš„è®¾å¤‡ç»„
	dgm.groups.Range(func(key, value interface{}) bool {
		iccid := key.(string)
		group := value.(*DeviceGroup)

		if group.GetDeviceCount() == 0 {
			zombieGroups = append(zombieGroups, iccid)
		}

		return true
	})

	// åˆ é™¤åƒµå°¸è®¾å¤‡ç»„
	for _, iccid := range zombieGroups {
		dgm.groups.Delete(iccid)
		logger.WithFields(logrus.Fields{
			"context": context,
			"iccid":   iccid,
		}).Info("DeviceGroupManager: å·²æ¸…ç†åƒµå°¸è®¾å¤‡ç»„")
	}

	if len(zombieGroups) > 0 {
		logger.WithFields(logrus.Fields{
			"context":       context,
			"cleanedCount":  len(zombieGroups),
			"cleanedGroups": zombieGroups,
		}).Info("DeviceGroupManager: åƒµå°¸è®¾å¤‡ç»„æ¸…ç†å®Œæˆ")
	}

	return len(zombieGroups)
}
