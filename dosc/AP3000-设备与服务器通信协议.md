
电动自行车：设备-服务器通信协议指南

第8.6版

V8.6：增加95、96指令，82指令增加跳过短路检测，01指令删除工作模式。（20220401）

V8.5：增加73指令，06增加占位时长，增加升级校验包说明。

V8.4：增加8F指令，设置TC刷卡模式，增加充电柜相关协议。

V8.3：基础通信协议框架中增加对物理ID编码规程的描述，增加通讯模块固有数据的描述。

V8.2：心跳包21增加端口状态、结算03增加结算原因。

V8.1：增加09、0A、8E指令。

V8.0：02、03、06指令增加时间戳。82、84指令增加二维码背光灯控制。-20210705

V7.9：03和20更新增加0d（门磁开关故障）0e（接触不良或保险丝烧断故障）

V7.8：20命令中增加电源板的版本号，06命令中增加电压、电流、温度

V7.7：8A指令中增加费率模式1（定时带充满自停）

V7.6：增加0x89服务器播放语音指令。

V7.5：心跳包中端口状态和82充电应答增加存储器损坏状态，在82充电指令中加入最大充电时长和最大充电功率的设置功能

V7.4：增加新的语音，06指令中增加“验证码”状态

V7.3：增加获取服务器时间的22指令

V7.2：02指令中增加“跨区充电，余额不足”语音；

V7.1：02指令中增加语音；03指令中修改离线订单规则

V7.0：06指令中增加整个充电过程中峰值功率；20/01指令中增加设备的工作模式（联网/刷卡）；增加一条8D指令，服务器设置设备的工作模式（联网/刷卡）。

V6.9：02指令中增加对余额卡的读取，以及服务器清除余额卡的字段定义

V6.8：增加验证码充电功能的方法

V6.7：修改运行参数默认值，82应答中增加一个“多路设备功率超标”状态

V6.6：更正新产品的型号。

V6.5：把老版本中的01、04指令添加进来

V6.3：设置运行参数（84指令）中原预留字节其中一个，改为“打开/关闭判断用户拔出(光耦)“

V6.2：设备应答82指令，增加订单编号、端口号、待充端口字段；06指令增加“该时间段内消耗电量”字段，取消免费充电功能

V6.0：加入注册包（20指令），新心跳包（21指令）同时取消01指令，82指令中加入端口FF（智能判断）充电命令

V5.9：重新规划设备类型及固件版本号

V5.8：增加服务器读取、修改EEPROM的命令（8B和8C）

V5.7：修改01指令中的设备类型；设置最大功率重新定义 

V5.6：在03指令中断电原因增加超温功能，增加超温报警07指令，84指令中利用原预留字节增加超温报警设置，01心跳包中增加环境温度

V5.5：各参数设置命令中，设备应答增加参数错误状态

V5.4：01指令中增加设备类型的描述。增加固件升级中的设备类型；

V5.3：订单编号（03、06指令）增加验证码启动，以及随机数的描述。增加8a指令。

V5.2：修正了06心跳包的间隔时间错误

V5.1：修正了06心跳包中“充电时长”把原来1字节改成2字节

V5.0：01心跳包中修改了信号强度和设备类型的定义，01心跳包中2种端口故障做了区分；取消04订单确认命令；增加端口功率上传06指令；修改服务器查询设备状态81指令；03、06指令中增加“免费启动”功能；增加“免费启动”参数设置89指令；修改远程升级FB指令；增加服务器读取设备各种运行参数的指令；

V4.0：分机心跳包中增加通讯模块类型和信号强度，利用01和81命令的预留字段中的前2个字节


# **目录**
[1、基础通信协议框架	2](#_toc99440824)

[2、命令的定义	2](#_toc99440825)

[3、通讯模块固有的数据	2](#_toc99440826)

[各数据单位定义：	2](#_toc99440827)

[3、设备上传	3](#_toc99440828)

[3.0.1、设备心跳包（01指令）	3](#_toc99440829)

[3.0.2、设备注册包（20指令）	4](#_toc99440830)

[3.0.3、设备获取服务器时间（22指令）	4](#_toc99440831)

[3.1、设备心跳包（21指令）	4](#_toc99440832)

[3.2、刷卡操作（02指令）	4](#_toc99440833)

[3.3、结算消费信息上传（03指令）	5](#_toc99440834)

[3.4.1、充电端口订单确认（04指令）	6](#_toc99440835)

[3.4.2、端口充电时功率心跳包（06指令）	6](#_toc99440836)

[3.4.3、分机测试模式专用（09指令）（服务器无需处理，不会发送给服务器）	6](#_toc99440837)

[3.4.4、分机设置主机模块服务器地址（0A指令）（服务器无需处理，不会发送给服务器）	6](#_toc99440838)

[3.4.4、充电柜专有心跳包（41指令）	7](#_toc99440839)

[3.4.5、推送指令（42指令）	7](#_toc99440840)

[4.4.6、充电完成通知，但不结算（43指令）	7](#_toc99440841)

[4、服务器下发	7](#_toc99440842)

[4.1、查询设备联网状态（81指令）	7](#_toc99440843)

[4.2、服务器开始、停止充电操作（82指令）	7](#_toc99440844)

[4.2.1、服务器修改充电时长/电量（8a指令）	8](#_toc99440845)

[4.3.1、设置运行参数1.1（83指令）	8](#_toc99440846)

[4.3.2、设置运行参数1.2（84指令）	8](#_toc99440847)

[4.4.1、设置最大充电时长、最大充电功率（85指令）	9](#_toc99440848)

[4.4.2、设置用户卡参数（86指令）	9](#_toc99440849)

[4.4.3、复位重启设备（87指令）	9](#_toc99440850)

[4.4.4、存储器清零（88指令）	10](#_toc99440851)

[4.4.5、播放语音（89指令）	10](#_toc99440852)

[4.4.6、设置设备的工作模式（8D指令）	10](#_toc99440853)

[4.8.1、设备固件升级（E0升级分机指令）（E1升级电源板指令）（E2主机统一升级）（参考01指令中的设备类型表）	10](#_toc99440854)

[4.8.2、设备固件升级（F8指令）	11](#_toc99440855)

[4.9.1、服务器查询当前设备参数（90、91、92、93、94指令）	12](#_toc99440856)

[4.9.2、服务器读取EEPROM的数据（8B指令）	12](#_toc99440857)

[4.9.3、服务器写入EEPROM的数据（8C指令）	12](#_toc99440858)

[4.9.4、服务器修改二维码地址（8E指令）（最新固件才支持）	13](#_toc99440859)

[4.9.5、设置设备TC刷卡模式（8F指令）	13](#_toc99440860)

[4.9.6、充电柜停止充电，但不开柜门（72指令）	13](#_toc99440861)

[4.9.7、临时二维码（95指令）（带屏设备才有）	13](#_toc99440862)



1. ## **电动自行车基础通信协议框架**
### **1.0.1、设备通讯方式**
使用**TCP Socket**长连接模式，服务器不能随意踢设备的socket，只有当socket长时间没有数据上发时，服务器再踢掉死连接。

设备是使用通信模块**直连**服务器。

### **1.0.2、基础通信协议**

|包头（DNY）|长度|物理ID|消息ID|命令|数据|校验|
| :-: | :-: | :-: | :-: | :-: | :-: | :-: |
|3字节|2字节|4字节|2字节|1字节|n|2字节|

1. 为了减少包头和数据内容重叠概率，采用3字节包头，字符为“DNY” ，即16进制字节为0x44 0x4E 0x59。
1. 长度=物理ID+消息ID+命令+数据(n) +校验(2)，每包最多256字节
1. 校验：整个数据包中的每个字节（不包括校验字段本身），将它们的数值累加起来。然后取累加和的低2字节（16位），作为校验字段的值。
1. 此协议无其它注释情况下，均默认采用“小端模式”
1. 无特别注释下，均默认每条命令至多重新发送1次，故需加入无应答、重发机制，应答超时为15秒
1. 服务器和设备之间的通信，数据可能会被分包发送，所以服务器端要做粘包分包处理。
1. 服务器发给同一台设备时，每条命令之间必须有0.5秒以上的延时
1. 物理ID的编码规则：十六进制的设备编号是小端模式，首先转换成大端模式，最前一个字节是设备识别码，后3个字节是设备编号，设备编号直接转换成十进制就是二维码下方的编号了。比如二维码下方的十进制编号是13544000，二维码中的是40aace04，首先小端换成大端后就是04ceaa40，04就是识别码，ceaa40转换成十进制就是13544000。

   识别码：03=单路插座，04=双路插座，05=10路充电桩，06=16路充电桩，07=12路充电桩，09=主机，0A=漏保主机
### **1.03、命令的定义**
1. 为了防止命令重复，加入消息ID，每条命令的消息ID必须不同，但重发的命令的消息ID必须相同。
1. 为了防止命令错误，应答时的消息ID，必须和发送方的消息ID保持一致
1. 为了区分各个功能，加入命令，最大支持255条命令
1. 设备物理ID和设备上的二维码中的一致，无重复，不丢失
### **1.04、通讯模块固有的数据**
1、通讯模块每次连接到服务器通讯端口的时候，会发送一次流量卡的ICCID号；

2、当无数据通讯超过30秒，通讯模块会发送一串字符link，用于连接保活；
### **1.05、本协议单位的说明**
**单位除了指令内有特殊说明外，其他未注明的单位全部按下面执行：**

1. 所有金额以“分”为单位；
1. 所有日期以国际通用时间戳为准，例如1519865912则表示北京时间2018/3/1 8:58:32；
1. 所有时长（相对时间）以“秒“为单位；
1. 电压以0.1V为单位，例如2212，则表示是221.2V；
1. 所有功率以“0.1W“为单位，例如数据是2342，则表示是234.2W；
1. 所有耗电量以“0.01度“为单位，例如数据是135，则表示是1.35度；
1. 温度以1摄氏度为单位，温度数值需要减65才是准确数值，（0是无温度传感器，65是0度）


## **2、补一些重要的说明，一定要看**
### **2.0.1、关于协议内新增的字段说明（重要）**
协议的字段是随着时间根据需求而后增加的，对于有的设备未更新支持这些字段时，说明此设备**暂不支持**此字段，需要根据包**长度**去判断，

注：文档的**示例**同样如此，可能存在**未及时更新**的情况。

## **3、设备上传**
### **3.0.1、设备心跳包（01指令）(建议使用21指令，不管01指令)**
这是老版本指令，和20、21相对应。上电后发送此指令，如服务器不应答，则3次后不再发送。

设备发送：

|命令|固件版本|电压|端口数量|各端口状态|各端口当前功率|各端口峰值功率|虚拟ID|信号强度|设备类型|||
| :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :- | :- |
|0x01|2字节|2字节|1字节|n字节|n\*2字节|n\*2字节|1字节|1字节|1字节|||
|当前环境温度|工作模式|||||||||||
|1字节|1字节|||||||||||

如：44 4E 59 1D 00 3B 37 AB 04 B9 00 01 7E 00 8C 08 02 00 03 00 00 E4 00 00 00 3B 02 29 07 02 20 00 6D 05

服务器应答：

|命令|应答|
| :-: | :-: |
|0x01|1字节|

如：44 4E 59 0A 00 3B 37 AB 04 B9 00 01 00 D0 02

1. 应答=0成功，其它值错误
1. 固件版本：见20指令中的描述
1. 电压：见21指令中的描述
1. 端口数量：见21指令中的描述
1. 各端口状态：见21指令中的描述
1. 各端口峰值功率：开始充电后出现的峰值功率，和“端口数量”匹配，如端口数量是16，则“各端口峰值功率”为32字节；
1. 各端口当前功率：发送心跳包时当前采集到的功率；2个字节表示此端口当前输出的功率，和“端口数量”匹配，如端口数量是16，则“各端口当前功率”为32字节；
1. 虚拟ID：见20指令中的描述
1. 信号强度：见21指令中的描述
1. 当前环境温度：见21指令中的描述
1. 工作模式：见20指令中的描述
1. 设备类型：

|产品型号|设备类型(16进制)|设备识别码(16进制)|固件版本号(10进制)|升级命令(16进制)|设备请求升级命令(16进制)|每包数据(10进制)|
| :-: | :-: | :-: | :-: | :-: | :-: | :-: |
|旧款485|1/2/3或06或无|03或04|2\.xx|F8|05|256|
|旧款485-大功率|1/2/3或07或无|03或04|3\.xx|F8|05|256|
|旧款lora|02|03或04|1\.xx|E0|E0|200|
|旧款lora-大功率|05|03或04|1\.xx|E0|E0|200|
|旧款NB|08|03或04|1\.xx|E0|E0|200|
|旧款NB-大功率|09|03或04|1\.xx|E0|E0|200|
|旧款无线|0A|03或04|1\.xx|E0|E0|200|
|旧款无线-大功率|0B|03或04|1\.xx|E0|E0|200|
|最古老10路|70或无|05|1\.xx|F8|05|256|
|最古老16路|70或无|06|1\.xx|F8|05|256|
|最古老10路（帝鹏）|71或无|05|2\.xx|F8|05|256|
|最古老16路（帝鹏）|71或无|06|2\.xx|F8|05|256|
|旧款10路|1/2/3或04或无|05|3\.xx|F8|05|256|
|旧款10路（帝鹏/秉钧）|1/2/3或04或无|05|4\.xx|F8|05|256|
|旧款16路（洋涛定制）|1/2/3或04或无|06|6\.xx|F8|05|256|
|新款485|10|04|1\.xx|E0|E0|200|
|新款NB|14|04|1\.xx|E0|E0|200|
|新款10/16路|20|05或06|1\.xx|E0|E0|200|
|新款485双模|21|04|2\.xx|E0|E0|200|
|新款NB双模|22|04|2\.xx|E0|E0|200|
|新款GM35双模|23|04|3\.xx|E0|E0|200|
|新款WIFI双模|24|04|3\.xx|E0|E0|200|
|新款Lora双模|25|04|4\.xx|E0|E0|200|
|新款HW3000双模|26|04|5\.xx|E0|E0|200|
|新款GM5双模|27|04|3\.xx|E0|E0|200|
|新款485双模F460|28|04|6\.xx|E0|E0|200|
|新款10/16路F460|29|05或06|2\.xx|E0|E0|200|
|新款12路F460|30|07|1\.xx|E0|E0|200|

1. 此为心跳包，间隔时间默认为3分钟，方便服务器管理SocketIP
1. 设备如2次收不到服务器应答，则进入离线状态

### <a name="_toc99440830"></a>**3.0.2、设备注册包（20指令）**
设备发送：

|命令|固件版本|端口数量|虚拟ID|设备类型|工作模式|电源板版本号|
| :-: | :-: | :-: | :-: | :-: | :-: | :-: |
|0x20|2字节|1字节|1字节|1字节|1字节|2字节|

如：44 4E 59 13 00 3B 37 AB 04 B9 00 20 7E 00 02 14 21 00 00 00 E4 00 91 04

服务器应答：

|命令|应答|
| :-: | :-: |
|0x20|1字节|

如：44 4E 59 0A 00 3B 37 AB 04 B9 00 20 00 EF 02

1. 此命令在设备每次上电后发送，如果服务器无应答则每隔状态心跳包时间（默认3分钟）发送一次，如服务器有应答则不再发送。
1. 如以上信息任何一个字段有变动，设备必须重新执行发送流程
1. 固件版本，如100则表示V1.00版本
1. 端口数量：表示设备总共有多少个端口
1. 虚拟ID：需要内部组网的设备的本地地址，如485、LORA系列，如不需组网的设备，默认为00
1. 设备类型： 见01指令中的设备类型表
1. 工作模式：第0位：0=联网，1=刷卡。第1位：0=RN8209，1=BL0939。第2位：0=无短路预检，1=有短路预检。第3位：0=光耦检测模式，1=带灯模式。第4位：保留（fenc）。
1. 电源板版本号：电源板的固件版本号，如没有电源板的机型则为0
### <a name="_toc99440831"></a>**3.0.3、设备获取服务器时间（22指令）**
设备发送：

|命令|
| :-: |
|0x22|

如：44 4E 59 09 00 3B 37 AB 04 B9 00 22 F0 02

服务器应答：

|命令|时间戳|
| :-: | :-: |
|0x22|4字节|

如：44 4E 59 0D 00 3B 37 AB 04 B9 00 22 09 0E A9 5F 13 04

1. 此命令设备每次上电后就会发送，直至服务器应答后就停止发送。如服务器无应答，则每隔3分钟发送一次请求。
1. 每12小时从服务器获取一次时间，如服务器不应答则每隔3分钟发送一次请求。
### **3.0.4、设备主动请求升级（05指令）**
设备发送：

|命令|设备类型|设备版本号|升级包类型|
| :-: | :-: | :-: | :-: |
|0x05|1字节|2字节|4字节|

服务器应答：无须应答

`		`注1、用于设备主动请求服务器对本台设备进行升级，硬件对接用不到本指令，2024-10-31增加。

`		`注2、设备类型：当前设备的设备类型。

`		`注3、设备版本号：当前设备的固件版本号。

`		`注4、升级包类型：用于区分当前设备的固件包用的。


### <a name="_toc99440832"></a>**3.1、设备心跳包（21指令）**
设备发送：

|命令|电压|端口数量|各端口状态|信号强度|当前环境温度|
| :-: | :-: | :-: | :-: | :-: | :-: |
|0x21|2字节|1字节|n字节|1字节|1字节|

如：44 4E 59 10 00 3B 37 AB 04 01 00 21 98 08 02 00 00 09 05 EE 02

服务器应答：

|命令|应答|
| :-: | :-: |
|0x21|1字节|

如：44 4E 59 0A 00 3B 37 AB 04 01 00 21 00 38 02

1. 应答=0成功，其它值错误
1. 电压：设备的当前电压（打包发送心跳包指令时的当前时间点的实时电压）
1. 端口数量：表示设备总共有多少个端口，和后面的“端口状态”配套
1. 各端口状态：一个字节表示一个端口，和“端口数量”匹配，如端口数量是16，则“各端口状态”为16字节； 每个字节表示的意思，0=空闲，1=充电中，2=有充电器但未充电（用户未启动充电），3=有充电器但未充电（已充满电），4=该路无法计量，5=浮充，6=存储器损坏，7＝插座弹片卡住故障，8＝接触不良或保险丝烧断故障，9＝(算法-继电器粘连)，0x0A=霍尔开关损坏（即插入检测传感器）。0x0B=（预检-继电器坏或保险丝断），0x0D=（预检-负载短路）。0x0E=(过滤性预检-继电器粘连),0x0F=(刷卡芯片损坏故障)，0x10=（检测电路故障）2023-03-03。
1. 信号强度：指分机与主机之间的无线信号强度，如LORA信号。00则为有线组网或无信号强度功能。
1. 当前环境温度：表示当前设备内的温度，可能和真正的当前环境温度有一定的误差，如00则表示无此功能
1. 此为心跳包，间隔时间默认为3分钟，方便服务器管理SocketIP
1. 设备如2次收不到服务器应答，则进入离线状态
### <a name="_toc99440833"></a>**3.2、刷卡操作（02指令）**
特别注意：上报的端口号如果不是FF为端口请求充电，服务器需应答刷卡指令后，如果服务器需要给当前端口启动充电的，需要下发82指令来启动充电。

设备发送：

|命令|卡片ID|卡片类型|端口号|余额卡内金额|时间戳|卡号2字节数|卡号2|
| :-: | :-: | :-: | :-: | :-: | :-: | - | :-: |
|0x02|4字节|1字节|1字节|2字节|4字节|1字节|N字节|

如：44 4E 59 11 00 3B 37 AB 04 01 00 02 7A 8D 05 DD 00 01 00 00 0A 04

服务器应答：

|命令|卡片ID|账户状态|费率模式|余额/有效期|端口号|
| :-: | :-: | :-: | :-: | :-: | :-: |
|0x02|4字节|1字节|1字节|4字节|1字节|

如：44 4E 59 14 00 3B 37 AB 04 01 00 02 7A 8D 05 DD 00 00 10 27 00 00 01 44 04

1. 卡片ID：即M1卡的4字节UID，即M1卡第0扇区第0块最前面4字节，如使用我们的卡，转换十进制时需使用大端模式。
1. 卡片类型：=0(旧卡)，=1(新卡)，通知服务器此卡为全新卡片。设备先使用用户卡密码读卡，如果读取成功，则为旧卡；失败则尝试使用新卡密码读取，如果读取成功，则为新卡；

   ~~=2（余额卡），说明此卡为刷卡设备使用的余额卡，此功能为把原来的刷卡设备转为联网设备使用~~，目前已弃用。

   =3（只取UID卡号），说明此卡不知道密码，只能读取到UID（2023-03-03）。

   =4（社保卡），即社保卡的识别码，使用卡号2上传，社保卡识别号为16字节。（2023-12-11新增）

1. 余额/有效期：分为2种，其一金额，其二时间戳。卡片“余额/有效期“的具体使用情况，需看设备处于哪种费率模式(计时计量计次为余额，包月为有效期)
1. 时间戳：上发指令当时的时间，有时候不准确，该字段属于调试使用，服务器无需关心此字段。
1. 卡号2字节数：即表示后面卡号2所占的字节数。（2023-12-11新增）
1. 卡号2：部分卡的卡号较长，使用卡号2字段来上传。（2023-12-11新增）（卡类型未说明使用卡号2的情况，则没有此字节）
1. 账户状态：=00正常，=01未注册（语音“未注册卡”)，=02请绑卡（语音“请再次刷卡”)，=03请解卡（语音“请再次刷卡”)，=04包月用户重复刷卡（语音“请勿重复充电”)，=05包月用户已超限制次数（语音“超出限额次数”)，=06余额不足（语音“余额不足”)，=07包月用户已过有效期（语音“已过有效期”)，=08端口故障（语音“端口故障”），=09清除余额卡内金额且把联网卡扇区密码改为用户卡（语音“请再次刷卡”），=0A包月用户已超限制时长（语音“超出限额时长”)，=0B请勿跨公众号（语音“请勿跨公众号使用”），=0C此设备未注册（语音“此设备未注册”) ，=0D请购买包月（语音“请购买包月”) ，=0E跨区充电，余额不足（语音“跨区充电，余额不足”) ，=0F包月设备，无法使用（语音“包月设备，无法使用”) ，=10包月设备，跨区无法使用（语音“包月设备，跨区无法使用”) ，=11临时设备，无法使用（语音“临时设备，无法使用”) ，=12临时设备，跨区无法使用（语音“临时设备，跨区无法使用”)；

   涂黄部分仅适用于AP262、AP360机型

1. 费率模式：=0计时模式，=1包月模式，=2计量，=3计次。用于指示设备如何理解“余额/有效期”中的数据
1. 端口号：=0xFF则表示仅查询余额，服务器应答时应和设备发送的保持一致。不是0xFF则为刷卡充电请求。
1. 账户状态：对账户状态的补充说明，如果服务器回复00（正常），端口号如果是FF，则设备播报服务器应答的余额，端口号如果不是FF，则设备不做播报动作。
1. 服务器端一般遵循如下原则：新卡+未绑定用户=1（未注册卡），新卡+已绑定用户=2（请绑卡），旧卡+未绑定用户=3（请解卡），旧卡+已绑定用户=0（正常）。如不考虑离线刷卡充电，则不要使用“请绑卡和请解卡”。
### <a name="_toc99440834"></a>**3.3、结算消费信息上传（03指令）**

设备发送：

|命令|充电时长|最大功率|耗电量|端口号|在线/离线启动/验证码|卡号/验证码|停止原因|订单编号|第二最大功率|
| :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: |
|0x03|2字节|2字节|2字节|1字节|1字节|4字节|1字节|16字节|2字节|
|时间戳|占位时长|||||||||
|4字节|2字节|||||||||
如：44 4E 59 28 00 3B 37 AB 04 01 00 03 10 0E E8 03 30 00 01 01 00 00 00 00 01 20 19 09 01 18 00 00 13 00 30 38 01 02 03 04 05 E8 03 44 05

服务器应答：（服务器必需应答，）

|命令|应答|
| :-: | :-: |
|0x03|1字节|

如：44 4E 59 0A 00 3B 37 AB 04 01 00 03 00 1A 02

1. 充电时长：整个充电过程的时长
1. 最大功率：整个充电过程中出现的最大功率
1. 耗电量：整个充电过程消耗的电量
1. 在线/离线启动：=0表示离线刷卡启动充电 ；=1表示在线服务器指令启动； 3=验证码启动（仅支持带按键和屏幕的机型）。

   ||16字节|
   | - | - |
   |0=离线刷卡启动|年月日时分秒+卡号+设备号+端口号（端口号固定加30）|
   |1=在线启动|服务器在82命令中下发的订单编号|
   |3=验证码启动|年月日时分秒+00+验证码+设备号+端口号（端口号固定加70）|

   备注：1、主机都带有RTC功能，上电时默认为1970年1月1日08:00:00（北京时间），每隔12小时从服务器校准一次时间

   `      `2、年月日时分秒为10进制，卡号为16进制，验证码为10进制，设备号为10进制，端口号为10进制

   `      `3、该订单编号规则仅适用于AP262、AP360及将来的新款机型。

1. 卡号/验证码：在线启动时则卡片ID为全0，离线启动时根据“在线/离线启动”中的标志，内容不同，验证码功能仅适用于AP350和AP360系列机型。
1. 停止原因：1(充满自停)  2(达到最大充电时间)  3(达到预设时间)  4（达到预设电量）5(用户拔出)  6(负载过大)，7(服务器控制停止)  8（动态过载） 9（功率过小） 0A（环境温度过高） 0B（端口温度过高） 0C（过流） 0D（用户拔出-1，可能是插座弹片卡住） 0E（无功率停止，可能是接触不良或保险丝烧断故障），0F（预检-继电器坏或保险丝断），注：0A仅适用于AP262、AP360； 0B仅适用于AP262，0x10=水浸断电，0x11=灭火结算（本端口），0x12=灭火结算（非本端口），0x13=用户密码开柜断电，0x14=未关好柜门，0x15=外部操作停止，0x16=刷卡操作停止，0x17=服务器强制停止（主要用于充电柜强制开柜门）,0x18=消防系统触发停止，（0x19=存储器错误，0x1A=过压，0x1B=欠压：2024-08-07新增），0x1C=低功率断电（2024-11-21增加）。
1. 第二最大功率：开始充电5分钟内出现的最大功率
1. 验证码：物理ID、当前时间戳（规整到分钟）、端口号进行CRC32校验，取10进制最后6位，有效时间正负2分钟。

   typedef \_\_packed struct

   {

   uint32\_t phyid;//物理ID

   uint32\_t tt;//RTC时间戳

   uint8\_t  num;//端口号

   }calc\_code\_ch\_t;//验证码充电结构体

   check\_code = CRC32Calculate(&set, sizeof(set));

   check\_code = check\_code%1000000;//取10进制低6位

   tt = tt-(tt%60);

1. 此命令存到EEPROM中，必须要收到服务器应答才能删除，断电2秒后发送一次。如没收到服务器应答则每隔30分钟发送一次给服务器，有应答后下一条则为1分钟后发送。
1. 时间戳：上发指令当时的时间，有时候不准确，该字段属于调试使用，服务器无需关心此字段。
1. 占位时长：（充电柜专用，其他设备忽略此字段）表示充满后占用设备的时长，单位为分钟。
### <a name="_toc531641167"></a><a name="_toc99440835"></a>**3.4.1、充电端口订单确认（04指令）**
这是老版本指令，和06相对应，有06指令时无此命令（2019年6月份后生产的机型已无此指令）

设备发送：

|命令|端口号|在线/离线启动|卡片ID|充电时长|订单编号|
| :-: | :-: | :-: | :-: | :-: | :-: |
|0x04|1字节|1字节|4字节|2字节|16字节|

服务器应答：

|命令|端口号|应答|
| :-: | :-: | :-: |
|0x04|1字节|1字节|

1. 此命令在开始充电后发送，如果服务器无应答则每隔心跳包时间发送一次，直至充电结束，如服务器有应答则不再发送。如果中间出现停电，重新来电后会再次发送。
1. 此命令有可能在82命令的应答前发出，所以服务器端应做好相应处理。
1. 在线/离线启动：参考03命令中的解释。
1. 卡片ID：参考03命令中的解释
1. 充电时长：到当前为止，已经充电多长时间
1. 订单编号：参考03命令中的解释。不同点：离线启动时，结束时间为当前时间戳（需主机带RTC功能）

### <a name="_toc99440836"></a>**3.4.2、端口充电时功率心跳包（06指令）**
这是新版本指令，和04相对应，有04指令时无此命令

设备发送：

|命令|端口号|端口状态|充电时长|当前订单累计电量|在线/离线启动/验证码|实时功率|心跳包期间最大功率|心跳包期间最小功率|
| :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: |
|0x06|1字节|1字节|2字节|2字节|1字节|2字节|2字节|2字节|

|心跳包期间平均功率|订单编号|该时间段内消耗电量|峰值功率|电压|电流|环境温度|端口温度|时间戳|占位时长|
| :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: |
|2字节|16字节|2字节|2字节|2字节|2字节|1字节|1字节|4字节|2字节|

如：44 4E 59 32 00 3B 37 AB 04 0A 00 06 01 01 10 0E 30 00 01 E8 03 B0 04 20 03 E8 03 20 19 09 01 18 00 00 13 00 30 38 01 02 03 04 05 01 00 E8 03 98 08 C7 01 55 00 DA 08

服务器应答：无须应答

1. 此命令设备开始充电后（82命令应答后）每隔设5分钟发送1次（无重发机制）， 充电结束后即停止发送；
1. 端口号：当前充电的端口号。注：00表示1号端口，01表示2号端口
1. 各端口状态： 1=充电中， 2=已扫码，暂未检测到功率，等待插入充电器（充电柜专有，如单车桩出现此值为出错值请忽略），3=有充电器但未充电（已充满电），5=浮充，其他值=出错值请忽略。
1. 充电时长：开始充电到当前为止，已经充电多长时间
1. 当前订单累计电量：当前端口的订单，开始充电到当前为止，已经消耗的电量
1. 在线/离线启动：=0表示启动时，处于离线状态 ；=1表示启动时，处于在线状态； 3=验证码启动（仅支持带按键和屏幕的机型）
1. 实时功率：心跳包发送时的当前功率
1. 心跳包期间最大功率：心跳包期间出现过的最大功率
1. 心跳包期间最小功率：心跳包期间出现过的最大功率
1. 心跳包期间平均功率：心跳包期间的平均功率
1. 订单编号：参考03命令中的解释。
1. 该时间段内消耗电量：此数据需除以4800后才是真实的电量，该字段属于调试使用，服务器无需关心此字段。
1. 峰值功率：整个充电过程中出现过的最大功率，有些版本无此字段
1. 电压：设备的当前电压
1. 电流：设备的当前电流，可以计量芯片采集也可以通过计算得出,0.001A为单位，1000表示1A电流。
1. 环境温度：设备的当前环境温度，仅针对有此功能的机型
1. 端口温度：设备的当前充电端口的温度，仅针对有此功能的机型
1. 时间戳：上发指令当时的时间，有时候不准确，该字段属于调试使用，服务器无需关心此字段。
1. 占位时长：（充电柜专用，其他设备忽略此字段）表示充满后占用设备的时长，单位为分钟。
### <a name="_toc99440837"></a>**3.4.3、分机测试模式专用（09指令）（服务器无需处理，不会发送给服务器）**
设备发送：

|命令|端口状态|电压|功率|
| :-: | :-: | :-: | :-: |
|0x09|2字节|2字节|4字节|
### <a name="_toc99440838"></a>**3.4.4、分机设置主机模块服务器地址（0A指令）（服务器无需处理，不会发送给服务器）**
设备发送：

|命令|端口号|模块类型|SOCKB|地址|
| :-: | :-: | :-: | :-: | :-: |
|0x0A|2字节|1字节|1字节|46字节|
### <a name="_toc99440839"></a>**3.4.4、充电柜专有心跳包（41指令）**
设备发送：

|命令|端口数量|门状态|风扇状态||
| :-: | :-: | :-: | :-: | :-: |
|0x41|1字节|4字节|4字节||
服务器应答：无须应答

1. 端口数量：表示设备有多少个端口。
1. 门状态：使用位表示，0=关闭，1=开门。
1. 风扇状态：使用位表示，0=关闭，1=打开。


### <a name="_toc99440840"></a>**3.4.5、报警推送指令（42指令）**
设备发送：

|命令|推送类型|端口号|触发口|
| :-: | :-: | :-: | :-: |
|0x42|1字节|1字节|1字节|

服务器应答：无须应答

1. 推送类型：1=断电，2=水浸，3=热熔胶触发，4=烟感报警，5=温感报警，6=水位报警， 7=柜门弹开（2024-11-20）。
1. 端口号：发生报警的端口号（如热熔胶触发），如断电等不区分端口的，此字段无意义（2023-02-24）。
1. 端口号：（水浸，烟感，温感，水位）上传所接485设备的地址，设备自身触发的上传0
1. 端口号为上传485设备的地址才有触发口：没有多个触发口的上传0；多路输入：1-8号口哪个触发1-8位哪位置1

### <a name="_toc99440841"></a>**3.4.6、充电完成通知，但不结算（43指令）**
`	`注：仅充电柜才支持

设备上发：

|命令|充电时长|最大功率|耗电量|端口号|在线/离线启动/验证码|卡号/验证码|停止原因|订单编号|
| :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: |
|0x43|2字节|2字节|2字节|1字节|1字节|4字节|1字节|16字节|

服务器应答：无需应答。

内容解析见03指令。


### **3.4.7、端口推送指令（44指令）**
设备发送：

|命令|推送类型|端口号|订单编号|
| :-: | :-: | :-: | :-: |
|0x44|1字节|1字节|16字节|

服务器应答：无须应答

1. 推送类型：1=柜门未关好。

## <a name="_toc99440842"></a>**4、服务器下发**
### <a name="_toc99440843"></a>**4.1、查询设备联网状态（81指令）**
`		`服务器发送：

|命令|
| :-: |
|0x81|

如：44 4E 59 09 00 3B 37 AB 04 01 00 81 97 02

设备应答：无须应答

1. 此命令应用于注册网络后，通信过程中，服务器主动查询设备状态
1. 此命令会触发设备发送“注册包”20、“设备心跳包”01和21指令（上发时间会因设备不同而不同）
### <a name="_toc99440844"></a>**4.2、服务器开始、停止充电操作（82指令）**
服务器发送：

|命令|费率模式|余额/有效期|端口号|充电命令|充电时长/电量|订单编号|最大充电时长|过载功率|二维码灯|
| :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: | :-: |
|0x82|1字节|4字节|1字节|1字节|2字节|16字节|2字节|2字节|1字节|
|长充模式|额外浮充时间|是否跳过短路检测|不判断用户拔出|强制带充满自停|<p>充满功率</p><p>2023-03-04</p>|充满功率最长判断时间||||
|1字节|2字节|1字节|1字节|1字节|1字节|1字节||||
如：44 4E 59 26 00 3B 37 AB 04 02 00 82 00 64 01 00 00 01 01 00 00 12 34 56 78 12 34 56 78 12 34 56 78 12 34 56 78 80 70 88 13 F8 08

设备应答：

|命令|应答|订单编号|端口号|待充端口|
| :-: | :-: | :-: | :-: | :-: |
|0x82|1字节|16字节|1字节|2字节|

如：44 4E 59 1D 00 3B 37 AB 04 02 00 82 00 12 34 56 78 12 34 56 78 12 34 56 78 12 34 56 78 01 00 00 FE 06

1. 费率模式：=0计时，=1包月，=2计量，=3计次。包月、计次默认充满自停，计时、计量可手动设置时长和电量。
1. 余额/有效期：设备仅仅用于语音播报作用，当费率模式为计时、计量、计次时，数据为余额；当费率模式为包月时，数据为有效期（时间戳）, 大于100000000这个值会当成时间报有效期。
1. 充电命令=0(停止充电)（远程停止充电需要下发对当前正在充电的订单号，如果订单号对不上则无法远程停止），=1(开始充电)设备充电与否依据此字段
1. 端口号：指充电桩的插口号，端口号从0开始，如0x00-0x0F则代表第1路-第16路，0x00=第1路，0x09=第十路，0x0A=第十一路，FF=设备智能选择端口（服务器下发）；
1. 充电时长：告知设备的充电时长。如是0x0000则说明是充满自停；其他数值则按照时长充电，且充满不会自停，并且不受设置的“最大充电时间”限制。
1. 充电电量：告知设备的充电电量。如是0x0000则说明是充满自停；其他数值则按照电量充电，且充满不会自停，但受设置的“最大充电时间”限制。
1. 订单编号设备会保存，当充电结束时通过结算消费信息返回给服务器，服务器端自行判断是否使用。可以是16个十六进制的任何数，设备不会对订单号处理，结算和心跳包都按服务器下发的格式回传给服务器，如十六进制的20 23 05 03 23 42 23 41 41 93 99 13 12 68 41 05。
1. 最大充电时长、过载功率：（只对当前端口当前订单有效，不影响其他端口）动态设置此参数，如果参数为0表示不修改，会使用设备的设置值，默认10小时。作为85指令的补充，85指令设置完后是保存在设备存储器中，上电的时候读入到内存中。82指令下发的是直接修改内存中参数。
1. 二维码灯：0＝打开，1＝关闭，针对部分有二维码灯的设备有效。此设置是针对下一次插头插入时是否点亮二维码背光灯，保存在内存中，断电重启后就会失效。
1. 长充模式：（特殊需求，正常情况不需开启，传0 即可），0=关闭，1=打开。长充模式=浮充完成后不断电，解决用户电池漏电问题（反馈充不满），功率降低后，会降低收费，不会多收太多费用。
1. 额外浮充时间：（特殊需求，正常情况不需开启，传0 即可），即额外增加的浮充时间，单位秒，如果下发的是0xFFFF，则为取消浮充，且检测绿灯统一改为5分钟。
1. 充满功率：（特殊需求，正常情况不需开启，传0 即可），浮充完成后，判断实时功率是否小于充满功率，如小于则断电，如大于则继续充电，后面每5分钟判断一次此过程，默认最长判断60分钟，用于改进充不满问题。单位是1瓦，注意和其他指令功率0.1瓦单位不同，特别要注意。当充满功率为0x00或为0xFF时，则为关闭此功能。默认关闭此功能（2023-03-04）。
1. 充满功率最长判断时间：（特殊需求，正常情况不需开启，传0 即可），单位是分钟，即上面过程最长判断的时间。
1. 应答：执行开始充电命令，=0执行成功（启动或停止充电），=1端口未插充电器（不执行），=2端口状态和充电命令相同（不执行），=3端口故障（执行），=4无此端口号（不执行），=5有多个待充端口（响应FF充电命令，不执行，只针对双路，双路设备的二维码只有一个，且端口号为FF，当2个口都插了充电器，服务器下发充电端口为FF时，设备检测到有2个口待充电，不知道充哪个，就会返回此应答），=6多路设备功率超标（不执行），

   7=存储器损坏，8=（预检-继电器坏或保险丝断），9=（预检-继电器粘连）（执行给充电），0x0A=（预检-负载短路）,0x0B=（烟感报警），(0x0C=过压，0x0D=欠压，0x0E=未响应：2024-08-07新增)。

1. 待充端口：当应答=5的时候，此数据才是有效的。按照bit定义各待充端口状态，0=非待充，1=待充。
1. 设备业务流程：充电命令=1如执行充电则报出余额/有效期。充电命令=0则停止充电，此时除了端口号会忽略其他数据，如执行停止充电命令，应答完毕后会一定时间内跟一条结算消费信息。
1. 是否跳过短路检测：0=不检测短路，1=不检测短路，2=正常检测短路（如果负载短路会报 “充电器异常” ，如果不是真的短路，那可能是误判了，请关闭此检测）。
1. 不判断用户拔出：（特殊需求，正常情况不需开启，传0 即可），0=正常判断拔出，1=不检测用户拔出。
1. 强制带充满自停：0=正常，1=强制带充满自停（如定时充电也会带充满自停）。示例（1、充电时长”设置4小时，强制带充满自停”设置为0，则充满不停，固定通电4小时。2、充电时长”设置4小时，强制带充满自停”设置为1，则充满停，时间到4小时也停。）
1. 充满功率：（特殊需求，正常情况不需开启，传0 即可），0=关闭充满功率判断，其它值=启用充满功率判断功能，（单位为1瓦，与其他功率0.1瓦有区别，特殊说明），如启用功此功能，浮充完成后，判断当前功率是否小于充满功率，如小于则停止充电，如大于则继续充电（继续充电时间不会大于“充满功率最长判断时间”）。非特殊情况不建议启用此功能。
1. 充满功率最长判断时间：（特殊需求，正常情况不需开启，传0 即可），即判断充满功率时，最长判断时长，注意单位是分钟，1表示60秒。

### <a name="_toc99440845"></a>**4.2.1、服务器修改充电时长/电量（8a指令）**
服务器发送：

|命令|费率模式|端口号|充电时长/电量|
| :-: | :-: | :-: | :-: |
|0x8A|1字节|1字节|2字节|

如：44 4E 59 0D 00 3B 37 AB 04 02 00 8A 00 01 80 70 96 03

设备应答：

|命令|应答|
| :-: | :-: |
|0x8A|1字节|

如：44 4E 59 0A 00 3B 37 AB 04 02 00 8A 00 A2 02

1. 原充电模式不管是何种充电模式，收到此命令后将立即转为定时/定量充电
1. 费率模式：=0定时无充满自停，=1定时带充满自停，=2计量带充满自停。
1. 充电时长/电量：根据费率模式中的数据判断是时长还是电量。如该值小于设备已经运行的数值，设备将立即断电，03结算指令中断电原因为03（达到预设时间）或04（达到预设电量）。另：费率模式=1时如已经过了设备判断充满自停的时间，则充满自停会失效。
1. 应答：0=成功，1=此端口未在充电，2=设置值小于现运行值，3=无此费率模式/无此端口号


### <a name="_toc99440846"></a>**4.3.1、设置运行参数1.1（83指令）**
服务器发送：

|命令|拔出功率|拔出功率识别时间|浮充百分比|浮充状态识别时间|浮充时间|心跳包上报间隔时间|
| :-: | :-: | :-: | :-: | :-: | :-: | :-: |
|0x83|2字节|2字节|1字节|2字节|2字节|2字节|
|默认|3|10|20|1800|3600|180|

设备应答：

|命令|应答|
| :-: | :-: |
|0x83|1字节|

1. 应答：0=成功，1=参数错误
1. 用于设置设备的运行参数，跟业务逻辑无关
1. 浮充百分比为1-100，如15代表”充电功率“的15%

### <a name="_toc99440847"></a>**4.3.2、设置运行参数1.2（84指令）**
服务器发送：

|命令|动态过载功率|动态过载识别时间|动态过载开始时间|拔出干扰功率|拔出干扰功率判断时间|
| :-: | :-: | :-: | :-: | :-: | :-: |
|0x84|2字节|2字节|2字节|1字节|2字节|
|默认|800|30|1800|10|300|

|浮充识别第二次时间点|浮充状态第二次识别时间|最小功率|判断最小功率时间点|第二最大功率时间点|
| :-: | :-: | :-: | :-: | :-: |
|2字节|2字节|2字节|2字节|2字节|
|10800|300|300|1800|300|

|环境报警温度|端口报警温度|打开/关闭判断用户拔出（光耦）|二维码灯|
| :-: | :-: | :-: | :-: |
|1字节|1字节|1字节|1字节|
|80|80|0（打开），其他关闭|1|

设备应答：

|命令|应答|
| :-: | :-: |
|0x84|1字节|

1. 应答：0=成功，1=参数错误
1. 用于设置设备的运行参数，跟业务逻辑无关
1. 动态过载应使用智能模糊判断，具体算法见另外文件说明，因为某些充电器功率会突然增大，导致误断电，在2021年6月份之后，已经关闭断电功能。
1. 拔出干扰功率及时间：在单位时间内功率小于拔出干扰功率，则认为用户已经拔出了充电器，断电。
1. 浮充识别第二次时间点：在此时长之前则用83指令中的浮充参数，之后则使用浮充第二次识别时间。如：开始充电10800秒之内，则需要1800秒判断是否进入浮充；充电10800秒之后，则需要300秒判断是否进入浮充。
1. “判断最小功率时间点”内，峰值功率一直小于“最小功率”，则断电
1. 第二最大功率时间点：设置记录第二最大功率的时长，会影响03指令中的“第二最大功率”
1. 环境报警温度/端口报警温度：达到此温度则直接断电，需要30秒的判断时间。从2021年6月份之后，因为误断电的原因，已经关闭断电功能。此温度设置值不需要换算。
1. 打开/关闭判断用户拔出（光耦）：此功能仅适用于带插入检测功能的10/16路设备，相当于AP350的14561456功能
1. 二维码灯：0＝打开，1＝关闭。此设置成功后将会一直保存，断电重启后依然有效。

### **4.4.1、设置最大充电时长、过载功率（85指令）**
服务器发送：

|命令|最大充电时间|过载功率|过压|欠压|
| :-: | :-: | :-: | :-: | :-: |
|0x85|2字节|2字节|2字节|2字节|
|默认|36000|x|2700|1000|

如：44 4E 59 0D 00 3B 37 AB 04 02 00 85 A0 8C 20 4E 3A 04

设备应答：

|命令|应答|
| :-: | :-: |
|0x85|1字节|

如：44 4E 59 0A 00 3B 37 AB 04 02 00 85 00 9D 02

1. 应答：0=成功，1=设置参数超过设备极限值。（双路、多路=2000W，大功率=3500W）
1. 最大充电时间：充满自停和离线启动时，均受其约束。如服务器下发充电时长，则不受其约束。
1. 过载功率：指单个端口的最大充电功率，（双路、多路不能大于2000W，大功率不能大于3500W），如果82开始充电指令里面下发了最大充电功率，则优先使用82指令里面的最大充电功率。此设置非整机功率，整机功率不能更改。
1. 过压：指电压过高的过压值，电压超过此值无法充电。单位0.1V，默认2700表示270V（2024-08-07新增）。
1. 欠压：指电压过低的欠压值，电压低于此值无法充电。单位0.1V，默认1000表示100V（2024-08-07新增）。
### <a name="_toc99440849"></a>**4.4.2、设置用户卡参数（86指令）**
服务器发送：

|命令|用户卡扇区|用户卡密码|新卡密码|
| :-: | :-: | :-: | :-: |
|0x86|1字节|6字节|6字节|
|默认|0|159185191880|FFFFFFFFFFFF|

如：44 4E 59 16 00 3B 37 AB 04 02 00 86 00 15 91 85 19 18 80 FF FF FF FF FF FF 80 0A

设备应答：

|命令|应答|
| :-: | :-: |
|0x86|1字节|

如：44 4E 59 0A 00 3B 37 AB 04 02 00 86 00 9E 02

1. 用户卡密码和新卡密码，均为16进制
1. 应答：0=成功，1=参数错误
### <a name="_toc99440850"></a>**4.4.3、复位重启设备（87指令）**
`		`服务器发送：

|命令|
| :-: |
|0x87|

如：44 4E 59 09 00 3B 37 AB 04 01 00 87 9D 02

设备应答：

|命令|应答|
| :-: | :-: |
|0x87|1字节|

如：44 4E 59 0A 00 3B 37 AB 04 01 00 87 00 9E 02

1. 此命令应用于服务器复位重启设备
1. 设备会尽力应答服务器，但服务器仍有可能收不到
1. 应答=0，收到复位命令
### <a name="_toc99440851"></a>**4.4.4、存储器清零（88指令）**
`		`服务器发送：

|命令|
| :-: |
|0x88|

如：44 4E 59 09 00 3B 37 AB 04 01 00 88 9E 02

设备应答：

|命令|应答|
| :-: | :-: |
|0x88|1字节|

如：44 4E 59 0A 00 3B 37 AB 04 01 00 88 00 9F 02

1. 此命令应用于设备把存储器清零——除了物理ID、虚拟ID、升级指令不用清零，其他的数据全部清零。
1. 应答=0，执行成功

### <a name="_toc99440852"></a>**4.4.5、播放语音（89指令）**
此命令为保留指令，暂时不可用

服务器发送：

|命令|是否打断|语音长度|语音组合|
| :-: | :-: | :-: | :-: |
|0x89|1字节|1字节|N字节|

设备应答：

|命令|应答|
| :-: | :-: |
|0x89|1字节|

1. 是否打断：0表示不打断正在播放的语音，1表示打断正在播放的语音，并马上播放本次语音。
1. 语音长度：即后面语音组合的段数。
1. 语音组合：即播放的语音组合。
1. 应答：0表示成功，1表示失败。
### <a name="_toc99440853"></a>**4.4.6、设置设备的工作模式（8D指令）**
`	`注：由此功能的机型才会支持

|命令|工作模式|
| :-: | :-: |
|0x8D|1字节|
|默认|0|

如：44 4E 59 0A 00 3B 37 AB 04 01 00 8D 00 A4 02

设备应答：

|命令|应答|
| :-: | :-: |
|0x8D|1字节|

如：44 4E 59 0A 00 3B 37 AB 04 01 00 8D 00 A4 02

1. 工作模式：00=联网，01=刷卡
1. 应答：0=执行成功，1=设备不支持切换，其他=失败


### <a name="_toc99440854"></a>**4.8.1、设备固件升级（E0升级分机指令）（E1升级电源板指令）（E2主机统一升级）（参考01指令中的设备类型表）**
服务器发送：

|命令|总包数|当前包|固件|
| :-: | :-: | :-: | :-: |
|0xE0|2字节|2字节|200字节|

设备应答：

|命令|应答|当前包|
| :-: | :-: | :-: |
|0xE0|1字节|2字节|

1. 服务器直接发送第1包启动升级。
1. 总包数，如一个固件为640字节，则总包数为 640/ 200 = 3.2 = 4
1. 当前包，从1开始，为第一包，当前包等于总包数时，固件发送完毕
1. 应答：0x00=成功，可以发送下一包； 0x01=包错误（请重发设备请求的包），0x02=固件包累加和校验出错，0x03=设备类型错误，0x04=当前升级没有校验包，0x05=第0包认证设备类型不正确，升级失败，不允许升级。
1. 当前包：当前成功收到的数据包

服务器注意事项：鉴于我们的经验，服务器应做重发机制，如30秒未收到设备的应答，应重发当前包，可做3次重发。

为了校验升级包数据是否有出错，可在固件包后面额外增加一包做为校验包，内容如下：

|头字节|固件包的和校验|设备类型|固件版本号|
| :-: | :-: | :-: | :-: |
|8字节|4字节|1字节|2字节|

1. 校验包固定为200字节，未使用到的地方填充0，当增加了校验包时，总包数也需+1。
1. 头字节：固定8字节，内容固定为0xa1,0xa2,0xa3,0xa4,0xa5,0xa6,0xa7,0xa8。
1. 固件包和校验：即固件包的字节累加和，小端模式存放。
1. 设备类型：见01指令中的设备类型表。
1. 固件版本号：小端模式存放。


### <a name="_toc531641181"></a><a name="_toc99440855"></a>**4.8.2、设备固件升级（F8指令）**
这是老版本设备使用的升级指令

服务器发送：

|命令|总包数|当前包|固件|
| :-: | :-: | :-: | :-: |
|0xF8|2字节|2字节|256字节|

设备应答：

|命令|应答|当前包|
| :-: | :-: | :-: |
|0xF8|1字节|2字节|

1. 总包数，如一个固件为640字节，则总包数为 640/ 256 = 2.5 = 3
1. 当前包，从1开始，为第一包，当前包等于总包数时，固件发送完毕
1. 应答=0成功，可以发送下一包； =1错误，重新发送当前包
1. 当前包：当前成功收到的数据包
1. 如果2次重传，依然不成功，则需重新升级
1. 当设备发05指令时，需要从第一包开始重发


### <a name="_toc4020771"></a><a name="_toc99440856"></a>**4.9.1、服务器查询当前设备参数（90、91、92、93、94指令）**
`		`服务器发送：

|命令|
| :-: |
|0x90|

设备应答：

|命令|运行参数1.1中的内容|
| :-: | :-: |
|0x90|查询83指令内容|

服务器发送：

|命令|
| :-: |
|0x91|

设备应答：

|命令|运行参数1.2中的内容|
| :-: | :-: |
|0x91|查询84指令内容|

服务器发送：

|命令|
| :-: |
|0x92|

设备应答：

|命令|运行参数2中的内容|
| :-: | :-: |
|0x92|查询85指令内容|

服务器发送： 

|命令|
| :-: |
|0x93|

设备应答：

|命令|用户卡参数中的内容|
| :-: | :-: |
|0x93|查询86指令内容|

服务器发送： 

|~~命令~~|
| :-: |
|~~0x94~~|

设备应答：

|~~命令~~|~~免费充电参数中的内容~~|
| :-: | :-: |
|~~0x94~~|~~已删除指令~~|

### <a name="_toc99440857"></a>**4.9.2、服务器读取EEPROM的数据（8B指令）**
服务器发送：

|命令|EEPROM地址|数据长度|
| :-: | :-: | :-: |
|0x8B|2字节|1字节|
|默认|0|0|

设备应答：

|命令|是否成功|EEPROM数据|
| :-: | :-: | :-: |
|0x8B|1字节|xxxx|

1. 数据长度最大为32
1. 是否成功：0=成功，其他=失败

### <a name="_toc99440858"></a>**4.9.3、服务器写入EEPROM的数据（8C指令）**
服务器发送：

|命令|EEPROM地址|数据长度|EEPROM数据|
| :-: | :-: | :-: | :-: |
|0x8C|2字节|1字节|x字节|
|默认|X|X|X|

设备应答：

|命令|是否成功|
| :-: | :-: |
|0x8C|1字节|

1. 数据长度最大为32，需要和EEPROM数据内容对应
1. 是否成功：0=成功，其他=失败

### <a name="_toc99440859"></a>**4.9.4、服务器修改二维码地址（8E指令）（最新固件才支持）**
服务器发送：

|命令|主界面类型|保留|二维码数据|
| :-: | :-: | :-: | :-: |
|0x8E|1字节|3字节|72字节|
|默认|0|0|http://ap3200.haokuaichong.cn/ap3200|

设备应答：

|命令|是否成功|
| :-: | :-: |
|0x8E|1字节|

1. 主界面类型：0＝主界面为端口状态显示，1＝主界面为二维码显示。
1. 保留：暂时没有用到的字节。
1. 二维码数据：固定为72字节的buff，实际二维码数据最大为71个字符，最后一个字节必需为0x00，如二维码数据不足71字节必需使用0x00填充（后补0），如设置http://baidu.com则为68 74 74 70 3A 2F 2F 62 61 69 64 75 2E 63 6F 6D 00 00 00 00 00 00 00 00实际00有56个，此处省略不写出来，必需按此规定填写数据，否则设备可能会出现无法使用现象。
1. 是否成功：0=成功，其他=失败

### <a name="_toc99440860"></a>**4.9.5、设置设备TC刷卡模式（8F指令）**
`	`注：有此功能的机型才会支持

|命令|工作模式|
| :-: | :-: |
|0x8F|1字节|
|默认|0|

设备应答：

|命令|应答|
| :-: | :-: |
|0x8F|1字节|

1. 工作模式：00=计时，01=计次，03=计量，04=固定扣费（一元模式），05=家用模式，06=选择免费模式（带按键的设备才有此模式）
1. 应答：0=执行成功，其他=失败


### <a name="_toc99440861"></a>**4.9.6、充电柜停止充电，但不开柜门（72指令）**
`	`注：仅充电柜才支持

服务器下发：

|命令|端口号|订单编号|
| :-: | :-: | :-: |
|0x72|1字节|16字节|
|默认|0||
设备应答：

|命令|应答|订单编号|
| :-: | :-: | :-: |
|0x72|1字节|16字节|

1. 端口号：如0-15则代表第1路-第16路。
1. 订单编号：当前端口在充的订单编号，只有对的上才会生效。
1. 应答：0=执行成功，其他=失败

### <a name="_toc99440862"></a>**4.9.7、临时二维码（95指令）（带屏设备才有）**
服务器下发：

|命令|二维码内容|
| :-: | :-: |
|0x95|200字节|

设备应答：

|命令|应答|
| :-: | :-: |
|0x95|1字节|

1. 二维码内容：生成二维码的内容，ANSI内码，不足200字符的使用0x00填充。
1. 应答：0=执行成功，其他=失败

### **4.9.8、声光寻找设备功能（96指令）**
服务器下发：

|命令|定位时间|
| :-: | :-: |
|0x96|1字节|

设备应答：

|命令|应答|
| :-: | :-: |
|0x96|1字节|

1. 定位设备功能是为了方便找到设备，设备收到后会播放语音并闪灯。
1. 定位时间：设备执行此功能的时间，单位秒。


### **4.9.9、设置运行参数1.3（97指令）（20230508增加，后续可能增加字段）**
服务器发送：

|命令|静音模式|
| :-: | :-: |
|0x97|1字节|
|默认|0|

设备应答：

|命令|应答|
| :-: | :-: |
|0x97|1字节|

1. 应答：0=执行成功，其他=失败
1. 静音模式：0=不启用静音（即正常有声音），1=启用静音模式。




### **4.9.a、多功能指令（98指令）（20230724增加，后续可能增加字段）**
服务器发送：

|命令|功能|端口号|
| :-: | :-: | :-: |
|0x98|1字节|1字节|
|默认|0||
设备应答：

|命令|应答|
| :-: | :-: |
|0x98|1字节|

1. 应答：0=执行成功，其他=失败，如果功能不同，后面可能还会带参数。
1. 功能：用于指示此指令作什么功能用，0=用于充电柜强制开柜。
1. 端口号：当前功能所使用的端口号，从0x00开始。

### **4.9.b、特殊设备触发升级（E4指令）**
`		`服务器发送：

|命令|
| :-: |
|0xE4|

如：44 4E 59 09 00 3B 37 AB 04 01 00 E4 FA 02

注1、用于无需服务器下发升级包内容、设备自动升级的设备。适用型号有AP632，图片见下方。

注2、服务器只需下发一次即可，设备收到后会自动下载固件更新。

![descript](Aspose.Words.af2c20ff-308a-42e0-ae12-9a84bb765cad.001.png)


### **x.x.1、保留占位指令（FD指令）**
服务器发送：

|命令|<p>功能</p><p>（1字节）</p>|R1|R2|R3|R4|
| :-: | :-: | :-: | :-: | :-: | :-: |
|0xFD|\*\*0x01|4字节|4字节|4字节|4字节|
||\*\*0x02|4字节|4字节|4字节|4字节|
|||||||


设备应答：

|命令|功能|应答|
| :-: | :-: | :-: |
|0xFD|（1字节）|1字节|

### **x.x.1、保留占位指令（FE指令）**
服务器发送：

|命令|R1|R2|R3|
| :-: | :-: | :-: | :-: |
|0xFE|4字节|4字节|4字节|
|默认|0|0|0|

8

