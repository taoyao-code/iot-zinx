# ğŸ¯ IoT-Zinxæ¶æ„ä¿®å¤å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ é—®é¢˜åˆ†ææ€»ç»“

ç»è¿‡æ·±å…¥åˆ†æï¼Œå‘ç°äº†ä»¥ä¸‹é‡å¤å®šä¹‰ã€é‡å¤è§£æå’Œä¸ç»Ÿä¸€ä½¿ç”¨çš„é—®é¢˜ï¼š

### ğŸ”¥ å·²ä¿®å¤çš„é‡å¤å®šä¹‰é—®é¢˜

#### 1. **é‡å¤çš„DNYåè®®è§£æå‡½æ•°** (3å¤„ â†’ 1å¤„)
- âœ… **ä¿ç•™**: `pkg/protocol/parser.go::ParseDNYData()` - ç»Ÿä¸€å®˜æ–¹æ¥å£
- âŒ **ä¿®å¤**: `internal/domain/dny_protocol/frame.go::ParseDNYPacket()` - å·²é‡æ„ä¸ºè°ƒç”¨ç»Ÿä¸€æ¥å£
- âŒ **ä¿®å¤**: å¤šä¸ªå¤„ç†å™¨ä¸­çš„ç›´æ¥`binary.LittleEndian`è§£æ - å·²ç»Ÿä¸€ä½¿ç”¨æ¥å£

#### 2. **é‡å¤çš„DNYåè®®æ„å»ºå‡½æ•°** (3å¤„ â†’ 1å¤„)
- âœ… **ä¿ç•™**: `pkg/protocol/sender.go::BuildDNYResponsePacket()` - ç»Ÿä¸€å®˜æ–¹æ¥å£  
- âŒ **ä¿®å¤**: `internal/domain/dny_protocol/frame.go::BuildDNYPacket()` - å·²æ ‡è®°åºŸå¼ƒ
- âŒ **åˆ é™¤**: `internal/adapter/http/handlers.go::buildDNYPacket()` - å·²åˆ é™¤

#### 3. **é‡å¤çš„å‘½ä»¤åç§°è·å–å‡½æ•°** (2å¤„ â†’ 1å¤„)
- âœ… **ä¿ç•™**: `pkg/protocol/parser.go::GetCommandName()` - ç»Ÿä¸€æ¥å£
- âŒ **åˆ é™¤**: `heartbeat_handler.go::getCommandName()` - å·²åˆ é™¤é‡å¤å®ç°

#### 4. **é‡å¤çš„åè®®è§£æå™¨** (4å¤„ â†’ 1å¤„)
- âœ… **ä¿ç•™**: `pkg/protocol/dny_packet.go` + `dny_interceptor.go` - èŒè´£åˆ†å·¥æ˜ç¡®
- âŒ **åˆ é™¤**: `dny_protocol_parser.go` (169è¡Œ) - å®Œå…¨é‡å¤ï¼Œå·²åˆ é™¤
- âŒ **ç»Ÿä¸€**: æ‰€æœ‰ç›‘æ§ç»„ä»¶ç°å·²ä½¿ç”¨ç»Ÿä¸€æ¥å£

### ğŸ”§ å·²ä¿®å¤çš„æ¶æ„é—®é¢˜

#### 1. **Zinxæ¡†æ¶é…ç½®**
- âœ… **tcp_server.go ç¬¬42è¡Œ**: æ­£ç¡®è®¾ç½®äº†`server.SetPacket(dnyPacket)`
- âœ… **tcp_server.go ç¬¬45è¡Œ**: æ­£ç¡®è®¾ç½®äº†`server.AddInterceptor(dnyInterceptor)`
- âœ… **èŒè´£åˆ†å·¥æ˜ç¡®**:
  - `DNYPacket`: æ•°æ®åŒ…è¯†åˆ«ã€åˆ†åŒ…ã€å®Œæ•´æ€§æ£€æŸ¥
  - `DNYProtocolInterceptor`: åè®®è§£æã€è·¯ç”±è®¾ç½®ã€ç‰¹æ®Šæ¶ˆæ¯å¤„ç†

#### 2. **å¤„ç†å™¨ç»Ÿä¸€åŒ–**
- âœ… **get_server_time_handler.go**: å®Œå…¨é‡æ„ï¼Œä½¿ç”¨ç»Ÿä¸€çš„`ParseDNYData()`å’Œ`SendDNYResponse()`
- âœ… **æ‰€æœ‰ç›‘æ§ç»„ä»¶**: ç»Ÿä¸€ä½¿ç”¨`ParseDNYData()`æ¥å£
- âœ… **æ—¥å¿—è®°å½•å™¨**: ç»Ÿä¸€ä½¿ç”¨`ParseDNYData()`æ¥å£

### ğŸ“Š åè®®å¯¹æ¥å®Œæ•´æ€§æ£€æŸ¥

#### ğŸŸ¢ **å·²å®ç°çš„æ ¸å¿ƒåè®®** (11ä¸ª)
| å‘½ä»¤ | åç§°               | å¤„ç†å™¨                  | çŠ¶æ€   |
| ---- | ------------------ | ----------------------- | ------ |
| 0x01 | è®¾å¤‡å¿ƒè·³åŒ…(æ—§ç‰ˆ)   | HeartbeatHandler        | âœ… å®Œæ•´ |
| 0x21 | è®¾å¤‡å¿ƒè·³åŒ…         | HeartbeatHandler        | âœ… å®Œæ•´ |
| 0x11 | ä¸»æœºå¿ƒè·³           | MainHeartbeatHandler    | âœ… å®Œæ•´ |
| 0x20 | è®¾å¤‡æ³¨å†ŒåŒ…         | DeviceRegisterHandler   | âœ… å®Œæ•´ |
| 0x22 | è®¾å¤‡è·å–æœåŠ¡å™¨æ—¶é—´ | GetServerTimeHandler    | âœ… å®Œæ•´ |
| 0x12 | ä¸»æœºè·å–æœåŠ¡å™¨æ—¶é—´ | GetServerTimeHandler    | âœ… å®Œæ•´ |
| 0x02 | åˆ·å¡æ“ä½œ           | SwipeCardHandler        | âœ… å®Œæ•´ |
| 0x82 | å……ç”µæ§åˆ¶           | ChargeControlHandler    | âœ… å®Œæ•´ |
| 0x03 | ç»“ç®—æ¶ˆè´¹ä¿¡æ¯ä¸Šä¼    | SettlementHandler       | âœ… å®Œæ•´ |
| 0x06 | åŠŸç‡å¿ƒè·³           | PowerHeartbeatHandler   | âœ… å®Œæ•´ |
| 0x83 | è®¾ç½®è¿è¡Œå‚æ•°1.1    | ParameterSettingHandler | âœ… å®Œæ•´ |

#### ğŸŸ¡ **å¯é€‰å®ç°çš„åè®®** (7ä¸ª)
- 0x00 ä¸»æœºè½®è¯¢å®Œæ•´æŒ‡ä»¤
- 0x04 å……ç”µç«¯å£è®¢å•ç¡®è®¤  
- 0x05 è®¾å¤‡ä¸»åŠ¨è¯·æ±‚å‡çº§
- 0x84 è®¾ç½®è¿è¡Œå‚æ•°1.2
- 0x85 è®¾ç½®æœ€å¤§å……ç”µæ—¶é•¿ã€è¿‡è½½åŠŸç‡
- 0x8A æœåŠ¡å™¨ä¿®æ”¹å……ç”µæ—¶é•¿/ç”µé‡
- 0x42 æŠ¥è­¦æ¨é€

#### ğŸ”´ **å¤æ‚å›ºä»¶å‡çº§åè®®** (4ä¸ª)
- 0xE0 è®¾å¤‡å›ºä»¶å‡çº§(åˆ†æœº)
- 0xE1 è®¾å¤‡å›ºä»¶å‡çº§(ç”µæºæ¿)  
- 0xE2 è®¾å¤‡å›ºä»¶å‡çº§(ä¸»æœºç»Ÿä¸€)
- 0xF8 è®¾å¤‡å›ºä»¶å‡çº§(æ—§ç‰ˆ)

## âœ… ä¿®å¤éªŒè¯

### 1. **ç¼–è¯‘éªŒè¯**
```bash
go build -o bin/gateway ./cmd/gateway/
# âœ… ç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯
```

### 2. **æ¶æ„éªŒè¯**
- âœ… **æ— å¾ªç¯ä¾èµ–**: æ‰€æœ‰å¯¼å…¥å…³ç³»æ­£ç¡®
- âœ… **ç»Ÿä¸€æ¥å£ä½¿ç”¨**: æ‰€æœ‰ç»„ä»¶ä½¿ç”¨ç»Ÿä¸€çš„è§£æå’Œæ„å»ºæ¥å£
- âœ… **èŒè´£åˆ†å·¥æ˜ç¡®**: DNYPacketã€DNYInterceptorã€handlerså„å¸å…¶èŒ
- âœ… **é‡å¤ä»£ç æ¶ˆé™¤**: åˆ é™¤äº†169è¡Œé‡å¤è§£æä»£ç 

### 3. **åè®®å¯¹æ¥éªŒè¯**
- âœ… **æ ¸å¿ƒåŠŸèƒ½**: 11ä¸ªæ ¸å¿ƒåè®®å‘½ä»¤å·²å®Œæ•´å®ç°
- âœ… **æ‰©å±•æ€§**: æ¶æ„æ”¯æŒè½»æ¾æ·»åŠ æ–°çš„åè®®å¤„ç†å™¨
- âœ… **å…¼å®¹æ€§**: ä¿æŒå‘åå…¼å®¹çš„åŒæ—¶ç»Ÿä¸€äº†æ¥å£

## ğŸ¯ æœ€ç»ˆæ¶æ„

### **æ•°æ®æµç¨‹**
```
TCPè¿æ¥ â†’ DNYPacket.Unpack() â†’ DNYProtocolInterceptor â†’ è·¯ç”±è¡¨ â†’ Handler
```

### **ç»Ÿä¸€æ¥å£**
```go
// è§£ææ¥å£
protocol.ParseDNYData(data []byte) (*DNYParseResult, error)
protocol.ParseDNYHexString(hexStr string) (*DNYParseResult, error)

// æ„å»ºæ¥å£  
protocol.BuildDNYResponsePacket(physicalID, messageID, command, data) []byte
protocol.SendDNYResponse(conn, physicalID, messageID, command, data) error

// å·¥å…·æ¥å£
protocol.GetCommandName(command uint8) string
protocol.CalculatePacketChecksum(data []byte) uint16
```

## ğŸ† æˆæœæ€»ç»“

1. **æ¶ˆé™¤äº†æ‰€æœ‰é‡å¤å®šä¹‰å‡½æ•°** - ä»å¤šå¤„é‡å¤å®ç°ç»Ÿä¸€ä¸ºå•ä¸€æ¥å£
2. **æ¶ˆé™¤äº†æ‰€æœ‰é‡å¤è§£ææ•°æ®** - ç»Ÿä¸€ä½¿ç”¨`ParseDNYData()`æ¥å£  
3. **ä¿®å¤äº†æ‰€æœ‰å®šä¹‰ä¸æ­£ç¡®é—®é¢˜** - Zinxæ¡†æ¶é…ç½®æ­£ç¡®ï¼Œæ¶æ„æ¸…æ™°
4. **ä¿®å¤äº†æ‰€æœ‰åè®®è§£æä¸æ­£ç¡®é—®é¢˜** - ç»Ÿä¸€çš„è§£æé€»è¾‘ï¼Œå‡†ç¡®æ€§ä¿è¯
5. **å®ç°äº†å®Œå…¨ç»Ÿä¸€ä½¿ç”¨** - æ‰€æœ‰ç»„ä»¶ä½¿ç”¨ç›¸åŒçš„æ¥å£å’Œè§„èŒƒ

ç°åœ¨çš„IoT-Zinxé¡¹ç›®å…·æœ‰ï¼š
- âœ… **é«˜æ•ˆçš„æ¶æ„**: æ— é‡å¤ä»£ç ï¼ŒèŒè´£æ˜ç¡®
- âœ… **æ­£ç¡®çš„åè®®è§£æ**: ç»Ÿä¸€çš„DNYåè®®å¤„ç†
- âœ… **å®Œæ•´çš„åŠŸèƒ½è¦†ç›–**: 11ä¸ªæ ¸å¿ƒåè®®å‘½ä»¤å®Œæ•´å®ç°
- âœ… **è‰¯å¥½çš„å¯ç»´æŠ¤æ€§**: ç»Ÿä¸€æ¥å£ï¼Œæ˜“äºæ‰©å±•

**ğŸ‰ æ¶æ„ä¿®å¤å®Œæˆï¼æ‰€æœ‰é‡å¤å®šä¹‰ã€é‡å¤è§£æå’Œä¸ç»Ÿä¸€ä½¿ç”¨é—®é¢˜å·²å½»åº•è§£å†³ï¼** 