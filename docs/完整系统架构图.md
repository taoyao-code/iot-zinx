# IoT-Zinx å®Œæ•´ç³»ç»Ÿæ¶æ„å›¾

## ğŸ—ï¸ ç³»ç»Ÿæ•´ä½“æ¶æ„

```mermaid
graph TB
    subgraph "åº”ç”¨å±‚ (Application Layer)"
        REST[REST API Gateway<br/>è®¾å¤‡ç®¡ç†/å……ç”µæ§åˆ¶]
        HTTP[HTTP Server<br/>ä¸šåŠ¡æ¥å£æœåŠ¡]
        WS[WebSocket API<br/>å®æ—¶æ•°æ®æ¨é€]
    end

    subgraph "ä¸šåŠ¡å±‚ (Business Layer)"
        DS[è®¾å¤‡æœåŠ¡<br/>DeviceService]
        CS[å……ç”µæœåŠ¡<br/>ChargingService]
        NS[é€šçŸ¥æœåŠ¡<br/>NotificationService]
        MS[ç›‘æ§æœåŠ¡<br/>MonitorService]
    end

    subgraph "æ•°æ®æ€»çº¿å±‚ (DataBus Layer)"
        DATABUS[æ•°æ®æ€»çº¿æ ¸å¿ƒ<br/>DataBus Core]

        DDM[è®¾å¤‡æ•°æ®ç®¡ç†å™¨<br/>DeviceDataManager]
        DSM[è®¾å¤‡çŠ¶æ€ç®¡ç†å™¨<br/>DeviceStateManager]
        PDM[ç«¯å£æ•°æ®ç®¡ç†å™¨<br/>PortDataManager]
        ODM[è®¢å•æ•°æ®ç®¡ç†å™¨<br/>OrderDataManager]
        PRDM[åè®®æ•°æ®ç®¡ç†å™¨<br/>ProtocolDataManager]
    end

    subgraph "åè®®å±‚ (Protocol Layer)"
        TCP[TCPæœåŠ¡å™¨<br/>Zinx Framework]
        DNY[DNYåè®®è§£æå™¨<br/>Protocol Parser]
        ROUTER[æ¶ˆæ¯è·¯ç”±å™¨<br/>Message Router]
        CONN[è¿æ¥ç®¡ç†å™¨<br/>Connection Manager]
    end

    subgraph "å¤„ç†å™¨å±‚ (Handler Layer)"
        DRH[è®¾å¤‡æ³¨å†Œå¤„ç†å™¨<br/>DeviceRegisterHandler]
        HBH[å¿ƒè·³å¤„ç†å™¨<br/>HeartbeatHandler]
        CCH[å……ç”µæ§åˆ¶å¤„ç†å™¨<br/>ChargingHandler]
        PWH[åŠŸç‡å¿ƒè·³å¤„ç†å™¨<br/>PowerHeartbeatHandler]
    end

    subgraph "å­˜å‚¨å±‚ (Storage Layer)"
        L1[L1:å†…å­˜ç¼“å­˜<br/>GlobalDeviceStore]
        L2[L2:Redisç¼“å­˜<br/>çƒ­æ•°æ®å­˜å‚¨]
        L3[L3:æ•°æ®åº“<br/>MySQLæŒä¹…åŒ–]
        L4[L4:æ–‡ä»¶å­˜å‚¨<br/>æ—¥å¿—å½’æ¡£]
    end

    subgraph "é€šçŸ¥å±‚ (Notification Layer)"
        NI[é€šçŸ¥é›†æˆå™¨<br/>NotificationIntegrator]
        WH[Webhooké€šçŸ¥å™¨<br/>WebhookNotifier]
        QUEUE[äº‹ä»¶é˜Ÿåˆ—<br/>Event Queue]
    end

    subgraph "å¤–éƒ¨ç³»ç»Ÿ (External Systems)"
        DEVICES[å……ç”µæ¡©è®¾å¤‡<br/>Charging Stations]
        THIRD[ç¬¬ä¸‰æ–¹ç³»ç»Ÿ<br/>Billing/Management]
        MONITOR[ç›‘æ§ç³»ç»Ÿ<br/>Monitoring]
    end

    %% åº”ç”¨å±‚åˆ°ä¸šåŠ¡å±‚
    REST --> DS
    REST --> CS
    HTTP --> DS
    HTTP --> CS
    WS --> NS

    %% ä¸šåŠ¡å±‚åˆ°æ•°æ®æ€»çº¿å±‚
    DS --> DATABUS
    CS --> DATABUS
    NS --> DATABUS
    MS --> DATABUS

    %% æ•°æ®æ€»çº¿å†…éƒ¨è¿æ¥
    DATABUS <--> DDM
    DATABUS <--> DSM
    DATABUS <--> PDM
    DATABUS <--> ODM
    DATABUS <--> PRDM

    %% åè®®å±‚è¿æ¥
    TCP <--> DEVICES
    TCP --> DNY
    DNY --> ROUTER
    ROUTER --> DRH
    ROUTER --> HBH
    ROUTER --> CCH
    ROUTER --> PWH

    %% å¤„ç†å™¨åˆ°æ•°æ®æ€»çº¿
    DRH --> DATABUS
    HBH --> DATABUS
    CCH --> DATABUS
    PWH --> DATABUS

    %% æ•°æ®æ€»çº¿åˆ°å­˜å‚¨å±‚
    DDM --> L1
    DSM --> L1
    PDM --> L1
    ODM --> L2
    PRDM --> L2
    L1 --> L2
    L2 --> L3
    L3 --> L4

    %% é€šçŸ¥ç³»ç»Ÿè¿æ¥
    DATABUS --> NI
    NI --> WH
    NI --> QUEUE
    WH --> THIRD
    QUEUE --> MONITOR

    %% è¿æ¥ç®¡ç†
    TCP --> CONN
    CONN --> DATABUS

    style DATABUS fill:#e1f5fe
    style TCP fill:#f3e5f5
    style L1 fill:#e8f5e8
    style NI fill:#fff3e0
```

## ğŸ”„ æ ¸å¿ƒæ•°æ®æµç¨‹å›¾

### 1. è®¾å¤‡æ³¨å†Œå®Œæ•´æµç¨‹

```mermaid
sequenceDiagram
    participant Device as å……ç”µæ¡©è®¾å¤‡
    participant TCP as TCPæœåŠ¡å™¨
    participant DNY as DNYåè®®è§£æå™¨
    participant Handler as è®¾å¤‡æ³¨å†Œå¤„ç†å™¨
    participant DataBus as æ•°æ®æ€»çº¿
    participant Storage as å­˜å‚¨å±‚
    participant Notification as é€šçŸ¥ç³»ç»Ÿ
    participant Third as ç¬¬ä¸‰æ–¹ç³»ç»Ÿ

    Device->>TCP: å‘é€æ³¨å†Œè¯·æ±‚
    TCP->>DNY: åè®®è§£æ
    DNY->>Handler: è·¯ç”±åˆ°æ³¨å†Œå¤„ç†å™¨
    Handler->>DataBus: å‘å¸ƒè®¾å¤‡æ•°æ®
    DataBus->>Storage: å­˜å‚¨è®¾å¤‡ä¿¡æ¯
    DataBus->>Notification: è§¦å‘æ³¨å†Œäº‹ä»¶
    Notification->>Third: å‘é€æ³¨å†Œé€šçŸ¥
    Handler->>TCP: è¿”å›æ³¨å†Œå“åº”
    TCP->>Device: å‘é€æ³¨å†ŒæˆåŠŸ
```

### 2. å……ç”µæ§åˆ¶å®Œæ•´æµç¨‹

```mermaid
sequenceDiagram
    participant API as REST API
    participant Service as å……ç”µæœåŠ¡
    participant DataBus as æ•°æ®æ€»çº¿
    participant TCP as TCPæœåŠ¡å™¨
    participant Device as å……ç”µæ¡©è®¾å¤‡
    participant Storage as å­˜å‚¨å±‚
    participant Notification as é€šçŸ¥ç³»ç»Ÿ

    API->>Service: å……ç”µæ§åˆ¶è¯·æ±‚
    Service->>DataBus: æŸ¥è¯¢è®¾å¤‡çŠ¶æ€
    DataBus->>Storage: è·å–è®¾å¤‡ä¿¡æ¯
    Storage-->>DataBus: è¿”å›è®¾å¤‡ä¿¡æ¯
    DataBus-->>Service: è¿”å›è®¾å¤‡çŠ¶æ€
    Service->>TCP: å‘é€å……ç”µå‘½ä»¤
    TCP->>Device: ä¸‹å‘å……ç”µæŒ‡ä»¤
    Device->>TCP: è¿”å›æ‰§è¡Œç»“æœ
    TCP->>DataBus: æ›´æ–°å……ç”µçŠ¶æ€
    DataBus->>Storage: å­˜å‚¨çŠ¶æ€å˜æ›´
    DataBus->>Notification: è§¦å‘å……ç”µäº‹ä»¶
    Notification->>API: å¼‚æ­¥é€šçŸ¥ç»“æœ
```

### 3. åŠŸç‡å¿ƒè·³æ•°æ®æµç¨‹

```mermaid
sequenceDiagram
    participant Device as å……ç”µæ¡©è®¾å¤‡
    participant TCP as TCPæœåŠ¡å™¨
    participant Handler as åŠŸç‡å¿ƒè·³å¤„ç†å™¨
    participant DataBus as æ•°æ®æ€»çº¿
    participant Storage as å­˜å‚¨å±‚
    participant Notification as é€šçŸ¥ç³»ç»Ÿ
    participant Monitor as ç›‘æ§ç³»ç»Ÿ

    Device->>TCP: å‘é€åŠŸç‡å¿ƒè·³
    TCP->>Handler: è·¯ç”±åˆ°åŠŸç‡å¤„ç†å™¨
    Handler->>Handler: è§£æåŠŸç‡æ•°æ®
    Handler->>DataBus: å‘å¸ƒç«¯å£æ•°æ®
    DataBus->>Storage: å­˜å‚¨å®æ—¶æ•°æ®
    DataBus->>Notification: è§¦å‘åŠŸç‡äº‹ä»¶
    Notification->>Monitor: æ¨é€å®æ—¶æ•°æ®
    Handler->>TCP: å‘é€å¿ƒè·³å“åº”
    TCP->>Device: ç¡®è®¤æ¥æ”¶
```

## ğŸš€ ç®€åŒ–æ¶æ„å®ç°

### å½“å‰çœŸå®æ¶æ„ï¼ˆåŸºäºå‘ç°çš„ç®€åŒ–æ¨¡å¼ï¼‰

```mermaid
graph TB
    subgraph "ç®€åŒ–æ¶æ„ (Simplified Architecture)"
        API[HTTP API<br/>internal/apis/]

        TCP_SERVER[TCPæœåŠ¡å™¨<br/>internal/ports/tcp_server.go]

        HANDLERS[ç›´æ¥å¤„ç†å™¨<br/>internal/handlers/]
        DR[è®¾å¤‡æ³¨å†Œ<br/>device_register.go]
        HB[å¿ƒè·³å¤„ç†<br/>heartbeat.go]
        CH[å……ç”µæ§åˆ¶<br/>charging.go]

        STORAGE[å…¨å±€å­˜å‚¨<br/>pkg/storage/global_store.go]

        NOTIFICATION[é€šçŸ¥ç³»ç»Ÿ<br/>pkg/notification/]
    end

    subgraph "è®¾å¤‡è¿æ¥"
        DEVICES[å……ç”µæ¡©è®¾å¤‡]
    end

    subgraph "å¤–éƒ¨ç³»ç»Ÿ"
        THIRD_PARTY[ç¬¬ä¸‰æ–¹ç³»ç»Ÿ]
    end

    %% ä¸»è¦æ•°æ®æµ
    DEVICES <--> TCP_SERVER
    TCP_SERVER --> DR
    TCP_SERVER --> HB
    TCP_SERVER --> CH

    DR --> STORAGE
    HB --> STORAGE
    CH --> STORAGE

    STORAGE --> NOTIFICATION
    NOTIFICATION --> THIRD_PARTY

    API --> STORAGE
    API --> TCP_SERVER

    style TCP_SERVER fill:#e3f2fd
    style STORAGE fill:#e8f5e8
    style NOTIFICATION fill:#fff3e0
```

## ğŸ“Š æ•°æ®é“¾è·¯å›¾

### 1. è®¾å¤‡æ•°æ®é“¾è·¯

```mermaid
flowchart LR
    subgraph "æ•°æ®é‡‡é›†"
        D1[è®¾å¤‡æ³¨å†Œæ•°æ®]
        D2[å¿ƒè·³æ•°æ®]
        D3[åŠŸç‡æ•°æ®]
        D4[çŠ¶æ€æ•°æ®]
    end

    subgraph "åè®®å¤„ç†"
        P1[DNYåè®®è§£æ]
        P2[æ¶ˆæ¯éªŒè¯]
        P3[æ•°æ®æå–]
    end

    subgraph "ä¸šåŠ¡å¤„ç†"
        B1[è®¾å¤‡ç®¡ç†]
        B2[çŠ¶æ€ç®¡ç†]
        B3[å……ç”µç®¡ç†]
        B4[è¿æ¥ç®¡ç†]
    end

    subgraph "å­˜å‚¨å±‚"
        S1[å†…å­˜å­˜å‚¨]
        S2[çŠ¶æ€å†å²]
        S3[è®¾å¤‡ä¿¡æ¯]
    end

    subgraph "é€šçŸ¥å±‚"
        N1[çŠ¶æ€é€šçŸ¥]
        N2[äº‹ä»¶é€šçŸ¥]
        N3[Webhookæ¨é€]
    end

    D1 --> P1
    D2 --> P1
    D3 --> P1
    D4 --> P1

    P1 --> P2
    P2 --> P3

    P3 --> B1
    P3 --> B2
    P3 --> B3
    P3 --> B4

    B1 --> S1
    B2 --> S2
    B3 --> S3
    B4 --> S1

    S1 --> N1
    S2 --> N2
    S3 --> N3
```

### 2. é€šçŸ¥æ•°æ®é“¾è·¯

```mermaid
flowchart TB
    subgraph "äº‹ä»¶æº"
        E1[è®¾å¤‡çŠ¶æ€å˜æ›´]
        E2[å……ç”µçŠ¶æ€å˜æ›´]
        E3[è¿æ¥çŠ¶æ€å˜æ›´]
        E4[é”™è¯¯äº‹ä»¶]
    end

    subgraph "å›è°ƒæœºåˆ¶"
        C1[çŠ¶æ€å›è°ƒ]
        C2[äº‹ä»¶å›è°ƒ]
        C3[å¼‚æ­¥å›è°ƒ]
    end

    subgraph "é€šçŸ¥å¤„ç†"
        N1[é€šçŸ¥é›†æˆå™¨]
        N2[äº‹ä»¶é˜Ÿåˆ—]
        N3[Webhookå‘é€å™¨]
    end

    subgraph "å¤–éƒ¨ç³»ç»Ÿ"
        T1[è®¡è´¹ç³»ç»Ÿ]
        T2[è¿è¥å¹³å°]
        T3[ç›‘æ§ç³»ç»Ÿ]
    end

    E1 --> C1
    E2 --> C2
    E3 --> C3
    E4 --> C1

    C1 --> N1
    C2 --> N1
    C3 --> N1

    N1 --> N2
    N2 --> N3

    N3 --> T1
    N3 --> T2
    N3 --> T3
```

## ğŸ¯ ç³»ç»Ÿç‰¹æ€§æ€»ç»“

### âœ… æ ¸å¿ƒç‰¹æ€§

1. **ç®€åŒ–æ¶æ„**: åŸºäºçœŸå®å‘ç°çš„ç®€åŒ–æ¨¡å¼ï¼Œé¿å…è¿‡åº¦è®¾è®¡
2. **äº‹ä»¶é©±åŠ¨**: å®Œæ•´çš„çŠ¶æ€å˜æ›´å’Œé€šçŸ¥æœºåˆ¶
3. **æ•°æ®ä¸€è‡´æ€§**: ç»Ÿä¸€å­˜å‚¨å’ŒçŠ¶æ€ç®¡ç†
4. **å®æ—¶é€šä¿¡**: TCP é•¿è¿æ¥å’Œå®æ—¶æ•°æ®å¤„ç†
5. **æ‰©å±•æ€§**: æ¨¡å—åŒ–è®¾è®¡ä¾¿äºåŠŸèƒ½æ‰©å±•

### ğŸ”§ æŠ€æœ¯å®ç°

1. **åè®®æ”¯æŒ**: å®Œæ•´çš„ DNY åè®®è§£æå’Œå¤„ç†
2. **å¹¶å‘å®‰å…¨**: çº¿ç¨‹å®‰å…¨çš„æ•°æ®ç»“æ„å’Œæ“ä½œ
3. **å®¹é”™æœºåˆ¶**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶
4. **ç›‘æ§èƒ½åŠ›**: å…¨é¢çš„ç³»ç»Ÿç›‘æ§å’Œæ—¥å¿—è®°å½•
5. **é…ç½®çµæ´»**: æ”¯æŒå¤šç§é…ç½®æ–¹å¼å’Œç¯å¢ƒ

### ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

- **è¿æ¥å®¹é‡**: æ”¯æŒ 1000+å¹¶å‘è¿æ¥
- **å“åº”æ—¶é—´**: å¹³å‡å“åº”æ—¶é—´ < 100ms
- **é€šçŸ¥å»¶è¿Ÿ**: äº‹ä»¶é€šçŸ¥å»¶è¿Ÿ < 500ms
- **æ•°æ®ä¸€è‡´æ€§**: 99.9%çš„æ•°æ®ä¸€è‡´æ€§ä¿è¯
- **ç³»ç»Ÿå¯ç”¨æ€§**: 99.9%çš„ç³»ç»Ÿå¯ç”¨æ€§
