# 🔒 IoT-Zinx 协议解析标准（永久固定）

## 📋 概述

本文档定义了IoT-Zinx系统的协议解析标准，基于真实设备数据验证。**一旦确定，这些标准永久不变！**

## 🎯 核心原则

1. **基于真实设备数据**：所有标准都基于真实设备的通信数据
2. **永久固定**：协议解析算法一旦确定，永久不变
3. **统一实现**：所有相同功能的函数必须使用统一的实现
4. **完整测试覆盖**：每个标准都有对应的测试用例

## 🔒 协议解析标准

### 1. ICCID格式标准（ITU-T E.118）

#### **格式规范**
```
长度：20字符
字符集：0-9, A-F, a-f（十六进制字符）
前缀：89（ITU-T E.118标准，电信行业标识符）
正则表达式：^89[0-9A-Fa-f]{18}$
```

#### **真实示例**
```
✅ 898604D9162390488297  // 真实设备ICCID，包含字母D
✅ 89860429165872938875  // 标准20位数字ICCID
✅ 898604A9162390488297  // 包含字母A
✅ 898604F9162390488297  // 包含字母F
✅ 898604d9162390488297  // 小写字母也支持
❌ 898604G9162390488297  // G不是十六进制字符
❌ 8986042916239048829   // 长度不足
❌ 788604D9162390488297  // 不以89开头
```

#### **验证函数统一**
所有ICCID验证函数必须返回相同结果：
- `isValidICCID(data []byte) bool`
- `isValidICCIDStrict(data []byte) bool`
- `IsValidICCIDPrefix(data []byte) bool`

### 2. DNY协议格式标准

#### **帧结构**
```
+--------+--------+--------+--------+--------+
| Header | Length |      Content      | Checksum |
|  DNY   |   2B   |    Variable       |    2B    |
| (3B)   | (LE)   |                   |   (LE)   |
+--------+--------+--------+--------+--------+

Header: "DNY" (0x44 0x4E 0x59)
Length: 内容长度（包含校验和），小端序
Content: 物理ID(4B) + 消息ID(2B) + 命令(1B) + 数据(nB)
Checksum: 校验和，小端序
```

#### **长度字段计算**
```
长度字段值 = 物理ID(4) + 消息ID(2) + 命令(1) + 数据(n) + 校验和(2)
总包长度 = 包头"DNY"(3) + 长度字段(2) + 长度字段值
```

#### **校验和计算**
```
计算范围：从包头"DNY"开始到校验和前的所有字节
算法：简单累加，取低16位
字节序：小端序
```

#### **真实示例**
```
示例1：444e590900f36ca2040200120d03
- 44 4e 59 = "DNY"
- 09 00 = 长度9（小端序）
- f3 6c a2 04 = 物理ID 0x04A26CF3（小端序）
- 02 = 命令 0x02
- 00 12 = 消息ID 0x1200（小端序）
- 0d 03 = 校验和 0x030D（小端序）

校验和验证：
数据：444e590900f36ca204020012
累加：0x44+0x4e+0x59+0x09+0x00+0xf3+0x6c+0xa2+0x04+0x02+0x00+0x12 = 0x030D ✅
```

### 3. Link心跳格式标准

#### **格式规范**
```
长度：4字节
内容：ASCII字符串"link"
十六进制：6c696e6b
```

#### **示例**
```
✅ 6c696e6b  // "link"
❌ 6c696e67  // "ling"
❌ 6c696e    // "lin" (长度不足)
```

## 🧪 测试标准

### 测试文件位置
```
pkg/protocol/protocol_parsing_test.go
```

### 测试覆盖范围
1. **ICCID验证测试**：所有格式变体
2. **DNY协议解析测试**：真实设备数据
3. **Link心跳解析测试**：标准格式验证
4. **校验和计算测试**：算法验证
5. **协议统一性测试**：函数一致性验证
6. **性能基准测试**：解析性能验证

### 运行测试
```bash
# 运行所有协议解析测试
go test ./pkg/protocol -v

# 运行特定测试
go test ./pkg/protocol -run TestICCIDValidation_Permanent -v
go test ./pkg/protocol -run TestDNYProtocolParsing_Permanent -v

# 运行基准测试
go test ./pkg/protocol -bench=BenchmarkProtocolParsing -v
```

## 🔧 实现要求

### 1. 统一实现原则
- 相同功能的函数必须调用统一的核心实现
- 不允许重复的验证逻辑
- 所有验证函数必须返回一致的结果

### 2. 错误处理
- 协议解析失败时，必须返回明确的错误信息
- 校验和不匹配时，必须记录详细的调试信息
- 长度不匹配时，必须说明期望值和实际值

### 3. 性能要求
- ICCID验证：< 1μs
- DNY协议解析：< 10μs
- Link心跳解析：< 1μs

## 🚫 禁止修改

### 永久禁止的操作
1. **修改校验和计算算法**
2. **修改长度字段解释**
3. **修改ICCID验证规则**
4. **修改DNY协议帧结构解析**
5. **修改Link心跳格式验证**

### 允许的操作
1. **添加新的协议类型**（不影响现有协议）
2. **优化性能**（不改变算法逻辑）
3. **改进错误信息**（不改变验证结果）
4. **添加调试日志**（不影响解析流程）

## 📝 变更记录

| 日期 | 版本 | 变更内容 | 负责人 |
|------|------|----------|--------|
| 2025-06-23 | 1.0.0 | 初始版本，基于真实设备数据固定协议解析标准 | System |

---

**⚠️ 重要提醒：本标准基于真实设备数据验证，一旦确定永久不变！任何修改都可能导致与真实设备的通信失败！**
