# IoT-Zinx项目文档

## 📚 文档目录

### 架构文档

- **[IoT-Zinx架构分析文档](architecture/IoT-Zinx架构分析文档.md)** - 完整的项目架构分析和设计文档
- **[系统架构图](architecture/diagrams/系统架构图.md)** - 整体系统架构的可视化图表
- **[数据流分析图](architecture/diagrams/数据流分析图.md)** - 从连接到业务处理的完整数据流
- **[设备管理图](architecture/diagrams/设备管理图.md)** - 设备连接和状态管理机制
- **[业务模块分析图](architecture/diagrams/业务模块分析图.md)** - 核心业务模块的详细分析

### 开发文档

- **[开发指南](development/开发指南.md)** - 开发环境搭建、扩展指南、最佳实践

## 🏗️ 项目概述

IoT-Zinx是一个基于Zinx网络框架的充电设备网关系统，采用六边形架构设计，实现了与充电桩设备的通信和管理。

### 核心特性

- **六边形架构**: 清晰的层次分离，易于维护和扩展
- **DNY协议支持**: 完整的DNY协议解析和处理
- **设备管理**: 智能的设备连接和状态管理
- **实时监控**: 心跳监控、状态同步、性能统计
- **第三方集成**: 灵活的第三方平台通知机制

### 技术栈

- **语言**: Go 1.19+
- **网络框架**: Zinx
- **HTTP框架**: Gin
- **日志**: Logrus
- **配置**: YAML
- **协议**: DNY自定义协议

## 📊 架构概览

```
外部系统 → 接口层 → 适配器层 → 应用层 → 领域层 → 基础设施层
```

### 核心组件

- **TCPManager**: 连接和设备管理
- **DNY解码器**: 协议解析和处理
- **SimpleHandlerBase**: 统一的命令处理基类
- **ConnectionSession**: 设备会话管理
- **DeviceGroup**: 设备组管理

## 🔄 数据流

1. **连接建立**: TCP连接 → Zinx框架 → TCPManager
2. **数据解析**: 原始数据 → DNY解码器 → 协议识别
3. **命令路由**: 消息ID → 路由器 → 具体Handler
4. **业务处理**: Handler → 业务逻辑 → 状态更新
5. **响应发送**: 业务结果 → DNY编码 → TCP发送

## 📋 业务模块

### 设备注册 (0x20)
- 智能注册决策
- ICCID验证和索引建立
- 设备组创建和管理
- 第三方平台通知

### 心跳监控 (0x01/0x21)
- 心跳去重检查
- 端口状态解析
- 连接保活管理
- 状态变化通知

### 充电控制 (0x82)
- 充电启停控制
- 端口操作验证
- 状态反馈管理

### 结算处理 (0x03)
- 结算数据解析
- 费用计算验证
- 多平台通知同步

## 🚀 快速开始

### 环境要求

- Go 1.19+
- Git

### 安装和运行

```bash
# 克隆项目
git clone <repository-url>
cd iot-zinx

# 安装依赖
go mod tidy

# 编译运行
go build -o iot-zinx cmd/gateway/main.go
./iot-zinx
```

### 配置

主配置文件: `configs/gateway.yaml`

```yaml
server:
  tcp_port: 8999
  http_port: 8080

device_connection:
  heartbeat_timeout_seconds: 300
  heartbeat_interval_seconds: 60

logging:
  level: "info"
  file_path: "logs/gateway.log"
```

## 🔧 开发指南

### 扩展新命令

1. 在 `pkg/constants/` 中定义命令常量
2. 在 `handlers/` 中创建处理器
3. 继承 `SimpleHandlerBase` 实现逻辑
4. 在 `router.go` 中注册路由

### 添加新协议

1. 在 `pkg/protocol/` 中扩展解析逻辑
2. 定义新的消息类型和数据结构
3. 实现编解码函数
4. 添加测试用例

### 集成第三方系统

1. 在 `pkg/notification/` 中实现通知接口
2. 配置第三方平台参数
3. 实现数据格式转换
4. 添加监控和日志

## 📈 监控和运维

### 健康检查

- **HTTP端点**: `GET /health`
- **系统统计**: `GET /api/stats`
- **设备列表**: `GET /api/devices`

### 日志系统

- **结构化日志**: 基于logrus的字段化记录
- **分级记录**: DEBUG/INFO/WARN/ERROR
- **自动轮转**: 基于时间和大小的文件管理

### 性能指标

- 连接统计: 总连接数、活跃连接数
- 设备统计: 总设备数、在线设备数
- 业务统计: 心跳计数、命令计数
- 性能统计: 处理延迟、错误率

## 🎯 最佳实践

### 代码规范

- 使用Go标准代码格式
- 添加详细的函数注释
- 实现完整的错误处理
- 编写单元测试和集成测试

### 性能优化

- 避免热路径内存分配
- 使用对象池复用对象
- 合理设置缓冲区大小
- 定期性能分析和优化

### 安全考虑

- 验证所有输入数据
- 实现访问控制和认证
- 记录安全相关操作
- 定期更新依赖库

## 📞 支持和贡献

### 问题反馈

如果您在使用过程中遇到问题，请：

1. 查看相关文档和FAQ
2. 检查日志文件中的错误信息
3. 提交Issue并提供详细信息

### 贡献指南

欢迎贡献代码和文档：

1. Fork项目仓库
2. 创建功能分支
3. 提交代码和测试
4. 创建Pull Request

---

**文档版本**: v1.0  
**生成时间**: 2025-08-07  
**项目版本**: IoT-Zinx v1.0  
**维护状态**: 活跃维护中

## 📋 文档更新记录

| 版本 | 日期 | 更新内容 | 作者 |
|------|------|----------|------|
| v1.0 | 2025-08-07 | 初始版本，完整架构分析文档 | AI Assistant |

---

*本文档基于IoT-Zinx项目的当前架构生成，如有疑问请参考具体的代码实现。*
