# IoT-Zinx 项目构建和测试指南

## 一、项目结构

IoT-Zinx 是一个基于 Zinx 框架的物联网设备通信网关，支持多种设备类型和通信协议。项目主要包含以下组件：

1. **Gateway**：设备网关服务，处理设备连接和命令分发
2. **Client**：设备模拟客户端，用于测试和开发
3. **Server-API**：HTTP API 服务，提供设备管理和控制接口
4. **DNY-Parser**：DNY 协议解析工具

## 二、通信架构

当前项目支持以下通信架构：

```
flowchart TD
    FJ1[分机1\n物理ID:04A26CF3\n编号:10644723]
    FJ2[分机2\n物理ID:04A228CD\n编号:10627277]
    COMM[通讯模块\nICCID:898604D9162390488297]
    NET[公网/专网]
    GW[设备网关]
    BIZ[业务平台]

    FJ1 -- 组网(485/LORA/有线/无线) --> COMM
    FJ2 -- 组网(485/LORA/有线/无线) --> COMM
    COMM -- TCP长连接 --> NET
    NET -- TCP长连接 --> GW
    GW -- API/数据/命令 --> BIZ
```

### 通信模式

系统支持两种通信模式：

1. **直连模式**：所有设备（包括分机）都可以通过通信模块直接与服务器通信，不依赖主机转发
2. **传统模式**：主机负责与服务器通信，分机通过主机进行消息转发

## 三、项目构建

### 构建工具

项目使用 Make 作为构建工具，支持多种构建选项和多平台编译。

### 基础构建命令

```bash
# 构建所有组件
make build-all

# 构建特定组件
make build-gateway
make build-client
make build-server-api
make build-dny-parser

# 多平台构建
make build-multi-platform

# 清理构建产物
make clean
```

### 指定目标平台

可以通过 `TARGET_PLATFORM` 参数指定构建的目标平台：

```bash
# 为 Linux ARM64 构建网关
make build-gateway TARGET_PLATFORM=linux/arm64

# 为 Windows AMD64 构建客户端
make build-client TARGET_PLATFORM=windows/amd64
```

### 支持的目标平台

默认支持以下平台：
- linux/amd64
- linux/arm64
- darwin/amd64
- darwin/arm64
- windows/amd64

## 四、运行和测试

### 运行各组件

```bash
# 运行网关服务
make run-gateway

# 运行客户端（直连模式）
make run-client

# 运行API服务
make run-server-api
```

### 测试直连模式

1. 首先启动网关服务：

```bash
make run-gateway
```

2. 在新的终端窗口启动客户端测试程序（直连模式）：

```bash
./bin/client -mode real -direct=true -server localhost:7054
```

3. 启动API测试客户端，查看设备状态：

```bash
./bin/server-api
```

在API测试客户端中，可以：
- 选择"1"查看设备列表
- 选择"2"查看特定设备状态
- 选择"9"查看设备组信息

### 测试传统模式

与直连模式类似，但启动客户端时使用不同参数：

```bash
./bin/client -mode real -direct=false -server localhost:7054
```

## 五、直连模式优化

我们最近对系统进行了直连模式优化，主要改进包括：

1. **服务端优化**：
   - 修改了TCP监控器中的分机绑定逻辑，支持分机独立通信
   - 优化了设备组管理器，确保设备组关系是可选的
   - 完善了设备监控器，优化设备离线处理和心跳检查
   - 增强了状态更新机制，按设备组优化状态更新

2. **客户端增强**：
   - 增加了设备类型判断函数，区分主机和分机
   - 增强了测试客户端，支持主机和分机的独立通信
   - 优化了SIM卡管理器，支持直连模式和传统模式的切换
   - 更新了命令行参数，添加直连模式开关

3. **API服务增强**：
   - 添加了设备组信息字段，便于查看设备组关系
   - 增加了获取设备组信息的操作，方便调试和验证

有关直连模式的详细说明，请参阅 `issues/通信模块直连模式实施方案.md`。

## 六、常见问题

### 构建问题

1. **编译失败**：
   - 确保已安装Go 1.16或更高版本
   - 运行`go mod tidy`更新依赖
   - 检查是否有特定平台不兼容的代码

2. **运行错误**：
   - 检查网络端口是否被占用
   - 确保配置文件正确
   - 查看日志文件了解详细错误

### 测试问题

1. **设备连接失败**：
   - 确认服务器地址和端口正确
   - 检查防火墙设置
   - 查看网关日志中的详细错误信息

2. **通信模式切换**：
   - 直连模式与传统模式间切换时，需要重启网关服务 