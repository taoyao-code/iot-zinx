电动自行车：主机-服务器通信协议指南

第2.9版

V2.9：增加了主机轮询指令0x00的描述。

V2.8：远程控制继电器，设备应答时增加了当前继电器状态字段。

V2.7：增加31、32、33，34指令，修改11、1A指令内容。

V2.6：漏保主机的17指令中增加一个漏电流字段

V2.5：修改温度报警功能默认为关闭；远程控制合闸增加消除报警记录的功能，同时删掉烟感/过温报警不执行部分，增加欠压/过压返回信息

V2.4：增加地锁控制指令。

V2.3：增加0x19获取漏保主机参数。

V2.2：增加AP262 LROA主机类型05.

V2.1：删除13指令；主机类型重新分配

V2.0：此为大改版，增加带断路器和计量功能的主机的指令

V1.7：增加老版本升级指令

V1.6：修改获取服务器时间（12指令）的定义

V1.5：重新规划设备类型及固件版本号

V1.4：修改了主机状态心跳包中SIM卡号的内容

V1.3：主机状态心跳包中增加SIM卡号、类型、频率



# **目录**
[1、基础通信协议框架	2](#_toc55856181)

[2、命令的定义	2](#_toc55856182)

[3、各数据单位定义：	2](#_toc55856183)

[4、通讯模块固定发送的字符	2](#_toc55856184)

[4、通讯指令	3](#_toc55856185)

[4.1、主机状态心跳包	3](#_toc55856186)

[4.2、主机获取服务器时间	3](#_toc55856187)

[4.4、主机固件升级（参考11指令中的设备类型表，不适用10路、16路）	3](#_toc55856188)

[4.5、主机请求固件升级（老版本15指令）	4](#_toc55856189)

[4.6、主机固件升级（老版本F9指令）	4](#_toc55856190)

[4.7、主机状态包上报	4](#_toc55856191)

[4.8、分/合闸状态变化上报	4](#_toc55856192)

[4.9、获取参数	4](#_toc55856193)

[4.A、设置参数	5](#_toc55856194)

[4.B、参数恢复出厂设置	5](#_toc55856195)

[4.C、远程控制合闸	5](#_toc55856196)

[4.D、远程控制分闸	5](#_toc55856197)

[4.E、远程控制报警继电器吸合	6](#_toc55856198)

[4.F、远程控制报警继电器断开	6](#_toc55856199)

[5.1、车位锁地锁升起（0xA1指令）	6](#_toc55856200)

[5.2、车位锁地锁降下（0xA2指令）	6](#_toc55856201)

[5.3、车位锁状态查询（0xA3指令）	6](#_toc55856202)

[5.4、车位锁超声波检测（0xA4指令）	7](#_toc55856203)

[5.5、车位锁地址修改（0xA5指令）	7](#_toc55856204)

[5.6、车位锁查询地址（0xA6指令）	7](#_toc55856205)




## **1、电动自行车基础通信协议框架**

| 包头（DNY） | 长度  | 物理ID | 消息ID | 命令  | 数据  | 校验  |
| :---------: | :---: | :----: | :----: | :---: | :---: | :---: |
|    3字节    | 2字节 | 4字节  | 2字节  | 1字节 |   n   | 2字节 |

1. 为了减少包头和数据内容重叠概率，采用3字节包头， 为DNY
1. 长度=物理ID+消息ID+命令+数据(n) +校验(2)，每包最多256字节
1. 为了保证每条命令传输的正确性，采用2字节无符号累加和校验，校验从包头到数据的内容
1. 此协议无其它注释情况下，均默认采用"小端模式"
1. 无特别注释下，均默认每条命令至多重新发送1次，故需加入无应答、重发机制，应答超时为15秒
1. 服务器和设备之间的通信，数据可能会被分包发送，所以服务器端要做粘包分包处理。
1. 服务器发给同一台设备时，每条命令之间必须有0.5秒以上的延时
## <a name="_toc55856182"></a>**2、命令的定义**
1. 为了防止命令重复，加入消息ID，每条命令的消息ID必须不同，但重发的命令的消息ID必须相同。
1. 为了防止命令错误，应答时的消息ID，必须和发送方的消息ID保持一致
1. 为了区分各个功能，加入命令，最大支持255条命令
1. 设备物理ID和设备上的二维码中的一致，无重复，不丢失
## <a name="_toc55856183"></a>**3、各数据单位定义：**
1. 所有金额以"分"为单位；（如有说明的除外）
1. 所有日期以国际通用时间戳为准，例如1519865912则表示北京时间2018/3/1 8:58:32；（如有说明的除外）
1. 所有时长（相对时间）以"秒"为单位；（如有说明的除外）
1. 电压以0.1V为单位，例如2212，则表示是221.2V；（如有说明的除外）
1. 所有功率以0.1W为单位，例如数据是2342，则表示是234.2W；（如有说明的除外）
1. 所有电流以0.001A为单位，例如2345则表示2.345A（如有说明的除外）
1. 所有耗电量以0.01度为单位，例如数据是135，则表示是1.35度；（如有说明的除外）

## <a name="_toc55856184"></a>**4、通讯模块固定发送的字符**
1、通讯模块连接上服务器的端口后会发送SIM卡号（ICCID），以字符串方式发送，如：89860413161892009275

2、通讯模块正常联网后，如没有数据通讯，则每隔30秒发送固定心跳包link，以字符串方式发送


## <a name="_toc55856185"></a>**4、通讯指令**
### **4.0、主机轮询完整指令（0x00）**
00指令是主机与分机之间的通迅指令，不会发给服务器，服务器不用管。	

485轮询串口定义如下：波特率9600，数据长度8，无校验N，停止位1。

主机发送给485线：

|       |       |       | 长度  | 设备ID | 消息ID | 指令  | 虚拟ID | 校验和 |
| :---: | :---: | :---: | :---: | :----: | :----: | :---: | :----: | :----: |
| 0x44  | 0x4e  | 0x59  | 2字节 | 4字节  | 2字节  | 0x00  | 1字节  | 2字节  |

1. 0x44,0x4e,0x59：指令的固件头共3个字节。
1. 长度：物理ID+消息ID+命令+数据(n) +校验(2)，本指令固定为0x0A。
1. 设备ID：当主机已连上网时，设备ID传0x00，当主机断网时，设备ID传当前时间戳，单位是秒的时间戳。
1. 消息ID：具有自动分配虚拟ID时传1，不具有时传0。
1. 指令：轮询指令固定为0x00。
1. 虚拟ID：即当前轮询哪个虚拟ID设备，一个主机最多接50台分机，即虚拟ID范围是0-49。
1. 校验和：前面所有字节，按字节累加和。
1. 主机485轮询一次时间，设置超时为60ms，当主机每收到分机1字节数据时，超时计数清0。

### <a name="_toc55856186"></a>**4.1、主机状态心跳包（0x11）**
主机发送：

| 命令  | 固件版本 | 是否有RTC模块 | 主机当前时间戳 | 信号强度 | 通讯模块类型 | SIM卡号 | 主机类型 | 频率  |  IMEI  | 模块版本号 |
| :---: | :------: | :-----------: | :------------: | :------: | :----------: | :-----: | :------: | :---: | :----: | :--------: |
| 0x11  |  2字节   |     1字节     |     4字节      |  1字节   |    1字节     | 20字节  |    1     |   2   | 15字节 |   24字节   |

如：44 4E 59 29 00 84 26 D6 09 04 00 11 65 00 01 5C 5C A9 5F 1F 06 38 39 38 36 30 34 31 33 31 36 31 38 39 32 30 30 39 32 37 35 50 D8 01 3F 0A

**服务器应答：无须应答**

1. 此命令主机每隔30分钟发送一次，服务器不用应答。
2. RTC模块，00=无RTC模块，01=SD2068，02=BM8563
1. 主机当前时间戳：如无RTC模块，则为全0
1. 信号强度：指通讯模块2G或4G信号，范围0-31（31信号最好），99表示异常，小部分模块信号大于100时，服务器计算取值需减100，且这种模块的信号范围值为0-97，与前面不同需区分，每30分钟获取一次信号强度
1. 通讯模块类型，01=WIFI(B2)，02=2G（GM3），03=4G（7S4/G405），04=2G（GM35），05=NB（M5311），06=4G-CAT1（GM5），07=有人帮开发的OpenCpu 4G-CAT1（GM5），08=4G-CAT1（GM6）。
1. SIM卡号：每次上电时仅需获取一次，不用重复获取，以免影响通讯模块的工作状态。使用ASCII字符串格式，如8则为38，如C则为42。
1. 主机类型：指主机类型，（如自带通讯模块的插座，如10路、NB，主机类型和20注册包的设备类型一致）

   |   主机型号    | 主机类型(16进制) | 固件版本号(10进制) | 升级命令(16进制) | 设备请求升级命令(16进制) | 每包数据(10进制) |
   | :-----------: | :--------------: | :----------------: | :--------------: | :----------------------: | :--------------: |
   |    旧款485    |      01或无      |       2\.xx        |        F9        |            15            |       256        |
   |   旧款lora    |        02        |       1\.xx        |        FA        |            FA            |       200        |
   |   新款lora    |        03        |       5\.xx        |        FA        |          全被动          |       200        |
   |    433无线    |        04        |       6\.xx        |        FA        |          全被动          |       200        |
   |  AP262 LORA   |        05        |       2\.xx        |        FA        |          全被动          |       200        |
   | AP262合装主机 |        50        |       3\.xx        |        FA        |          全被动          |       200        |
   |   漏保主机    |        51        |       4\.xx        |        FA        |          全被动          |       200        |

1. 频率：LORA使用的中心频率，如无此数据则为0
1. IMEI：即模块的IMEI号。
1. 模块版本号：通迅模块的固件版本号。
### <a name="_toc55856187"></a>**4.2、主机获取服务器时间（0x12）**
主机发送：

| 命令  |
| :---: |
| 0x12  |

如：44 4E 59 09 00 84 26 D6 09 05 00 12 94 02

服务器应答：

| 命令  | 时间戳 |
| :---: | :----: |
| 0x12  | 4字节  |

如：44 4E 59 0D 00 84 26 D6 09 05 00 12 DE 5C A9 5F DA 04

1.  此命令主机每次上电后就会发送，直至服务器应答后就停止发送。如服务器无应答，则每隔3分钟发送一次请求。
2.  **注意：此交互为"请求-应答"模式，服务器发送应答后，主机无需再次回复确认。**
3.  每12小时从服务器获取一次时间，如服务器不应答则每隔3分钟发送一次请求。
4.  不带RTC模块的主机不会发送此命令
5.  DE 5C A9 5F，转小端模式，=0x5FA95CDE=1604934878=2020-11-09 23:14:38
### <a name="_toc55856188"></a>**4.4、主机固件升级（参考11指令中的设备类型表，不适用10路、16路）**
触发主机进入远程升级状态

服务器发送：

| 命令  |
| :---: |
| 0xFA  |

设备应答：设备请求固件升级

| 命令  | 应答  | 请求升级（固定为0000） |
| :---: | :---: | :--------------------: |
| 0xFA  | 1字节 |         2字节          |

1. 此命令用于触发设备进入远程升级状态
1. 应答：0=执行成功，其他=要求服务器重发
1. 设备的应答命令也相当于是"设备请求固件升级"命令
1. 3分钟未收到服务器升级指令后发送
1. 升级失败且重新上电后会发送
1. 服务器收到此命令后开始发送正式升级命令的第一包。注意：服务器每次收到此命令后都从第一包开始。

正式开始远程升级

服务器发送：

| 命令  | 总包数 | 当前包 |  固件   |
| :---: | :----: | :----: | :-----: |
| 0xFA  | 2字节  | 2字节  | 200字节 |

主机应答：

| 命令  | 应答  | 当前包 |
| :---: | :---: | :----: |
| 0xFA  | 1字节 | 2字节  |

1. 当收到"主机请求固件升级"命令后发送第一包数据
1. 总包数：如一个固件为640字节，则总包数为 640/ 200 = 3.2 = 4
1. 当前包：从1开始，为第一包，当前包等于总包数时，固件发送完毕
1. 应答：0=功，可以发送下一包；1=失败，重新发送当前包
1. 主机应答中当前包：当前成功收到的数据包
1. 服务器注意事项：鉴于我们的经验，服务器应做重发机制，如30秒未收到设备的应答，应重发当前包，可做3次重发。
### <a name="_toc531641186"></a><a name="_toc55856189"></a>**4.5、主机请求固件升级（老版本15指令）**
主机发送：

| 命令  |
| :---: |
| 0x15  |

服务器应答：

| 命令  | 应答  |
| :---: | :---: |
| 0x15  | 1字节 |

1. 此命令只在固件升级失败且重新上电后才会发送
1. 服务器收到此命令后开始发送0xF9升级命令
### <a name="_toc531641187"></a><a name="_toc55856190"></a>**4.6、主机固件升级（老版本F9指令）**
服务器发送：

| 命令  | 总包数 | 当前包 |  固件   |
| :---: | :----: | :----: | :-----: |
| 0xF9  | 2字节  | 2字节  | 256字节 |

主机应答：

| 命令  | 应答  | 当前包 |
| :---: | :---: | :----: |
| 0xF9  | 1字节 | 2字节  |

1. 总包数，如一个固件为640字节，则总包数为 640/ 256 = 2.5 = 3
1. 当前包，从1开始，为第一包，当前包等于总包数时，固件发送完毕
1. 应答=0成功，可以发送下一包； =1错误，重新发送当前包
1. 当前包：当前成功收到的数据包
1. 如果2次重传，依然不成功，则需重新升级

### **4.7、主机状态包上报（0x17）**
主机发送：

|     命令     |   电闸状态   | 当前温度 | 当前电压(0.1V) | 当前电流(0.01A) | 当前累计电量(0.01度) | 电表当前电流(0.01A) | 电表当前累计电量(0.01度) | 烟感报警状态 | 报警继电器状态 | 当前漏电流（mA） |
| :----------: | :----------: | :------: | :------------: | :-------------: | :------------------: | :-----------------: | :----------------------: | :----------: | :------------: | :--------------: |
|     0x17     |    1字节     |  1字节   |     2字节      |      2字节      |        4字节         |        2字节        |          4字节           |    1字节     |     1字节      |      1字节       |
| 当前火线温度 | 当前零线温度 | 锁闸状态 |    空开款式    |                 |                      |                     |                          |              |                |                  |
|    1字节     |    1字节     |  1字节   |     1字节      |                 |                      |                     |                          |              |                |                  |


1. 每30分钟（根据参数）发送一次，服务器无需应答；
2. 电闸状态：00=分闸，01=合闸
3. 烟感报警状态：00=无报警，01=有报警
4. 报警继电器状态：00=断开，01=吸合
5. 应答：0=正常
6. 锁闸状态：00=解除锁闸，01=锁闸
7. 空开款式：00=短款单相，01=长款单相, 02=带屏主机
8. 单车桩（非漏保主机）上传，不需解析电闸状态，和 报警继电器状态 到 空开款式 的字段,单车后台无需回复



### **6.1、重启主机指令（0x31指令）**
服务器发送：

| 命令  |
| :---: |
| 0x31  |

主机应答：

| `	 `命令 | 应答结果 |
| :------: | :------: |
|   0x31   |  1字节   |

1. 主机会重新启动。
1. 应答结果：0＝成功，其它＝失败。

### **6.2、重启通迅模块（0x32指令）**
服务器发送：

| 命令  |
| :---: |
| 0x32  |

主机应答：

| `	 `命令 | 应答结果 |
| :------: | :------: |
|   0x32   |  1字节   |

1. 通迅模块会重新启动。
1. 应答结果：0＝成功，其它＝失败。
### **6.3、清空升级分机数据（0x33指令）**
服务器发送：

| 命令  |
| :---: |
| 0x33  |

主机应答：

| `	 `命令 | 应答结果 |
| :------: | :------: |
|   0x33   |  1字节   |

1. 清空升级分机数据。
1. 应答结果：0＝成功，其它＝失败。

### **6.4、更改IP地址（0x34指令）(最新固件才支持)**
服务器发送：

| 命令  | 端口号 | 模块类型 | Socket B使能 | IP地址 |
| :---: | :----: | :------: | :----------: | :----: |
| 0x34  | 2字节  |  1字节   |    1字节     | 46字节 |

示例：端口号=8888，模块类型=4G，Socket B使能=打开，IP地址=baidu.com

44 4E 59 3B 00 70 08 BE 76 00 00 34 B8 22 03 01 62 61 69 64 75 2E 63 6F 6D 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 56 07

主机应答：

| `	 `命令 | 应答结果 |
| :------: | :------: |
|   0x34   |  1字节   |

1. 远程更改IP地址。
1. 端口号：连接的服务器的端口。
1. 模块类型：1=WIFI，2=2G，3=4G。
1. Socket B使能：是否开启服务器B，0=关闭，1=打开。(外接平台要打开)
1. IP地址：连接的服务器的IP地址，可为IP或域名，最大45个字符，最后一个字节必需为0x00；如总字节不足46字节，后面需全部补0x00。
1. 应答结果：0＝成功，无其它值。

### **6.5、上传分机版本号与设备类型（0x35指令）(最新固件才支持)**
主机发送：

| 命令  | 类型数量N | （分机类型 | 保留字节 | 最低版本号 | 物理ID） |   …   |
| :---: | :-------: | :--------: | :------: | :--------: | :------: | :---: |
| 0x35  |   1字节   |  （1字节   |  1字节   |   2字节    | 4字节）  |   …   |

**服务器应答：无需应答**

1. 类型数量：后面上传有多少种分机类型，每种类型8字节，如有N个类型，后面的字节为N\*8个字节。
1. 分机类型：即分机设备类型，如AP262-485的设备类型为0x21。
1. 最低版本号：连接本主机里面，当前种类的分机里面最低的版本号。
1. 物理ID：当前类型设备最低版本号的设备ID。


### **6.6、设置FSK主机参数及分机号（0x3A指令）**
`		`（2023-07-18增加，新款无线组网设备支持）

服务器下发：

| 命令  | 主机频率 | 保留字节 | 所带分机数 | 分机ID1 | 分机ID2 | 分机IDx |
| :---: | :------: | :------: | :--------: | :-----: | :-----: | :-----: |
| 0x98  |  2字节   |  3字节   |   1字节    |  4字节  |  4字节  |  4字节  |
| 默认  |          |          |            |         |         |         |
设备应答：

| 命令  | 应答  |
| :---: | :---: |
| 0x3A  | 1字节 |

1. 主机频率：设置当前主机的频率，单位MHz。
1. 所带分机数：即后面有多少个分机ID。
1. 保留字节：暂时没有使用到，内容填充0x00。
1. 分机ID：设置本主机所带的所有分机的物理ID号。
1. 应答：0=执行成功，其他=失败。

### **6.7、请求服务器FSK主机参数（0x3B指令）**
`		`（2023-07-18增加，新款无线组网设备支持）

设备上发：

|  命令  | 主机频率 |
| :----: | :------: |
|  0x3B  |  2字节   |
| 默认植 |    0     |

**服务器应答：服务器需使用 `0x3A` 指令作为应答，下发FSK主机参数。**

1. 用于触发FSK主机参数，即请求服务器下发0x3A指令；主机重启时第30秒发送一次，后面每2小时发送一次。
1. 主机频率：指当前主机所使用的频率。

0

