# 改进日志系统使用指南

## 概述

本项目使用改进的日志系统，基于 logrus 和 lumberjack，提供了统一的日志管理、自动轮转、结构化日志和 Zinx 框架集成等功能。

## 主要特性

### 1. 统一日志管理

- 基于 logrus 的强大日志功能
- 支持多种日志级别：trace, debug, info, warn, error, fatal, panic
- 支持 JSON 和 TEXT 两种输出格式

### 2. 自动日志轮转

- 基于 lumberjack 实现自动日志轮转
- 支持按文件大小、备份数量、保留天数进行轮转
- 避免日志文件过大影响系统性能

### 3. 多路输出

- 同时支持控制台和文件输出
- 开发环境便于实时查看
- 生产环境便于日志收集和分析

### 4. 结构化日志

- 支持结构化字段，便于日志分析
- 统一的错误处理和上下文信息
- 支持链式调用和字段组合

### 5. Zinx 框架集成

- 通过适配器模式统一 Zinx 框架日志
- 为 Zinx 日志添加来源标识
- 支持上下文传递

## 配置说明

### 配置文件示例

```yaml
# 日志配置
logger:
  level: "debug" # 日志级别：trace, debug, info, warn, error, fatal, panic
  format: "json" # 输出格式：json, text
  filePath: "./logs/gateway.log" # 日志文件路径
  maxSizeMB: 100 # 最大文件大小（MB）
  maxBackups: 10 # 最大备份文件数量
  maxAgeDays: 30 # 最大保留天数
  logHexDump: true # 是否记录十六进制数据
  enableConsole: true # 是否同时输出到控制台
  enableStructured: true # 是否启用结构化日志
```

### 配置参数说明

| 参数             | 类型   | 说明                 | 默认值             |
| ---------------- | ------ | -------------------- | ------------------ |
| level            | string | 日志级别             | debug              |
| format           | string | 输出格式             | json               |
| filePath         | string | 日志文件路径         | ./logs/gateway.log |
| maxSizeMB        | int    | 最大文件大小（MB）   | 100                |
| maxBackups       | int    | 最大备份文件数量     | 10                 |
| maxAgeDays       | int    | 最大保留天数         | 30                 |
| logHexDump       | bool   | 是否记录十六进制数据 | true               |
| enableConsole    | bool   | 是否同时输出到控制台 | true               |
| enableStructured | bool   | 是否启用结构化日志   | true               |

## 使用方法

### 1. 基本日志记录

```go
// 获取改进的日志实例
improvedLogger := utils.GetGlobalImprovedLogger()

// 简单日志记录
improvedLogger.Info("系统启动", nil)
improvedLogger.Error("连接失败", nil)

// 带结构化字段的日志记录
improvedLogger.Info("用户登录", map[string]interface{}{
    "user_id": "12345",
    "ip": "192.168.1.100",
    "timestamp": time.Now(),
})

improvedLogger.Error("数据库连接失败", map[string]interface{}{
    "database": "mysql",
    "host": "localhost:3306",
    "error": err.Error(),
})
```

### 2. 在主程序中初始化

```go
// 初始化改进的日志系统
loggerConfig := config.GetConfig().Logger
improvedLogger, err := logger.NewImprovedLogger(&loggerConfig)
if err != nil {
    fmt.Printf("初始化改进日志系统失败: %v\n", err)
    os.Exit(1)
}

// 设置 Zinx 框架使用改进的日志系统
utils.SetupImprovedZinxLogger(improvedLogger)
```

### 3. 在业务代码中使用

```go
// 在处理器中使用
func (h *DeviceHandler) HandleConnect(conn ziface.IConnection) {
    logger := utils.GetGlobalImprovedLogger()

    logger.Info("设备连接", map[string]interface{}{
        "conn_id": conn.GetConnID(),
        "remote_addr": conn.GetConnection().RemoteAddr().String(),
        "component": "device_handler",
    })
}

// 在错误处理中使用
func (h *DeviceHandler) HandleError(conn ziface.IConnection, err error) {
    logger := utils.GetGlobalImprovedLogger()

    logger.Error("设备连接错误", map[string]interface{}{
        "conn_id": conn.GetConnID(),
        "error": err.Error(),
        "component": "device_handler",
        "action": "error_handling",
    })
}
```

### 4. 十六进制数据记录

```go
// 记录二进制数据的十六进制表示
logger := utils.GetGlobalImprovedLogger()
logger.HexDump("接收到DNY数据包", data, true)
```

## 最佳实践

### 1. 结构化字段命名规范

建议使用以下字段命名规范：

```go
// 基础字段
map[string]interface{}{
    "component": "tcp_server",     // 组件名称
    "action": "connect",           // 动作类型
    "status": "success",           // 状态
    "conn_id": 12345,             // 连接ID
    "device_id": "DNY001",        // 设备ID
    "error": err.Error(),         // 错误信息
    "duration_ms": 150,           // 耗时（毫秒）
    "remote_addr": "192.168.1.100", // 远程地址
}
```

### 2. 日志级别使用建议

- **trace**: 非常详细的调试信息，通常只在开发环境使用
- **debug**: 调试信息，包括详细的执行流程
- **info**: 一般信息，记录重要的业务流程
- **warn**: 警告信息，系统可以继续运行但需要注意
- **error**: 错误信息，程序出现错误但可以恢复
- **fatal**: 致命错误，程序无法继续运行

### 3. 性能考虑

```go
// 避免在热路径中使用过于详细的日志
if logger.GetLogger().IsLevelEnabled(logrus.DebugLevel) {
    logger.Debug("详细调试信息", map[string]interface{}{
        "data": fmt.Sprintf("%+v", complexData),
    })
}

// 对于高频操作，使用合适的日志级别
logger.Info("关键业务操作", map[string]interface{}{
    "operation": "charge_start",
    "device_id": deviceId,
})
```

### 4. 错误处理模式

```go
// 统一的错误处理模式
func processDevice(deviceId string) error {
    logger := utils.GetGlobalImprovedLogger()

    logger.Info("开始处理设备", map[string]interface{}{
        "device_id": deviceId,
        "component": "device_processor",
        "action": "start",
    })

    if err := validateDevice(deviceId); err != nil {
        logger.Error("设备验证失败", map[string]interface{}{
            "device_id": deviceId,
            "component": "device_processor",
            "action": "validate",
            "error": err.Error(),
        })
        return err
    }

    logger.Info("设备处理完成", map[string]interface{}{
        "device_id": deviceId,
        "component": "device_processor",
        "action": "complete",
    })

    return nil
}
```

## Zinx 框架日志集成

Zinx 框架的日志会自动通过适配器集成到改进的日志系统中：

### 1. 自动添加来源标识

```json
{
  "level": "debug",
  "msg": "read buffer 444e590900cd28a2043b0222ee02",
  "source": "zinx",
  "time": "2025-06-02 18:03:08"
}
```

### 2. 支持上下文传递

Zinx 框架的上下文日志会保留上下文信息：

```json
{
  "level": "info",
  "msg": "connection established",
  "source": "zinx",
  "conn_id": 12345,
  "time": "2025-06-02 18:03:08"
}
```

## 日志文件管理

### 1. 自动轮转

日志文件会根据配置自动轮转：

```
logs/
├── gateway.log              # 当前日志文件
├── gateway.log.1            # 备份文件1
├── gateway.log.2            # 备份文件2
└── ...
```

### 2. 文件命名规则

- 当前日志文件：`gateway.log`
- 轮转备份文件：`gateway.log.1`, `gateway.log.2`, ...
- 压缩备份文件：`gateway.log.1.gz`, `gateway.log.2.gz`, ...

### 3. 清理策略

- 超过 `maxBackups` 数量的备份文件会被自动删除
- 超过 `maxAgeDays` 天数的备份文件会被自动删除
- 超过 `maxSizeMB` 大小的当前文件会触发轮转

## 故障排查

### 1. 日志文件权限问题

```bash
# 检查日志目录权限
ls -la logs/

# 修复权限问题
chmod 755 logs/
chmod 644 logs/gateway.log
```

### 2. 日志级别不生效

检查配置文件中的日志级别设置，确保拼写正确：

```yaml
logger:
  level: "debug" # 注意大小写
```

### 3. 日志文件过大

检查轮转配置：

```yaml
logger:
  maxSizeMB: 100 # 减小文件大小限制
  maxBackups: 5 # 减少备份文件数量
```

### 4. 性能问题

- 在生产环境中将日志级别调整为 `info` 或更高
- 关闭 `logHexDump` 以减少二进制数据记录
- 考虑使用异步日志（如果需要）

## 扩展功能

### 1. 自定义字段

可以为特定模块添加固定字段：

```go
// 创建带固定字段的子日志器
deviceLogger := logger.GetLogger().WithFields(logrus.Fields{
    "component": "device_manager",
    "version": "1.0.0",
})

deviceLogger.Info("设备状态更新")
```

### 2. 钩子函数

可以添加钩子函数处理特殊日志：

```go
// 添加错误日志钩子，发送告警
hook := &ErrorAlertHook{}
logger.GetLogger().AddHook(hook)
```

### 3. 上下文传递

支持在处理链中传递上下文：

```go
ctx := context.WithValue(context.Background(), "trace_id", "abc123")
logger.GetLogger().WithContext(ctx).Info("处理请求")
```

## 总结

改进的日志系统提供了完整的日志管理解决方案，包括：

1. **统一管理**: 所有日志通过统一接口管理
2. **自动轮转**: 避免日志文件过大问题
3. **结构化记录**: 便于日志分析和监控
4. **框架集成**: 无缝集成 Zinx 框架日志
5. **性能优化**: 合理的配置和使用模式

通过正确配置和使用，可以大大提升系统的可观测性和问题定位能力。
