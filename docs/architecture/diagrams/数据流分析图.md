# IoT-Zinx数据流分析图

## 完整数据流时序图

```mermaid
sequenceDiagram
    participant Device as 充电设备
    participant TCPPort as TCP服务器:8999
    participant ZinxFramework as Zinx框架
    participant DNYDecoder as DNY解码器
    participant Router as 路由器
    participant Handler as 命令处理器
    participant TCPManager as TCP管理器
    participant BusinessLogic as 业务逻辑
    participant UnifiedBuilder as UnifiedDNYBuilder
    participant TCPWriter as TCPWriter

    %% 1. 连接建立阶段
    Note over Device,ResponseSender: 1. 连接建立阶段
    Device->>TCPPort: TCP连接请求
    TCPPort->>ZinxFramework: 创建连接对象
    ZinxFramework->>TCPManager: OnConnStart回调
    TCPManager->>TCPManager: RegisterConnection()
    Note right of TCPManager: 创建ConnectionSession<br/>分配ConnID<br/>记录RemoteAddr

    %% 2. 数据接收和解析阶段
    Note over Device,ResponseSender: 2. 数据接收和解析阶段
    Device->>TCPPort: 发送原始数据包
    TCPPort->>ZinxFramework: 接收TCP数据流
    ZinxFramework->>DNYDecoder: Intercept()拦截原始数据
    
    DNYDecoder->>DNYDecoder: SplitPacketsFromBuffer()
    Note right of DNYDecoder: 处理TCP粘包<br/>分割完整数据包
    
    DNYDecoder->>DNYDecoder: ParseDNYProtocolData()
    Note right of DNYDecoder: 识别数据包类型:<br/>1. ICCID (20字节)<br/>2. Link心跳 ("link")<br/>3. DNY标准协议<br/>4. 未知数据
    
    alt DNY标准协议
        DNYDecoder->>DNYDecoder: 解析DNY帧结构
        Note right of DNYDecoder: 提取PhysicalID<br/>提取MessageID<br/>提取Command<br/>提取Payload<br/>校验Checksum
        DNYDecoder->>ZinxFramework: 设置MsgID=Command
    else ICCID数据
        DNYDecoder->>ZinxFramework: 设置MsgID=MsgIDICCID
    else Link心跳
        DNYDecoder->>ZinxFramework: 设置MsgID=MsgIDLinkHeartbeat
    else 未知数据
        DNYDecoder->>ZinxFramework: 设置MsgID=MsgIDUnknown
    end

    %% 3. 路由和处理阶段
    Note over Device,ResponseSender: 3. 路由和处理阶段
    ZinxFramework->>Router: 根据MsgID路由到Handler
    
    alt 设备注册 (0x20)
        Router->>Handler: DeviceRegisterHandler
        Handler->>Handler: ExtractDecodedFrame()
        Handler->>Handler: ValidateFrame()
        Handler->>Handler: GetOrCreateDeviceSession()
        Handler->>TCPManager: RegisterDevice()
        Note right of TCPManager: 建立设备索引<br/>创建/更新DeviceGroup<br/>更新设备状态
    else 心跳包 (0x01/0x21)
        Router->>Handler: HeartbeatHandler
        Handler->>TCPManager: UpdateHeartbeat()
        Note right of TCPManager: 更新LastHeartbeat<br/>更新DeviceStatus<br/>增加HeartbeatCount
    else 充电控制 (0x82)
        Router->>Handler: ChargeControlHandler
        Handler->>BusinessLogic: 处理充电逻辑
        Note right of BusinessLogic: 解析端口号<br/>解析操作类型<br/>执行充电控制
    else 参数设置 (0x83/0x84)
        Router->>Handler: ParameterSettingHandler
        Handler->>BusinessLogic: 处理参数配置
    else 结算数据 (0x03)
        Router->>Handler: SettlementHandler
        Handler->>BusinessLogic: 处理结算逻辑
    end

    %% 4. 业务处理阶段
    Note over Device,ResponseSender: 4. 业务处理阶段
    Handler->>BusinessLogic: 执行具体业务逻辑
    BusinessLogic->>TCPManager: 更新设备状态
    BusinessLogic->>BusinessLogic: 数据验证和处理
    
    %% 5. 响应生成和发送阶段
    Note over Device,TCPWriter: 5. 响应生成和发送阶段
    BusinessLogic->>UnifiedBuilder: 构造DNY响应帧
    UnifiedBuilder->>TCPWriter: 统一发送（RAW TCP）
    TCPWriter->>Device: 发送响应数据包

    %% 6. 连接管理阶段
    Note over Device,ResponseSender: 6. 连接管理阶段
    alt 连接正常
        TCPManager->>TCPManager: 定期心跳检查
        Note right of TCPManager: 检查LastHeartbeat<br/>清理超时连接
    else 连接断开
        ZinxFramework->>TCPManager: OnConnStop回调
        TCPManager->>TCPManager: UnregisterConnection()
        Note right of TCPManager: 清理ConnectionSession<br/>清理设备索引<br/>更新统计信息
    end
```

## 数据流关键节点

### 1. 连接建立阶段
- TCP连接建立
- 创建ConnectionSession
- 注册到TCPManager

### 2. 数据接收和解析阶段
- TCP数据流接收
- DNY协议解析
- 数据包类型识别
- 消息ID设置

### 3. 路由和处理阶段
- 根据命令ID路由
- 调用对应Handler
- 执行业务逻辑
- 更新设备状态

### 4. 响应生成和发送阶段
- 构造响应数据
- DNY帧编码
- TCP数据发送

### 5. 连接管理阶段
- 心跳监控
- 超时检测
- 资源清理

## 数据处理特点

### TCP粘包处理
- 自动分割数据包
- 缓冲区管理
- 完整性验证

### 协议解析
- 多协议支持
- 智能识别
- 错误恢复

### 状态管理
- 实时状态更新
- 多层状态同步
- 统计信息维护

---

**图表版本**: v1.1  
**更新时间**: 2025-08-23  
**图表类型**: Mermaid Sequence Diagram  
**适用范围**: IoT-Zinx完整数据流分析
