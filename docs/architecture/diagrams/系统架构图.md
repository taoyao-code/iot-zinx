# IoT-Zinx系统架构图

## 整体架构图（统一DeviceGateway架构）

```mermaid
graph TB
    %% 外部系统
    subgraph "外部系统"
        Device[充电设备]
        Client[HTTP客户端]
        Admin[管理界面]
    end

    %% 网关层
    subgraph "IoT-Zinx网关系统"
        %% 端口(Ports)
        subgraph "接口层 (Ports)"
            TCPPort[TCP服务器<br/>:8999]
            HTTPPort[HTTP服务器<br/>:8080]
        end

        %% 适配器
        subgraph "适配器层 (Adapters)"
            ZinxAdapter[Zinx网络适配器]
            HTTPAdapter[HTTP API适配器]
        end

        %% 统一网关
        subgraph "统一设备网关 (pkg/gateway)"
            DeviceGateway[DeviceGateway]
            UnifiedBuilder[UnifiedDNYBuilder]
            TCPWriter[UnifiedSender/TCPWriter]
        end

        %% 协议与命令
        subgraph "协议与网络 (pkg/protocol / pkg/network)"
            DNYDecoder[DNY解码器]
            CmdManager[CommandManager\n(消息ID/超时/重试)]
        end

        %% 核心管理
        subgraph "核心 (pkg/core)"
            TCPManager[TCP管理器]
            PortManager[端口管理器]
        end

        %% 通知系统
        subgraph "通知系统 (pkg/notification)"
            Notifier[NotificationService]
            Redis[(Redis持久化重试队列)]
        end

        %% 处理器
        subgraph "设备指令处理器 (handlers)"
            HReg[设备注册 0x20]
            HHB[心跳 0x01/0x21/0x26]
            HCharge[充电控制 0x82]
            HLocate[设备定位 0x96]
            HSettle[结算 0x03]
            HTime[时间 0x22]
        end
    end

    %% 外部连接
    Device -->|TCP| TCPPort
    Client -->|HTTP| HTTPPort
    Admin -->|管理| HTTPPort

    %% 入站链路
    TCPPort --> ZinxAdapter --> DNYDecoder --> CmdManager -->|路由| HReg
    DNYDecoder --> HHB --> TCPManager
    DNYDecoder --> HCharge
    DNYDecoder --> HLocate
    DNYDecoder --> HSettle --> Notifier
    DNYDecoder --> HTime

    %% 出站链路（唯一）
    HTTPPort --> HTTPAdapter --> DeviceGateway --> UnifiedBuilder --> TCPWriter -->|RAW TCP| TCPPort

    %% 资源与状态
    ZinxAdapter --> TCPManager
    DeviceGateway --> TCPManager
    Notifier --> Redis

    %% 样式
    classDef external fill:#e1f5fe
    classDef port fill:#f3e5f5
    classDef adapter fill:#e8f5e8
    classDef gw fill:#fff7e6
    classDef proto fill:#e6f7ff
    classDef core fill:#f1f8e9
    classDef notif fill:#fff0f6
    classDef handler fill:#e0f2f1

    class Device,Client,Admin external
    class TCPPort,HTTPPort port
    class ZinxAdapter,HTTPAdapter adapter
    class DeviceGateway,UnifiedBuilder,TCPWriter gw
    class DNYDecoder,CmdManager proto
    class TCPManager,PortManager core
    class Notifier,Redis notif
    class HReg,HHB,HCharge,HLocate,HSettle,HTime handler
```

---

**图表版本**: v2.0  
**更新时间**: 2025-08-23  
**图表类型**: Mermaid Graph TB  
**关键差异**: 统一出站链路 DeviceGateway→UnifiedDNYBuilder→TCPWriter；通知系统引入 Redis 持久化重试与统计；CommandManager 统一消息ID/超时/重试。
