# å……ç”µè®¾å¤‡ç½‘å…³é…ç½®æ–‡ä»¶
# Gateway Configuration

# TCPæœåŠ¡å™¨é…ç½® (Zinx)
tcpServer:
  # åŸºç¡€é…ç½®
  host: "0.0.0.0" # ç›‘å¬åœ°å€
  port: 7054 # TCPç«¯å£

  # è¶…æ—¶é…ç½® - ä¿®å¤é¢‘ç¹æ–­å¼€é—®é¢˜
  initialReadDeadlineSeconds: 180 # ä¿®å¤ï¼šå¢åŠ åˆ°3åˆ†é’Ÿï¼Œç”¨äºç­‰å¾…ICCID
  defaultReadDeadlineSeconds: 300 # ä¿®å¤ï¼šå¢åŠ åˆ°5åˆ†é’Ÿï¼Œé¿å…ç½‘ç»œæ³¢åŠ¨å¯¼è‡´çš„é¢‘ç¹æ–­å¼€
  tcpWriteTimeoutSeconds: 90 # TCPå†™è¶…æ—¶90ç§’ - ä¼˜åŒ–ï¼šå¢åŠ å†™è¶…æ—¶å‡å°‘è¿æ¥å¤±è´¥
  tcpReadTimeoutSeconds: 300 # TCPè¯»è¶…æ—¶300ç§’ - ä¿®å¤ï¼šä¸ReadDeadlineä¿æŒä¸€è‡´ï¼Œé¿å…i/o timeout

  # ç¼“å†²åŒºé…ç½®
  sendBufferSize: 262144 # å‘é€ç¼“å†²åŒº256KB - ğŸ”§ ä¼˜åŒ–ï¼šå¢åŠ ç¼“å†²åŒºå‡å°‘ç§¯å‹
  receiveBufferSize: 131072 # æ¥æ”¶ç¼“å†²åŒº128KB

  # TCPé€‰é¡¹
  keepAlive: true # å¯ç”¨TCP Keep-Alive
  keepAlivePeriodSeconds: 15 # Keep-Aliveæ¢æµ‹é—´éš”15ç§’ - ä¼˜åŒ–ï¼šæ›´é¢‘ç¹æ£€æµ‹è¿æ¥çŠ¶æ€
  tcpNoDelay: true # ç¦ç”¨Nagleç®—æ³•ï¼Œæé«˜å®æ—¶æ€§

  # é˜Ÿåˆ—é…ç½®
  sendQueueSize: 1024 # å‘é€é˜Ÿåˆ—å¤§å°
  readQueueSize: 1024 # è¯»å–é˜Ÿåˆ—å¤§å°
  writeChannelBuffer: 512 # å†™é€šé“ç¼“å†²åŒº
  readChannelBuffer: 512 # è¯»é€šé“ç¼“å†²åŒº

  # Zinxæ¡†æ¶é…ç½®
  zinx:
    name: "Charging Gateway TCP Server" # æœåŠ¡å™¨åç§°
    version: "1.0" # æœåŠ¡å™¨ç‰ˆæœ¬
    maxConn: 3000 # æœ€å¤§è¿æ¥æ•°
    workerPoolSize: 10 # çº¿ç¨‹æ± å¤§å°
    maxWorkerTaskLen: 1024 # ä»»åŠ¡é˜Ÿåˆ—é•¿åº¦
    maxPacketSize: 2048 # æœ€å¤§æ•°æ®åŒ…å¤§å°

# HTTP APIæœåŠ¡å™¨é…ç½® (Gin)
httpApiServer:
  host: "0.0.0.0"
  port: 7055
  auth:
    sharedKey: "changeme-in-production" # å…±äº«å¯†é’¥ï¼Œç”¨äºBPè®¤è¯
    allowedIPs: ["127.0.0.1", "localhost"] # å…è®¸è®¿é—®çš„IPåˆ—è¡¨
  timeoutSeconds: 30 # è¯·æ±‚è¶…æ—¶æ—¶é—´

# Redisé…ç½®
redis:
  address: "172.18.0.9" # RedisæœåŠ¡å™¨åœ°å€
  password: "123456" # Rediså¯†ç 
  db: 0 # Redisæ•°æ®åº“ç´¢å¼•
  poolSize: 10 # è¿æ¥æ± å¤§å°
  minIdleConns: 5 # æœ€å°ç©ºé—²è¿æ¥æ•°
  dialTimeout: 5 # è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
  readTimeout: 3 # è¯»å–è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
  writeTimeout: 3 # å†™å…¥è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰

# ç»Ÿä¸€æ—¥å¿—é…ç½®
logger:
  # åŸºç¡€é…ç½®
  level: "debug" # æ—¥å¿—çº§åˆ«: trace, debug, info, warn, error, fatal, panic
  format: "json" # è¾“å‡ºæ ¼å¼: json, text
  enableConsole: true # æ˜¯å¦è¾“å‡ºåˆ°æ§åˆ¶å°
  enableStructured: true # æ˜¯å¦å¯ç”¨ç»“æ„åŒ–æ—¥å¿—
  logHexDump: true # æ˜¯å¦è®°å½•åå…­è¿›åˆ¶æ•°æ®

  # æ–‡ä»¶è¾“å‡ºé…ç½®
  enableFile: true # æ˜¯å¦è¾“å‡ºåˆ°æ–‡ä»¶
  fileDir: "./logs" # æ—¥å¿—æ–‡ä»¶ç›®å½•
  filePrefix: "gateway" # æ—¥å¿—æ–‡ä»¶å‰ç¼€

  # è½®è½¬é…ç½®
  rotationType: "daily" # è½®è½¬ç±»å‹: size, daily
  maxSizeMB: 100 # æŒ‰å¤§å°è½®è½¬: æœ€å¤§æ–‡ä»¶å¤§å°(MB)
  maxBackups: 10 # æŒ‰å¤§å°è½®è½¬: æœ€å¤§å¤‡ä»½æ–‡ä»¶æ•°
  maxAgeDays: 30 # ä¿ç•™å¤©æ•°
  compress: true # æ˜¯å¦å‹ç¼©æ—§æ–‡ä»¶

# è¶…æ—¶é…ç½®
timeouts:
  deviceInitSeconds: 30 # è®¾å¤‡åˆå§‹åŒ–è¶…æ—¶æ—¶é—´ï¼Œåœ¨æ­¤æ—¶é—´å†…å¿…é¡»å®ŒæˆICCIDä¸ŠæŠ¥å’Œæ³¨å†Œ
  dnyResponseSeconds: 40 # DNYåè®®å“åº”è¶…æ—¶æ—¶é—´ï¼Œè¶…è¿‡åå°è¯•é‡å‘
  heartbeatIntervalSeconds: 60 # å¿ƒè·³é—´éš”
  linkHeartbeatIntervalSeconds: 30 # "link"å¿ƒè·³é—´éš”

# è®¾å¤‡è¿æ¥é…ç½® - ä¼˜åŒ–ç‰ˆ
deviceConnection:
  # å¿ƒè·³è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰- è¿™æ˜¯ HeartbeatManager ä½¿ç”¨çš„ï¼Œåº”å¤§äº ReadDeadline
  heartbeatTimeoutSeconds: 150 # ä¼˜åŒ–ï¼šè°ƒæ•´ä¸º2.5åˆ†é’Ÿï¼Œé…åˆæ–°çš„ReadDeadline
  # å¿ƒè·³æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰- ä¼˜åŒ–åçš„å¿ƒè·³é¢‘ç‡
  heartbeatIntervalSeconds: 20 # ä¼˜åŒ–ï¼šä»30ç§’è°ƒæ•´ä¸º20ç§’ï¼Œå‡å°‘ç½‘ç»œè´Ÿè½½
  # å¿ƒè·³è­¦å‘Šé˜ˆå€¼ï¼ˆç§’ï¼‰
  heartbeatWarningThreshold: 180 # ä¼˜åŒ–ï¼šè°ƒæ•´ä¸º3åˆ†é’Ÿè­¦å‘Š
  # ä¼šè¯è¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
  sessionTimeoutMinutes: 60 # ä¼šè¯è¶…æ—¶60åˆ†é’Ÿ

  # æ–°å¢ï¼šå·®å¼‚åŒ–è¶…æ—¶ç­–ç•¥
  timeouts:
    # æ³¨å†Œå“åº”è¶…æ—¶ï¼ˆç§’ï¼‰- è®¾å¤‡æ³¨å†Œå¿…é¡»å¿«é€Ÿå“åº”
    registerTimeoutSeconds: 30
    # å¿ƒè·³å“åº”è¶…æ—¶ï¼ˆç§’ï¼‰- å¿ƒè·³åŒ…åº”è¯¥å¿«é€Ÿå¤„ç†
    heartbeatResponseTimeoutSeconds: 10
    # æ•°æ®ä¼ è¾“è¶…æ—¶ï¼ˆç§’ï¼‰- ä¸šåŠ¡æ•°æ®ä¼ è¾“å¯ä»¥ç›¸å¯¹å®½æ¾
    # ä¼˜åŒ–ï¼šå……ç”µæ§åˆ¶å‘½ä»¤éœ€è¦æ›´é•¿è¶…æ—¶ï¼Œåº”å¯¹ç½‘ç»œæ³¢åŠ¨
    dataTransferTimeoutSeconds: 90
    # é»˜è®¤å†™æ“ä½œè¶…æ—¶ï¼ˆç§’ï¼‰- ç”¨äºæœªæ˜ç¡®åˆ†ç±»çš„æ“ä½œ
    # ä¼˜åŒ–ï¼šå¢åŠ é»˜è®¤å†™è¶…æ—¶ï¼Œå‡å°‘TCPå†™è¶…æ—¶é¢‘ç‡
    defaultWriteTimeoutSeconds: 60

# æ–°å¢ï¼šå¿ƒè·³ä¼˜åŒ–é…ç½®
heartbeat:
  # æ ‡å‡†å¿ƒè·³é—´éš”ï¼ˆç§’ï¼‰- ä»5ç§’ä¼˜åŒ–åˆ°20ç§’
  standardInterval: 20
  # Linkå¿ƒè·³é—´éš”ï¼ˆç§’ï¼‰- ä¿æŒ30ç§’
  linkInterval: 30
  # è¯»å–è¶…æ—¶ï¼ˆç§’ï¼‰- ä»5åˆ†é’Ÿä¼˜åŒ–åˆ°2åˆ†é’Ÿ
  readDeadline: 120
  # è‡ªé€‚åº”å¿ƒè·³é…ç½®
  adaptive:
    enabled: true
    minInterval: 15
    maxInterval: 60
    qualityThreshold: 0.8
    latencyThreshold: 500
  # å‘åå…¼å®¹é…ç½®
  compatibility:
    backwardCompatible: true
    legacyHeartbeatEnabled: true

# é‡è¿ç®¡ç†é…ç½® - å·²ç§»é™¤æ‰€æœ‰é™åˆ¶ï¼Œä»…ä¿ç•™ç›‘æ§åŠŸèƒ½
reconnect:
  # å·²ç§»é™¤æ‰€æœ‰é™åˆ¶é…ç½®ï¼ˆæŒ‡æ•°é€€é¿ã€é¢‘ç‡é™åˆ¶ã€é»‘åå•æœºåˆ¶ï¼‰
  # ç´§æ€¥ä¿®å¤ï¼šå®Œå…¨ç§»é™¤é‡è¿é™åˆ¶ï¼Œä¿éšœå……ç”µä¸šåŠ¡è¿ç»­æ€§

  # ä¿ç•™è¿æ¥è´¨é‡è¯„ä¼°é…ç½®ç”¨äºç›‘æ§
  qualityWindow: 10m
  stabilityThreshold: 30s

# è¿æ¥å¥åº·æ£€æŸ¥é…ç½®
healthCheck:
  interval: 60 # å¥åº·æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰
  timeoutThreshold: 180 # è¶…æ—¶é˜ˆå€¼ï¼ˆç§’ï¼‰
  failureThreshold: 3 # è¿ç»­å¤±è´¥é˜ˆå€¼
  enableNetworkDiagnosis: true # å¯ç”¨ç½‘ç»œè¯Šæ–­
  bufferHealthWarningLevel: 0.7 # ç¼“å†²åŒºè­¦å‘Šæ°´ä½
  bufferHealthCriticalLevel: 0.9 # ç¼“å†²åŒºä¸¥é‡æ°´ä½

# å‘é€é‡è¯•é…ç½®
retry:
  maxRetries: 5 # æœ€å¤§é‡è¯•æ¬¡æ•°
  initialDelayMs: 500 # åˆå§‹å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
  maxDelayMs: 5000 # æœ€å¤§å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
  backoffFactor: 1.5 # é€€é¿å› å­
  enableRetryOnTimeout: true # è¶…æ—¶æ—¶å¯ç”¨é‡è¯•
  enableRetryOnNetworkError: true # ç½‘ç»œé”™è¯¯æ—¶å¯ç”¨é‡è¯•

# ç¬¬ä¸‰æ–¹å¹³å°é€šçŸ¥é…ç½®
notification:
  enabled: true # æ˜¯å¦å¯ç”¨é€šçŸ¥ç³»ç»Ÿ
  queue_size: 10000 # é€šçŸ¥é˜Ÿåˆ—å¤§å°
  workers: 5 # å·¥ä½œåç¨‹æ•°

  # ç«¯å£çŠ¶æ€å®æ—¶åŒæ­¥é…ç½®
  port_status_sync:
    enabled: true # æ˜¯å¦å¯ç”¨ç«¯å£çŠ¶æ€å®æ—¶åŒæ­¥
    debounce_interval: "2s" # é˜²æŠ–é—´éš”ï¼Œé¿å…é¢‘ç¹æ¨é€

  # ç«¯ç‚¹é…ç½®
  endpoints:
    # è®¡è´¹ç³»ç»Ÿç«¯ç‚¹
    - name: "billing_system" # ç«¯ç‚¹åç§°
      type: "billing" # ç«¯ç‚¹ç±»å‹: billing, operation
      url: "https://bujia.tyxxtb.com/cdz/chargeCallback" # è®¡è´¹ç³»ç»Ÿå›è°ƒURL
      headers:
        Content-Type: "application/json"
        Authorization: "Bearer ${BILLING_API_TOKEN}"
      timeout: "10s"
      event_types:
        - "device_online" # è®¾å¤‡ä¸Šçº¿
        - "device_offline" # è®¾å¤‡ç¦»çº¿
        - "device_register" # è®¾å¤‡æ³¨å†Œ
        - "charging_start" # å……ç”µå¼€å§‹
        - "charging_end" # å……ç”µç»“æŸ
        - "charging_failed" # å……ç”µå¤±è´¥
        - "charging_power" # å……ç”µåŠŸç‡å®æ—¶æ•°æ®
        - "power_heartbeat" # åŠŸç‡å¿ƒè·³
        - "settlement" # ç»“ç®—
        - "device_error" # è®¾å¤‡é”™è¯¯
        - "port_status_change" # ç«¯å£çŠ¶æ€å˜åŒ–
        - "port_error" # ç«¯å£æ•…éšœ
        - "port_online" # ç«¯å£ä¸Šçº¿
        - "port_offline" # ç«¯å£ç¦»çº¿
        - "device_heartbeat" # è®¾å¤‡å¿ƒè·³
        - "port_heartbeat" # ç«¯å£å¿ƒè·³
        - "charge_modified" # å……ç”µå‚æ•°ä¿®æ”¹
      enabled: true

    # # è¿è¥å¹³å°ç«¯ç‚¹
    # - name: "operation_platform" # ç«¯ç‚¹åç§°
    #   type: "operation" # ç«¯ç‚¹ç±»å‹: billing, operation
    #   url: "https://operation.bujia.tyxxtb.com/api/notifications" # è¿è¥å¹³å°å›è°ƒURL
    #   headers:
    #     Content-Type: "application/json"
    #     X-API-Key: "${OPERATION_API_KEY}"
    #   timeout: "10s"
    #   event_types:
    #     - "device_online" # è®¾å¤‡ä¸Šçº¿
    #     - "device_offline" # è®¾å¤‡ç¦»çº¿
    #     - "device_register" # è®¾å¤‡æ³¨å†Œ
    #     - "device_heartbeat" # è®¾å¤‡å¿ƒè·³
    #     - "device_error" # è®¾å¤‡é”™è¯¯
    #     - "charging_start" # å……ç”µå¼€å§‹
    #     - "charging_end" # å……ç”µç»“æŸ
    #     - "charging_failed" # å……ç”µå¤±è´¥
    #     - "settlement" # ç»“ç®—
    #     - "port_status_change" # ç«¯å£çŠ¶æ€å˜åŒ–
    #     - "port_heartbeat" # ç«¯å£å¿ƒè·³
    #     - "port_error" # ç«¯å£æ•…éšœ
    #     - "port_online" # ç«¯å£ä¸Šçº¿
    #     - "port_offline" # ç«¯å£ç¦»çº¿
    #     - "power_heartbeat" # åŠŸç‡å¿ƒè·³
    #     - "charging_power" # å……ç”µåŠŸç‡å®æ—¶æ•°æ®
    #   enabled: true

  # é‡è¯•é…ç½®
  retry:
    max_attempts: 3
    initial_interval: "1s"
    max_interval: "30s"
    multiplier: 2.0
