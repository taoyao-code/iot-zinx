# 心跳功能实现

## 概述

本次任务实现了一个完整的设备心跳管理系统，用于监控设备连接状态、处理心跳超时和通知相关组件。新的心跳管理系统设计成可扩展的接口形式，支持多种监听器，实现了连接断开管理器。

## 实现内容

1. 创建心跳服务接口和标准实现
2. 设计心跳事件监听器接口
3. 实现连接断开监听器
4. 集成到现有网络系统
5. 支持与旧版心跳管理兼容

## 关键文件

- `pkg/heartbeat/interface.go`: 定义心跳服务接口和事件类型
- `pkg/heartbeat/service.go`: 实现标准心跳服务
- `pkg/heartbeat/connection_listener.go`: 实现连接断开监听器
- `pkg/heartbeat/init.go`: 初始化和注册心跳服务
- `pkg/network/heartbeat.go`: 心跳服务与网络模块集成
- `pkg/export.go`: 导出心跳服务接口供外部使用
- `internal/ports/tcp_server.go`: 在服务器启动时初始化心跳服务

## 技术要点

### 接口设计

心跳服务接口设计为可扩展形式，主要包括：

```go
// HeartbeatService 心跳服务接口，提供心跳相关的核心功能
type HeartbeatService interface {
    // 更新设备活动时间
    UpdateActivity(conn ziface.IConnection)
    
    // 注册和注销心跳事件监听器
    RegisterListener(listener HeartbeatListener)
    UnregisterListener(listener HeartbeatListener)
    
    // 启动和停止心跳监控服务
    Start() error
    Stop()
    
    // 获取和设置心跳参数
    GetLastActivity(connID uint64) (time.Time, bool)
    IsConnActive(connID uint64) bool
    GetTimeoutDuration() time.Duration
    SetTimeoutDuration(duration time.Duration)
    GetCheckInterval() time.Duration
    SetCheckInterval(interval time.Duration)
}
```

### 心跳事件

定义了两种主要事件：

1. `HeartbeatEvent`: 收到设备心跳时触发
2. `HeartbeatTimeoutEvent`: 设备心跳超时时触发

### 适配器模式

为避免循环依赖，使用适配器模式连接不同组件：

```go
// 心跳服务适配器
type heartbeatServiceAdapter struct {
    service HeartbeatService
}

// 连接监控适配器
type connectionMonitorAdapter struct {
    monitor monitor.IConnectionMonitor
}
```

### 全局实例管理

提供全局心跳服务实例，方便系统各组件访问：

```go
// 获取全局心跳服务实例
var GetGlobalHeartbeatService func() HeartbeatService

// 设置全局心跳服务实例
var SetGlobalHeartbeatService func(service HeartbeatService)
```

## 使用方式

1. 更新设备活动时间：

```go
// 在接收到任何有效数据包时调用
pkg.Network.UpdateConnectionActivity(conn)
```

2. 注册心跳监听器：

```go
listener := pkg.Heartbeat.NewConnectionDisconnector(monitor)
service := pkg.Heartbeat.GetHeartbeatService()
service.RegisterListener(listener)
```

3. 配置心跳参数：

```go
service := pkg.Heartbeat.GetHeartbeatService()
service.SetTimeoutDuration(5 * time.Minute)
service.SetCheckInterval(30 * time.Second)
```

## 兼容性

新心跳系统保持对旧版心跳管理器的兼容，可同时工作：

```go
// 同时兼容新旧系统
func UpdateConnectionActivity(conn ziface.IConnection) {
    // 优先使用新版心跳服务
    if GlobalHeartbeatService != nil {
        GlobalHeartbeatService.UpdateActivity(conn)
    }
    
    // 同时保持对旧系统的兼容
    if GlobalHeartbeatManager != nil {
        GlobalHeartbeatManager.UpdateConnectionActivity(conn)
    }
}
```

## 后续优化方向

1. 增加更多类型的心跳监听器，如数据统计监听器
2. 实现更细粒度的心跳超时策略
3. 为不同设备类型设置不同的心跳参数 