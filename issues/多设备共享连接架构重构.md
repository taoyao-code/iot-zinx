# 多设备共享连接架构重构任务

## 上下文

基于文档分析，系统应支持一个 TCP 连接管理多个设备的架构模式：

- 一个通信模块通过 TCP 连接到服务器
- 该通信模块可管理多个分机设备（通过 485 总线或无线）
- 需要实现主设备选举、状态一致性、原子性操作

## 执行计划

### 阶段 1：核心架构重构

1. 连接设备组管理器设计
2. TCPMonitor 重构
3. SessionManager 适配

### 阶段 2：协议处理层重构

4. ICCID 处理器优化
5. 设备注册处理器重构
6. 心跳处理器重构

### 阶段 3：网络层优化

7. 写缓冲区监控增强
8. 连接健康检查优化

### 阶段 4：状态管理统一

9. 全局状态管理器
10. 设备组管理器集成

### 阶段 5：错误处理和恢复

11. 连接切换机制重构
12. 异常恢复机制

## 关键原则

- 保障业务流程完整性
- 确保数据状态一致性
- 保障所有操作原子性
- 不考虑向后兼容性
