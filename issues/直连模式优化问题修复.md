# 直连模式优化问题修复

## 发现的问题

通过日志分析，我们发现了直连模式实现中的几个关键问题：

1. **分机设备未找到主机连接警告频繁**：在直连模式下，系统仍然尝试查找主机连接，导致大量警告日志。

2. **连接断开后的命令重发错误**：当设备连接断开后，系统仍然尝试重发命令，导致"use of closed network connection"错误。

3. **设备重复注册**：分机设备频繁发送注册包，即使已经成功注册，造成不必要的网络流量和处理负担。

4. **设备连接状态和映射同步问题**：设备断开连接时，可能出现会话管理和连接管理不同步的情况。

## 修复内容

### 1. 优化直连模式下的连接选择逻辑

修改 `pkg/protocol/sender.go` 中的 `getActualConnectionForDevice` 方法：

- 当检测到直连模式时，直接使用当前连接发送数据，不再尝试查找主机连接
- 将分机设备未找到主机连接的警告降级为调试日志，避免频繁警告
- 当检测到分机设备使用原连接发送数据时，自动标记为直连模式，避免重复查找和警告

### 2. 加强命令重发的连接状态检查

修改 `pkg/network/command_manager.go` 中的命令超时重发逻辑：

- 在重发命令前，增加连接有效性检查，包括空连接检查和连接状态检查
- 对于已关闭或不活跃的连接，跳过命令重发并清理相关命令
- 优化连接命令清理逻辑，确保在连接断开时正确清理所有相关命令

### 3. 优化分机设备注册逻辑

修改 `pkg/monitor/tcp_monitor.go` 中的 `handleSlaveDeviceBinding` 方法：

- 添加设备重复注册检查，避免同一设备在同一连接上重复注册
- 对于已注册设备，仅更新心跳时间，不再执行完整的注册流程
- 减少重复注册的日志输出，降低日志压力

### 4. 设备断开连接处理优化

修改 `pkg/monitor/device_monitor.go` 中的 `OnDeviceDisconnect` 方法：

- 在直连模式下，对未找到会话的情况降级为调试日志，而不是警告
- 增强会话与连接状态的同步，确保设备断开连接时状态一致性

## 影响分析

1. **日志量减少**：减少了大量不必要的警告日志，提高了日志可读性和系统性能。

2. **网络流量优化**：避免了重复注册和无效重发，减少了网络流量和服务器负载。

3. **错误减少**：有效避免了对已关闭连接的操作，减少了相关错误。

4. **直连模式更稳定**：完善了直连模式实现，使分机设备可以更可靠地直接与服务器通信。

## 测试结果

系统编译成功，经过测试，分机设备能够正常直连服务器，并且不再产生大量警告日志。设备状态更新和命令发送更为稳定可靠。 