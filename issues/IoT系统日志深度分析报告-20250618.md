# IoT ç³»ç»Ÿæ—¥å¿—æ·±åº¦åˆ†ææŠ¥å‘Š

**åˆ†ææ—¶é—´**: 2025 å¹´ 6 æœˆ 18 æ—¥  
**æ—¥å¿—æ—¶é—´èŒƒå›´**: 18:06:05 - 18:16:34 (çº¦ 10 åˆ†é’Ÿ)  
**ç³»ç»Ÿ**: åŸºäº Zinx æ¡†æ¶çš„ IoT ç½‘å…³ç³»ç»Ÿ

## ğŸ“Š **ç³»ç»Ÿæ¦‚è§ˆ**

è¿™æ˜¯ä¸€ä¸ªåŸºäº Zinx æ¡†æ¶çš„ IoT ç½‘å…³ç³»ç»Ÿæ—¥å¿—ï¼Œæ—¶é—´è·¨åº¦ä¸º**18:06:05**è‡³**18:16:34**ï¼ˆçº¦ 10 åˆ†é’Ÿï¼‰ï¼Œå±•ç°äº†å…¸å‹çš„ç‰©è”ç½‘è®¾å¤‡é€šä¿¡æ¨¡å¼ã€‚

## ğŸ” **æ—¥å¿—åˆ†ç±»è¯¦è§£**

### 1. **åè®®è§£ææ—¥å¿—**

```
INFO[22320] è§£ç å™¨ï¼šæˆåŠŸè§£æDNYæ ‡å‡†åè®®å¸§ connID=54 frameLen=34
{"level":"debug","msg":"read buffer 444e591d00cd28a2048700018002120902...","source":"zinx"}
```

- **DNY æ ‡å‡†åè®®å¸§**ï¼šè‡ªå®šä¹‰ IoT é€šä¿¡åè®®
- **Link å¿ƒè·³åŒ…**ï¼šASCII "link" å­—ç¬¦ä¸²ä½œä¸ºä¿æ´»æœºåˆ¶
- **ICCID æ¶ˆæ¯**ï¼šSIM å¡èº«ä»½éªŒè¯æ•°æ®

### 2. **è®¾å¤‡å¿ƒè·³ç®¡ç†**

```
INFO[22320] è®¾å¤‡å¿ƒè·³å¤„ç†å®Œæˆ connID=54 deviceId=898604D9162390488297
```

- **å¿ƒè·³é¢‘ç‡**ï¼šçº¦ 5 ç§’é—´éš”
- **å¿ƒè·³ç±»å‹**ï¼š0x01, 0x21 (ä¸åŒç±»å‹çš„å¿ƒè·³å‘½ä»¤)
- **è®¾å¤‡æ ‡è¯†**ï¼šç‰©ç† ID(04A228CD, 04A26CF3) + ICCID(898604D9162390488297)

### 3. **è¿æ¥ç”Ÿå‘½å‘¨æœŸ**

```
INFO[22565] ğŸ”— æ–°è¿æ¥å·²å»ºç«‹ï¼Œè®¾ç½®åˆå§‹è¯»å–è¶…æ—¶ï¼Œç­‰å¾…ICCID connID=55
INFO[22576] è®¾å¤‡è¿æ¥æ–­å¼€ connID=54 sessionDuration=7m23.155630699s
```

## ğŸ—ï¸ **ç³»ç»Ÿæ¶æ„åˆ†æ**

### **å…³é”®ç»„ä»¶**ï¼š

- **SessionManager**ï¼šè®¾å¤‡ä¼šè¯ç®¡ç†ï¼Œæ”¯æŒæ–­çº¿é‡è¿
- **TCPMonitor**ï¼šTCP è¿æ¥ç›‘æ§å’Œè®¾å¤‡ç»‘å®š
- **DeviceGroupManager**ï¼šè®¾å¤‡åˆ†ç»„ç®¡ç†(å½“å‰ç»„å¤§å°=2)
- **DNY åè®®è§£æå™¨**ï¼šè‡ªå®šä¹‰åè®®æ ˆ

### **è®¾å¤‡ä¿¡æ¯**ï¼š

| å±æ€§       | å€¼                   |
| ---------- | -------------------- |
| ICCID      | 898604D9162390488297 |
| ç‰©ç†è®¾å¤‡ 1 | 04A228CD             |
| ç‰©ç†è®¾å¤‡ 2 | 04A26CF3             |
| è¿æ¥åœ°å€ 1 | 39.144.229.218:12099 |
| è¿æ¥åœ°å€ 2 | 39.144.229.132:42049 |
| æœåŠ¡å™¨     | 10.5.0.10:7054       |

## ğŸ“¡ **DNY åè®®å‘½ä»¤åˆ†æ**

| å‘½ä»¤ç  | åŠŸèƒ½             | ç¤ºä¾‹æ•°æ®                          |
| ------ | ---------------- | --------------------------------- |
| 0x01   | è®¾å¤‡å¿ƒè·³         | `444e591d00cd28a2048700018002...` |
| 0x20   | è®¾å¤‡æ³¨å†Œ         | `444e590f00cd28a2048f00208002...` |
| 0x21   | å¿ƒè·³å“åº”         | `444e591000cd28a2048c002118...`   |
| 0x22   | è·å–æœåŠ¡å™¨æ—¶é—´   | `444e590d00cd28a204920022e2...`   |
| 0x11   | ä¸»æœºå¿ƒè·³         | åŒ…å«è®¾å¤‡çŠ¶æ€ä¿¡æ¯                  |
| 0x81   | æŸ¥è¯¢è®¾å¤‡è”ç½‘çŠ¶æ€ | ç½‘ç»œçŠ¶æ€æ£€æŸ¥                      |

## âš ï¸ **é—®é¢˜è¯Šæ–­**

### **ä¸»è¦é—®é¢˜**ï¼š

```
ERROR SendMsg err data = [0 0 0 0 0 0 0 1 0], err = write tcp4 10.5.0.10:7054->39.144.229.218:12099: i/o timeout
WARN[22440] å‘ç°ä¸å¥åº·è¿æ¥ issues="[è®¾å¤‡çŠ¶æ€å¼‚å¸¸: active_registered å†™ç¼“å†²åŒºä¸å¥åº·: è®¾å¤‡ä¸åœ¨çº¿]"
```

### **é—®é¢˜åˆ†æ**ï¼š

1. **ç½‘ç»œ I/O è¶…æ—¶**ï¼šé¢‘ç¹çš„å†™æ“ä½œè¶…æ—¶ï¼Œå½±å“æ•°æ®å‘é€
2. **è¿æ¥ä¸ç¨³å®š**ï¼šéœ€è¦è¿æ¥ä»åœ°å€ 1 åˆ‡æ¢åˆ°åœ°å€ 2
3. **å†™ç¼“å†²åŒºå¼‚å¸¸**ï¼šç¼“å†²åŒºå¥åº·çŠ¶æ€éœ€è¦ä¼˜åŒ–

### **æ¢å¤æœºåˆ¶**ï¼š

- **è‡ªåŠ¨é‡è¿**ï¼šé‡è¿æ¬¡æ•°ä» 278 å¢é•¿åˆ° 288+
- **ä¼šè¯æ¢å¤**ï¼šç›¸åŒ sessionID ç»´æŒè®¾å¤‡çŠ¶æ€
- **è¿æ¥è¿ç§»**ï¼šä» connID=54 è¿ç§»åˆ° connID=55

## ğŸ”„ **ä¸šåŠ¡æµç¨‹æ—¶åº**

```
1. TCPè¿æ¥å»ºç«‹ â†’ 2. ICCIDéªŒè¯ â†’ 3. è®¾å¤‡æ³¨å†Œ â†’ 4. ä¼šè¯ç»‘å®š â†’ 5. æŒç»­é€šä¿¡
   â†“                 â†“              â†“             â†“              â†“
è¿æ¥ç®¡ç†å™¨æ·»åŠ       SimCardå¤„ç†     æ³¨å†Œå¤„ç†å™¨    TCPMonitor     å¿ƒè·³+æ—¶é—´åŒæ­¥
```

## ğŸ“ˆ **æ€§èƒ½æŒ‡æ ‡**

- **è¿æ¥å¹¶å‘æ•°**ï¼š2 ä¸ªæ´»è·ƒ TCP è¿æ¥
- **è®¾å¤‡æ•°é‡**ï¼š2 ä¸ªç‰©ç†è®¾å¤‡å…±äº« 1 ä¸ª ICCID
- **å¿ƒè·³æˆåŠŸç‡**ï¼šé«˜ï¼ˆå¤§éƒ¨åˆ†å¿ƒè·³æ­£å¸¸å¤„ç†ï¼‰
- **é‡è¿æˆåŠŸç‡**ï¼šé«˜ï¼ˆè‡ªåŠ¨æ¢å¤æœºåˆ¶æœ‰æ•ˆï¼‰
- **å¥åº·æ£€æŸ¥é¢‘ç‡**ï¼šæ¯ 2 åˆ†é’Ÿ

## ğŸ”§ **ä¿®å¤ç›®æ ‡**

æ ¹æ®æ—¥å¿—åˆ†æï¼Œéœ€è¦ä¿®å¤çš„æ ¸å¿ƒé—®é¢˜ï¼š

1. **ç½‘ç»œ I/O è¶…æ—¶é¢‘ç¹å‘ç”Ÿ**

   - ç—‡çŠ¶ï¼š`write tcp4 10.5.0.10:7054->39.144.229.218:12099: i/o timeout`
   - å½±å“ï¼šæ•°æ®å‘é€å¤±è´¥ï¼Œè¿æ¥ä¸ç¨³å®š

2. **å†™ç¼“å†²åŒºå¥åº·çŠ¶æ€å¼‚å¸¸**

   - ç—‡çŠ¶ï¼š`å†™ç¼“å†²åŒºä¸å¥åº·: è®¾å¤‡ä¸åœ¨çº¿`
   - å½±å“ï¼šè¿æ¥è¢«æ ‡è®°ä¸ºä¸å¥åº·

3. **è¿æ¥å†™å‡ºå™¨å¼‚å¸¸é€€å‡º**
   - ç—‡çŠ¶ï¼š`Conn Writer exit`
   - å½±å“ï¼šè¿æ¥æ•°æ®å‘é€èƒ½åŠ›ä¸§å¤±

## ğŸ“‹ **ä¿®å¤æ–¹æ¡ˆæ¦‚è¿°**

éœ€è¦ä»ä»¥ä¸‹å‡ ä¸ªå±‚é¢è¿›è¡Œä¿®å¤ï¼š

- **ç½‘ç»œå±‚é…ç½®ä¼˜åŒ–**ï¼šè°ƒæ•´è¶…æ—¶å‚æ•°å’Œç¼“å†²åŒºè®¾ç½®
- **åè®®å±‚æ”¹è¿›**ï¼šä¼˜åŒ–æ•°æ®å‘é€ç­–ç•¥å’Œé‡è¯•æœºåˆ¶
- **åº”ç”¨å±‚å¢å¼º**ï¼šæ”¹è¿›è¿æ¥å¥åº·æ£€æŸ¥å’Œé”™è¯¯å¤„ç†é€»è¾‘

---

# ğŸ”§ IoT ç³»ç»Ÿç½‘ç»œé—®é¢˜ä¿®å¤è®¡åˆ’

## ğŸ“‹ ä¿®å¤ç›®æ ‡

**æ ¸å¿ƒé—®é¢˜**ï¼š

1. TCP å†™æ“ä½œé¢‘ç¹è¶…æ—¶å¯¼è‡´è¿æ¥ä¸ç¨³å®š
2. å†™ç¼“å†²åŒºå¼‚å¸¸é€€å‡ºå½±å“æ•°æ®ä¼ è¾“
3. è¿æ¥å¥åº·æ£€æŸ¥è¯¯æŠ¥å¯¼è‡´è¯¯åˆ¤

**æˆåŠŸæ ‡å‡†**ï¼š

- âœ… æ¶ˆé™¤æ‰€æœ‰ `i/o timeout` é”™è¯¯æ—¥å¿—
- âœ… å†™ç¼“å†²åŒºç¨³å®šè¿è¡Œï¼Œæ—  `Conn Writer exit` å¼‚å¸¸
- âœ… è¿æ¥å¥åº·æ£€æŸ¥å‡†ç¡®åæ˜ è®¾å¤‡çœŸå®çŠ¶æ€
- âœ… ç³»ç»Ÿè¿ç»­ç¨³å®šè¿è¡Œ 24 å°æ—¶ä»¥ä¸Š

## ğŸ› ï¸ è¯¦ç»†ä¿®å¤æ­¥éª¤

### æ­¥éª¤ 1: ç½‘ç»œå±‚é…ç½®ä¼˜åŒ– ã€ä¼˜å…ˆçº§ï¼šé«˜ã€‘

**ç›®æ ‡**: è§£å†³ TCP å†™è¶…æ—¶é¢‘ç¹å‘ç”Ÿçš„é—®é¢˜

**æ“ä½œæ–‡ä»¶**:

- `conf/zinx.json`
- `internal/infrastructure/zinx_server/`

**å…·ä½“ä¿®æ”¹**:

```json
// è°ƒæ•´ç½‘ç»œè¶…æ—¶é…ç½®
{
  "TCPWriteTimeout": "60s", // ä»é»˜è®¤å¢åŠ åˆ°60ç§’
  "TCPReadTimeout": "300s", // è¯»è¶…æ—¶ä¿æŒ5åˆ†é’Ÿ
  "SendBufferSize": 131072, // å‘é€ç¼“å†²åŒºå¢åŠ åˆ°128KB
  "ReceiveBufferSize": 131072, // æ¥æ”¶ç¼“å†²åŒºå¢åŠ åˆ°128KB
  "KeepAlive": true, // å¯ç”¨TCP Keep-Alive
  "KeepAlivePeriod": "30s" // Keep-Aliveæ¢æµ‹é—´éš”
}
```

**é¢„æœŸæ•ˆæœ**: å‡å°‘ç½‘ç»œå»¶è¿Ÿå¯¼è‡´çš„å†™è¶…æ—¶ï¼Œæé«˜è¿æ¥ç¨³å®šæ€§

### æ­¥éª¤ 2: å†™ç¼“å†²åŒºç®¡ç†ä¿®å¤ ã€ä¼˜å…ˆçº§ï¼šé«˜ã€‘

**ç›®æ ‡**: ä¿®å¤å†™åç¨‹å¼‚å¸¸é€€å‡ºé—®é¢˜

**æ“ä½œæ–‡ä»¶**:

- `pkg/network/write_buffer_monitor.go`
- `pkg/protocol/sender.go`

**å…·ä½“ä¿®æ”¹**:

1. **æ·»åŠ å†™åç¨‹å¼‚å¸¸æ¢å¤æœºåˆ¶**

```go
// åœ¨å†™åç¨‹ä¸­æ·»åŠ panicæ¢å¤
defer func() {
    if r := recover(); r != nil {
        log.Errorf("Writer goroutine panic recovered: %v", r)
        // é‡å¯å†™åç¨‹
        go c.startWriter()
    }
}()
```

2. **å®ç°å†™ç¼“å†²åŒºçŠ¶æ€ç›‘æ§**

```go
// æ·»åŠ ç¼“å†²åŒºå¥åº·æ£€æŸ¥
type BufferHealthChecker struct {
    maxQueueSize   int
    warningLevel   float64
    criticalLevel  float64
}

func (bhc *BufferHealthChecker) CheckHealth(queueSize int) BufferHealth {
    usage := float64(queueSize) / float64(bhc.maxQueueSize)
    if usage > bhc.criticalLevel {
        return BufferCritical
    } else if usage > bhc.warningLevel {
        return BufferWarning
    }
    return BufferHealthy
}
```

**é¢„æœŸæ•ˆæœ**: å†™åç¨‹ç¨³å®šè¿è¡Œï¼Œç¼“å†²åŒºæº¢å‡ºæ—¶ä¼˜é›…å¤„ç†

### æ­¥éª¤ 3: æ•°æ®å‘é€å™¨é‡æ„ ã€ä¼˜å…ˆçº§ï¼šé«˜ã€‘

**ç›®æ ‡**: å®ç°å¯é çš„æ•°æ®å‘é€æœºåˆ¶

**æ“ä½œæ–‡ä»¶**:

- `pkg/protocol/sender.go`
- `pkg/network/monitoring_manager.go`

**å…·ä½“ä¿®æ”¹**:

1. **æ·»åŠ å‘é€é‡è¯•æœºåˆ¶**

```go
type RetryConfig struct {
    MaxRetries    int           // æœ€å¤§é‡è¯•æ¬¡æ•°
    InitialDelay  time.Duration // åˆå§‹å»¶è¿Ÿ
    MaxDelay      time.Duration // æœ€å¤§å»¶è¿Ÿ
    BackoffFactor float64       // é€€é¿å› å­
}

func (s *Sender) sendWithRetry(data []byte, config RetryConfig) error {
    var lastErr error
    delay := config.InitialDelay

    for i := 0; i <= config.MaxRetries; i++ {
        if err := s.directSend(data); err != nil {
            lastErr = err
            if i < config.MaxRetries {
                time.Sleep(delay)
                delay = time.Duration(float64(delay) * config.BackoffFactor)
                if delay > config.MaxDelay {
                    delay = config.MaxDelay
                }
            }
        } else {
            return nil // å‘é€æˆåŠŸ
        }
    }
    return lastErr
}
```

**é¢„æœŸæ•ˆæœ**: æé«˜æ•°æ®ä¼ è¾“æˆåŠŸç‡ï¼Œå‡å°‘å› ç½‘ç»œæ³¢åŠ¨å¯¼è‡´çš„å‘é€å¤±è´¥

### æ­¥éª¤ 4: è¿æ¥å¥åº·æ£€æŸ¥ä¿®æ­£ ã€ä¼˜å…ˆçº§ï¼šä¸­ã€‘

**ç›®æ ‡**: ä¿®æ­£è¿æ¥å¥åº·æ£€æŸ¥çš„è¯¯åˆ¤é—®é¢˜

**æ“ä½œæ–‡ä»¶**:

- `pkg/network/connection_health_checker.go`
- `pkg/monitor/tcp_monitor.go`

**å…·ä½“ä¿®æ”¹**:

1. **æ”¹è¿›å¥åº·åˆ¤æ–­é€»è¾‘**

```go
type ConnectionHealth struct {
    IsOnline              bool
    LastSuccessfulSend    time.Time
    LastSuccessfulReceive time.Time
    ConsecutiveFailures   int
}

func (c *Connection) assessHealth() ConnectionHealth {
    now := time.Now()
    health := ConnectionHealth{
        LastSuccessfulSend:    c.lastSuccessfulSend,
        LastSuccessfulReceive: c.lastSuccessfulReceive,
        ConsecutiveFailures:   c.consecutiveFailures,
    }

    // åŸºäºå¤šä¸ªç»´åº¦è¯„ä¼°å¥åº·çŠ¶æ€
    sendTimeout := now.Sub(health.LastSuccessfulSend) > 2*time.Minute
    receiveTimeout := now.Sub(health.LastSuccessfulReceive) > 5*time.Minute
    tooManyFailures := health.ConsecutiveFailures > 5

    health.IsOnline = !(sendTimeout || receiveTimeout || tooManyFailures)
    return health
}
```

**é¢„æœŸæ•ˆæœ**: å‡†ç¡®è¯†åˆ«è¿æ¥çŠ¶æ€ï¼Œå‡å°‘è¯¯æŠ¥å’Œæ¼æŠ¥

## ğŸ§ª éªŒè¯æµ‹è¯•æ–¹æ¡ˆ

### 1. å•å…ƒæµ‹è¯•

- å†™ç¼“å†²åŒºå¼‚å¸¸æ¢å¤æµ‹è¯•
- å‘é€é‡è¯•æœºåˆ¶æµ‹è¯•
- å¥åº·æ£€æŸ¥é€»è¾‘æµ‹è¯•

### 2. é›†æˆæµ‹è¯•

- æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿå’Œä¸¢åŒ…åœºæ™¯
- é•¿æ—¶é—´ç¨³å®šæ€§æµ‹è¯•
- è®¾å¤‡é‡è¿æµ‹è¯•

### 3. å‹åŠ›æµ‹è¯•

- é«˜å¹¶å‘è¿æ¥æµ‹è¯•
- å¤§é‡æ•°æ®ä¼ è¾“æµ‹è¯•
- èµ„æºæ¶ˆè€—ç›‘æ§

## ğŸ“… æ‰§è¡Œæ—¶é—´å®‰æ’

| æ­¥éª¤                 | é¢„ä¼°æ—¶é—´    | è´Ÿè´£æ¨¡å—          |
| -------------------- | ----------- | ----------------- |
| æ­¥éª¤ 1: ç½‘ç»œé…ç½®ä¼˜åŒ– | 2 å°æ—¶      | é…ç½®æ–‡ä»¶ + ç½‘ç»œå±‚ |
| æ­¥éª¤ 2: å†™ç¼“å†²åŒºä¿®å¤ | 4 å°æ—¶      | ç½‘ç»œå±‚ + åè®®å±‚   |
| æ­¥éª¤ 3: å‘é€å™¨é‡æ„   | 6 å°æ—¶      | åè®®å±‚            |
| æ­¥éª¤ 4: å¥åº·æ£€æŸ¥ä¿®æ­£ | 3 å°æ—¶      | ç›‘æ§å±‚            |
| éªŒè¯æµ‹è¯•             | 4 å°æ—¶      | å…¨ç³»ç»Ÿ            |
| **æ€»è®¡**             | **19 å°æ—¶** |                   |

## âœ… ä¿®å¤å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] é…ç½®æ–‡ä»¶ä¿®æ”¹å®Œæˆå¹¶éªŒè¯
- [ ] å†™ç¼“å†²åŒºç›‘æ§ä»£ç ä¿®æ”¹å®Œæˆ
- [ ] å‘é€å™¨é‡è¯•æœºåˆ¶å®ç°å®Œæˆ
- [ ] å¥åº·æ£€æŸ¥é€»è¾‘ä¿®æ­£å®Œæˆ
- [ ] å•å…ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] é›†æˆæµ‹è¯•éªŒè¯æˆåŠŸ
- [ ] å‹åŠ›æµ‹è¯•æ€§èƒ½è¾¾æ ‡
- [ ] 24 å°æ—¶ç¨³å®šæ€§æµ‹è¯•é€šè¿‡
- [ ] æ—¥å¿—ç¡®è®¤é—®é¢˜è§£å†³

---

_æŠ¥å‘Šç”Ÿæˆæ—¶é—´: 2025-06-18_

# ğŸ”§ IoT ç³»ç»Ÿç½‘ç»œé—®é¢˜ä¿®å¤è®¡åˆ’

## ğŸ“‹ ä¿®å¤ç›®æ ‡

**æ ¸å¿ƒé—®é¢˜**ï¼š

1. TCP å†™æ“ä½œé¢‘ç¹è¶…æ—¶å¯¼è‡´è¿æ¥ä¸ç¨³å®š
2. å†™ç¼“å†²åŒºå¼‚å¸¸é€€å‡ºå½±å“æ•°æ®ä¼ è¾“
3. è¿æ¥å¥åº·æ£€æŸ¥è¯¯æŠ¥å¯¼è‡´è¯¯åˆ¤

**æˆåŠŸæ ‡å‡†**ï¼š

- âœ… æ¶ˆé™¤æ‰€æœ‰ `i/o timeout` é”™è¯¯æ—¥å¿—
- âœ… å†™ç¼“å†²åŒºç¨³å®šè¿è¡Œï¼Œæ—  `Conn Writer exit` å¼‚å¸¸
- âœ… è¿æ¥å¥åº·æ£€æŸ¥å‡†ç¡®åæ˜ è®¾å¤‡çœŸå®çŠ¶æ€
- âœ… ç³»ç»Ÿè¿ç»­ç¨³å®šè¿è¡Œ 24 å°æ—¶ä»¥ä¸Š

## ğŸ› ï¸ è¯¦ç»†ä¿®å¤æ­¥éª¤

### âœ… æ­¥éª¤ 1: ç½‘ç»œå±‚é…ç½®ä¼˜åŒ– ã€å·²å®Œæˆã€‘

**ç›®æ ‡**: è§£å†³ TCP å†™è¶…æ—¶é¢‘ç¹å‘ç”Ÿçš„é—®é¢˜

**å·²ä¿®æ”¹æ–‡ä»¶**:

- `conf/zinx.json` âœ…
- `configs/gateway.yaml` âœ…

**å…·ä½“ä¿®æ”¹å†…å®¹**:

**zinx.json é…ç½®ä¼˜åŒ–**:

```json
{
  "TCPWriteTimeout": "60s", // å†™è¶…æ—¶å¢åŠ åˆ°60ç§’
  "TCPReadTimeout": "300s", // è¯»è¶…æ—¶ä¿æŒ5åˆ†é’Ÿ
  "SendBufferSize": 131072, // å‘é€ç¼“å†²åŒº128KB
  "ReceiveBufferSize": 131072, // æ¥æ”¶ç¼“å†²åŒº128KB
  "KeepAlive": true, // å¯ç”¨TCP Keep-Alive
  "KeepAlivePeriod": "30s", // Keep-Aliveæ¢æµ‹é—´éš”
  "TCPNoDelay": true, // ç¦ç”¨Nagleç®—æ³•
  "SendQueueSize": 1024, // å‘é€é˜Ÿåˆ—å¤§å°
  "ReadQueueSize": 1024, // è¯»å–é˜Ÿåˆ—å¤§å°
  "WriteChannelBuffer": 512, // å†™é€šé“ç¼“å†²åŒº
  "ReadChannelBuffer": 512 // è¯»é€šé“ç¼“å†²åŒº
}
```

**gateway.yaml åŒæ­¥é…ç½®**:

```yaml
tcpServer:
  tcpWriteTimeoutSeconds: 60 # TCPå†™è¶…æ—¶60ç§’
  tcpReadTimeoutSeconds: 300 # TCPè¯»è¶…æ—¶300ç§’
  sendBufferSize: 131072 # å‘é€ç¼“å†²åŒº128KB
  receiveBufferSize: 131072 # æ¥æ”¶ç¼“å†²åŒº128KB
  keepAlive: true # å¯ç”¨TCP Keep-Alive
  keepAlivePeriodSeconds: 30 # Keep-Aliveæ¢æµ‹é—´éš”30ç§’
  tcpNoDelay: true # ç¦ç”¨Nagleç®—æ³•
  sendQueueSize: 1024 # å‘é€é˜Ÿåˆ—å¤§å°
  readQueueSize: 1024 # è¯»å–é˜Ÿåˆ—å¤§å°
  writeChannelBuffer: 512 # å†™é€šé“ç¼“å†²åŒº
  readChannelBuffer: 512 # è¯»é€šé“ç¼“å†²åŒº

healthCheck:
  interval: 120 # å¥åº·æ£€æŸ¥é—´éš”2åˆ†é’Ÿ
  timeoutThreshold: 300 # è¶…æ—¶é˜ˆå€¼5åˆ†é’Ÿ
  failureThreshold: 5 # è¿ç»­å¤±è´¥é˜ˆå€¼

retry:
  maxRetries: 3 # æœ€å¤§é‡è¯•æ¬¡æ•°
  initialDelayMs: 1000 # åˆå§‹å»¶è¿Ÿ1ç§’
  maxDelayMs: 10000 # æœ€å¤§å»¶è¿Ÿ10ç§’
  backoffFactor: 2.0 # é€€é¿å› å­
```

**é¢„æœŸæ•ˆæœ**: âœ… å‡å°‘ç½‘ç»œå»¶è¿Ÿå¯¼è‡´çš„å†™è¶…æ—¶ï¼Œæé«˜è¿æ¥ç¨³å®šæ€§

# ğŸ”§ IoT ç³»ç»Ÿç½‘ç»œé—®é¢˜ä¿®å¤è®¡åˆ’

## ğŸ“‹ ä¿®å¤ç›®æ ‡

**æ ¸å¿ƒé—®é¢˜**ï¼š

1. TCP å†™æ“ä½œé¢‘ç¹è¶…æ—¶å¯¼è‡´è¿æ¥ä¸ç¨³å®š
2. å†™ç¼“å†²åŒºå¼‚å¸¸é€€å‡ºå½±å“æ•°æ®ä¼ è¾“
3. è¿æ¥å¥åº·æ£€æŸ¥è¯¯æŠ¥å¯¼è‡´è¯¯åˆ¤

**æˆåŠŸæ ‡å‡†**ï¼š

- âœ… æ¶ˆé™¤æ‰€æœ‰ `i/o timeout` é”™è¯¯æ—¥å¿—
- âœ… å†™ç¼“å†²åŒºç¨³å®šè¿è¡Œï¼Œæ—  `Conn Writer exit` å¼‚å¸¸
- âœ… è¿æ¥å¥åº·æ£€æŸ¥å‡†ç¡®åæ˜ è®¾å¤‡çœŸå®çŠ¶æ€
- âœ… ç³»ç»Ÿè¿ç»­ç¨³å®šè¿è¡Œ 24 å°æ—¶ä»¥ä¸Š

## ğŸ› ï¸ è¯¦ç»†ä¿®å¤æ­¥éª¤

### æ­¥éª¤ 1: ç½‘ç»œå±‚é…ç½®ä¼˜åŒ– ã€ä¼˜å…ˆçº§ï¼šé«˜ã€‘

**ç›®æ ‡**: è§£å†³ TCP å†™è¶…æ—¶é¢‘ç¹å‘ç”Ÿçš„é—®é¢˜

**æ“ä½œæ–‡ä»¶**:

- `conf/zinx.json`
- `internal/infrastructure/zinx_server/`

**å…·ä½“ä¿®æ”¹**:

```json
// è°ƒæ•´ç½‘ç»œè¶…æ—¶é…ç½®
{
  "TCPWriteTimeout": "60s", // ä»é»˜è®¤å¢åŠ åˆ°60ç§’
  "TCPReadTimeout": "300s", // è¯»è¶…æ—¶ä¿æŒ5åˆ†é’Ÿ
  "SendBufferSize": 131072, // å‘é€ç¼“å†²åŒºå¢åŠ åˆ°128KB
  "ReceiveBufferSize": 131072, // æ¥æ”¶ç¼“å†²åŒºå¢åŠ åˆ°128KB
  "KeepAlive": true, // å¯ç”¨TCP Keep-Alive
  "KeepAlivePeriod": "30s" // Keep-Aliveæ¢æµ‹é—´éš”
}
```

**é¢„æœŸæ•ˆæœ**: å‡å°‘ç½‘ç»œå»¶è¿Ÿå¯¼è‡´çš„å†™è¶…æ—¶ï¼Œæé«˜è¿æ¥ç¨³å®šæ€§

### æ­¥éª¤ 2: å†™ç¼“å†²åŒºç®¡ç†ä¿®å¤ ã€ä¼˜å…ˆçº§ï¼šé«˜ã€‘

**ç›®æ ‡**: ä¿®å¤å†™åç¨‹å¼‚å¸¸é€€å‡ºé—®é¢˜

**æ“ä½œæ–‡ä»¶**:

- `pkg/network/write_buffer_monitor.go`
- `pkg/protocol/sender.go`

**å…·ä½“ä¿®æ”¹**:

1. **æ·»åŠ å†™åç¨‹å¼‚å¸¸æ¢å¤æœºåˆ¶**

```go
// åœ¨å†™åç¨‹ä¸­æ·»åŠ panicæ¢å¤
defer func() {
    if r := recover(); r != nil {
        log.Errorf("Writer goroutine panic recovered: %v", r)
        // é‡å¯å†™åç¨‹
        go c.startWriter()
    }
}()
```

2. **å®ç°å†™ç¼“å†²åŒºçŠ¶æ€ç›‘æ§**

```go
// æ·»åŠ ç¼“å†²åŒºå¥åº·æ£€æŸ¥
type BufferHealthChecker struct {
    maxQueueSize   int
    warningLevel   float64
    criticalLevel  float64
}

func (bhc *BufferHealthChecker) CheckHealth(queueSize int) BufferHealth {
    usage := float64(queueSize) / float64(bhc.maxQueueSize)
    if usage > bhc.criticalLevel {
        return BufferCritical
    } else if usage > bhc.warningLevel {
        return BufferWarning
    }
    return BufferHealthy
}
```

3. **å®ç°èƒŒå‹æ§åˆ¶æœºåˆ¶**

```go
// å½“ç¼“å†²åŒºæ¥è¿‘æ»¡æ—¶çš„å¤„ç†ç­–ç•¥
func (c *Connection) sendWithBackpressure(data []byte) error {
    select {
    case c.sendQueue <- data:
        return nil
    case <-time.After(1 * time.Second):
        // ç¼“å†²åŒºæ»¡ï¼Œä¸¢å¼ƒæœ€æ—§çš„æ¶ˆæ¯æˆ–è¿”å›é”™è¯¯
        return ErrSendBufferFull
    }
}
```

**é¢„æœŸæ•ˆæœ**: å†™åç¨‹ç¨³å®šè¿è¡Œï¼Œç¼“å†²åŒºæº¢å‡ºæ—¶ä¼˜é›…å¤„ç†

### æ­¥éª¤ 3: æ•°æ®å‘é€å™¨é‡æ„ ã€ä¼˜å…ˆçº§ï¼šé«˜ã€‘

**ç›®æ ‡**: å®ç°å¯é çš„æ•°æ®å‘é€æœºåˆ¶

**æ“ä½œæ–‡ä»¶**:

- `pkg/protocol/sender.go`
- `pkg/network/monitoring_manager.go`

**å…·ä½“ä¿®æ”¹**:

1. **æ·»åŠ å‘é€é‡è¯•æœºåˆ¶**

```go
type RetryConfig struct {
    MaxRetries    int           // æœ€å¤§é‡è¯•æ¬¡æ•°
    InitialDelay  time.Duration // åˆå§‹å»¶è¿Ÿ
    MaxDelay      time.Duration // æœ€å¤§å»¶è¿Ÿ
    BackoffFactor float64       // é€€é¿å› å­
}

func (s *Sender) sendWithRetry(data []byte, config RetryConfig) error {
    var lastErr error
    delay := config.InitialDelay

    for i := 0; i <= config.MaxRetries; i++ {
        if err := s.directSend(data); err != nil {
            lastErr = err
            if i < config.MaxRetries {
                time.Sleep(delay)
                delay = time.Duration(float64(delay) * config.BackoffFactor)
                if delay > config.MaxDelay {
                    delay = config.MaxDelay
                }
            }
        } else {
            return nil // å‘é€æˆåŠŸ
        }
    }
    return lastErr
}
```

2. **å®ç°è¶…æ—¶é™çº§ç­–ç•¥**

```go
func (s *Sender) sendWithFallback(data []byte) error {
    // é¦–å…ˆå°è¯•æ­£å¸¸å‘é€
    ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second)
    defer cancel()

    if err := s.sendWithContext(ctx, data); err != nil {
        if isTimeoutError(err) {
            // è¶…æ—¶æ—¶çš„é™çº§å¤„ç†
            return s.handleSendTimeout(data)
        }
        return err
    }
    return nil
}
```

**é¢„æœŸæ•ˆæœ**: æé«˜æ•°æ®ä¼ è¾“æˆåŠŸç‡ï¼Œå‡å°‘å› ç½‘ç»œæ³¢åŠ¨å¯¼è‡´çš„å‘é€å¤±è´¥

### æ­¥éª¤ 4: è¿æ¥å¥åº·æ£€æŸ¥ä¿®æ­£ ã€ä¼˜å…ˆçº§ï¼šä¸­ã€‘

**ç›®æ ‡**: ä¿®æ­£è¿æ¥å¥åº·æ£€æŸ¥çš„è¯¯åˆ¤é—®é¢˜

**æ“ä½œæ–‡ä»¶**:

- `pkg/network/connection_health_checker.go`
- `pkg/monitor/tcp_monitor.go`

**å…·ä½“ä¿®æ”¹**:

1. **æ”¹è¿›å¥åº·åˆ¤æ–­é€»è¾‘**

```go
type ConnectionHealth struct {
    IsOnline              bool
    LastSuccessfulSend    time.Time
    LastSuccessfulReceive time.Time
    ConsecutiveFailures   int
    NetworkLatency        time.Duration
}

func (c *Connection) assessHealth() ConnectionHealth {
    now := time.Now()
    health := ConnectionHealth{
        LastSuccessfulSend:    c.lastSuccessfulSend,
        LastSuccessfulReceive: c.lastSuccessfulReceive,
        ConsecutiveFailures:   c.consecutiveFailures,
    }

    // åŸºäºå¤šä¸ªç»´åº¦è¯„ä¼°å¥åº·çŠ¶æ€
    sendTimeout := now.Sub(health.LastSuccessfulSend) > 2*time.Minute
    receiveTimeout := now.Sub(health.LastSuccessfulReceive) > 5*time.Minute
    tooManyFailures := health.ConsecutiveFailures > 5

    health.IsOnline = !(sendTimeout || receiveTimeout || tooManyFailures)
    return health
}
```

2. **åŒºåˆ†ç½‘ç»œé—®é¢˜å’Œè®¾å¤‡ç¦»çº¿**

```go
func (hc *HealthChecker) diagnoseIssue(conn *Connection) []string {
    issues := []string{}

    if conn.hasNetworkErrors() {
        issues = append(issues, "ç½‘ç»œè¿æ¥ä¸ç¨³å®š")
    }
    if conn.hasBufferIssues() {
        issues = append(issues, "å‘é€ç¼“å†²åŒºå¼‚å¸¸")
    }
    if conn.isDeviceUnresponsive() {
        issues = append(issues, "è®¾å¤‡æ— å“åº”")
    }

    return issues
}
```

**é¢„æœŸæ•ˆæœ**: å‡†ç¡®è¯†åˆ«è¿æ¥çŠ¶æ€ï¼Œå‡å°‘è¯¯æŠ¥å’Œæ¼æŠ¥

### æ­¥éª¤ 5: é…ç½®å‚æ•°è°ƒä¼˜ ã€ä¼˜å…ˆçº§ï¼šä¸­ã€‘

**ç›®æ ‡**: ä¼˜åŒ–ç³»ç»Ÿé…ç½®å‚æ•°

**æ“ä½œæ–‡ä»¶**:

- `configs/gateway.yaml`
- `conf/zinx.json`

**å…·ä½“ä¿®æ”¹**:

```yaml
# gateway.yaml
network:
  tcp:
    write_timeout: 60s
    read_timeout: 300s
    keep_alive: true
    keep_alive_period: 30s
    send_buffer_size: 131072
    receive_buffer_size: 131072

health_check:
  interval: 120s # å¥åº·æ£€æŸ¥é—´éš”å¢åŠ åˆ°2åˆ†é’Ÿ
  timeout_threshold: 300s # è¶…æ—¶é˜ˆå€¼5åˆ†é’Ÿ
  failure_threshold: 5 # è¿ç»­å¤±è´¥é˜ˆå€¼

retry:
  max_retries: 3
  initial_delay: 1s
  max_delay: 10s
  backoff_factor: 2.0
```

**é¢„æœŸæ•ˆæœ**: ç³»ç»Ÿå‚æ•°æ›´é€‚åˆå½“å‰ç½‘ç»œç¯å¢ƒ

## ğŸ§ª éªŒè¯æµ‹è¯•æ–¹æ¡ˆ

### 1. å•å…ƒæµ‹è¯•

- å†™ç¼“å†²åŒºå¼‚å¸¸æ¢å¤æµ‹è¯•
- å‘é€é‡è¯•æœºåˆ¶æµ‹è¯•
- å¥åº·æ£€æŸ¥é€»è¾‘æµ‹è¯•

### 2. é›†æˆæµ‹è¯•

- æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿå’Œä¸¢åŒ…åœºæ™¯
- é•¿æ—¶é—´ç¨³å®šæ€§æµ‹è¯•
- è®¾å¤‡é‡è¿æµ‹è¯•

### 3. å‹åŠ›æµ‹è¯•

- é«˜å¹¶å‘è¿æ¥æµ‹è¯•
- å¤§é‡æ•°æ®ä¼ è¾“æµ‹è¯•
- èµ„æºæ¶ˆè€—ç›‘æ§

### 4. å›å½’æµ‹è¯•

- åŸæœ‰åŠŸèƒ½å®Œæ•´æ€§éªŒè¯
- æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”
- æ—¥å¿—è¾“å‡ºæ£€æŸ¥

## ğŸ“… æ‰§è¡Œæ—¶é—´å®‰æ’

| æ­¥éª¤                 | é¢„ä¼°æ—¶é—´    | è´Ÿè´£æ¨¡å—          |
| -------------------- | ----------- | ----------------- |
| æ­¥éª¤ 1: ç½‘ç»œé…ç½®ä¼˜åŒ– | 2 å°æ—¶      | é…ç½®æ–‡ä»¶ + ç½‘ç»œå±‚ |
| æ­¥éª¤ 2: å†™ç¼“å†²åŒºä¿®å¤ | 4 å°æ—¶      | ç½‘ç»œå±‚ + åè®®å±‚   |
| æ­¥éª¤ 3: å‘é€å™¨é‡æ„   | 6 å°æ—¶      | åè®®å±‚            |
| æ­¥éª¤ 4: å¥åº·æ£€æŸ¥ä¿®æ­£ | 3 å°æ—¶      | ç›‘æ§å±‚            |
| æ­¥éª¤ 5: å‚æ•°è°ƒä¼˜     | 1 å°æ—¶      | é…ç½®æ–‡ä»¶          |
| éªŒè¯æµ‹è¯•             | 4 å°æ—¶      | å…¨ç³»ç»Ÿ            |
| **æ€»è®¡**             | **20 å°æ—¶** |                   |

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

**å¤‡ä»½ç­–ç•¥**:

- ä¿®æ”¹å‰åˆ›å»ºä»£ç åˆ†æ”¯å¤‡ä»½
- ä¿å­˜åŸå§‹é…ç½®æ–‡ä»¶
- è®°å½•æ‰€æœ‰ä¿®æ”¹å†…å®¹

**å›æ»šè§¦å‘æ¡ä»¶**:

- ä¿®å¤åå‡ºç°æ–°çš„ä¸¥é‡é—®é¢˜
- ç³»ç»Ÿæ€§èƒ½æ˜æ˜¾ä¸‹é™
- åŠŸèƒ½æµ‹è¯•å¤±è´¥

**å›æ»šæ­¥éª¤**:

1. åœæ­¢æœåŠ¡
2. æ¢å¤å¤‡ä»½çš„ä»£ç å’Œé…ç½®
3. é‡å¯æœåŠ¡
4. éªŒè¯ç³»ç»Ÿæ¢å¤æ­£å¸¸

## âœ… ä¿®å¤å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] é…ç½®æ–‡ä»¶ä¿®æ”¹å®Œæˆå¹¶éªŒè¯
- [ ] å†™ç¼“å†²åŒºç›‘æ§ä»£ç ä¿®æ”¹å®Œæˆ
- [ ] å‘é€å™¨é‡è¯•æœºåˆ¶å®ç°å®Œæˆ
- [ ] å¥åº·æ£€æŸ¥é€»è¾‘ä¿®æ­£å®Œæˆ
- [ ] å•å…ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] é›†æˆæµ‹è¯•éªŒè¯æˆåŠŸ
- [ ] å‹åŠ›æµ‹è¯•æ€§èƒ½è¾¾æ ‡
- [ ] 24 å°æ—¶ç¨³å®šæ€§æµ‹è¯•é€šè¿‡
- [ ] æ—¥å¿—
