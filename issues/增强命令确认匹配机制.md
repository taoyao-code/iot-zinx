# 增强命令确认匹配机制

## 任务背景
在日志分析中发现超时命令处理问题，主要表现为:
- 命令管理器(CommandManager)中记录的messageID与实际发送的数据包中messageID不一致
- 命令确认时(`ConfirmCommand`方法)只检查了physicalID和command，没有严格匹配messageID
- 这可能导致错误确认命令，特别是当有多个相同命令类型的请求时

## 执行计划

### 1. 修改命令确认逻辑
- **文件**: `/pkg/network/command_manager.go`
- **函数**: `ConfirmCommand`
- **修改内容**: 增加对messageID的严格匹配检查，提高命令确认的准确性

### 2. 修复重发命令时的MessageID处理
- **文件**: `/pkg/network/command_manager.go`
- **函数**: `processBatchTimeoutCommands`
- **修改内容**: 确保重发时使用原始命令的MessageID，不生成新ID

### 3. 增强日志记录
- **文件**: `/pkg/network/command_manager.go`
- **函数**: `RegisterCommand`, `ConfirmCommand`, `processBatchTimeoutCommands`
- **修改内容**: 增加十六进制格式的messageID日志记录，方便追踪和对比

### 4. 修复DNY协议包构建中的MessageID编码
- **文件**: `/pkg/protocol/sender.go`
- **函数**: `buildDNYPacket`
- **修改内容**: 确保正确地将messageID编码为小端序字节

### 5. 添加命令优先级管理
- **文件**: `/pkg/network/command_manager.go`
- **函数**: `RegisterCommand`
- **修改内容**: 实现命令优先级设置，确保关键命令优先处理

### 6. 完善超时处理逻辑
- **文件**: `/pkg/network/command_manager.go`
- **函数**: `checkTimeoutCommands`
- **修改内容**: 优化超时命令的批量处理，避免重复超时

### 7. 实现命令状态追踪
- **文件**: `/pkg/network/command_manager.go`
- **函数**: `RegisterCommand`, `ConfirmCommand`
- **修改内容**: 增加命令状态追踪，记录命令生命周期中的状态变化

## 特别说明
所有日志输出都需要显示详细的数据信息，包括:
- 原始二进制数据(十六进制表示)
- 解析后的各字段值(十进制和十六进制格式)
- 命令状态和处理过程

## 执行进度
- [x] 修改命令确认逻辑
- [x] 修复重发命令时的MessageID处理
- [x] 增强日志记录
- [x] 修复DNY协议包构建中的MessageID编码
- [x] 添加命令优先级管理
- [x] 完善超时处理逻辑
- [x] 实现命令状态追踪

## 实现总结

### 主要修改内容
1. **命令确认逻辑增强**：
   - 添加了消息ID的严格匹配检查
   - 增加了兼容模式，支持旧版本设备（仅匹配物理ID和命令码）
   - 详细日志记录匹配类型和过程

2. **命令状态追踪**：
   - 添加了CommandStatus类型和状态常量
   - 在命令生命周期中跟踪状态变化：pending → sent → retrying → confirmed/failed/expired
   - 记录失败原因和详细状态信息

3. **命令优先级管理**：
   - 根据命令类型设置优先级
   - 超时处理时按优先级排序
   - 确保重要命令（如设备注册、充电控制）优先处理

4. **日志输出增强**：
   - 显示十六进制和十进制格式的字段值
   - 添加命令描述、状态和处理耗时
   - 记录原始数据和详细处理过程

5. **超时处理优化**：
   - 确保使用原始命令ID重发
   - 添加过期命令详细记录
   - 改进批量处理机制，减少锁争用

### 预期效果
- 命令确认准确性提高，避免误确认
- 可以清晰追踪命令生命周期和状态变化
- 重要命令优先处理，提高系统响应性
- 日志记录更详细，便于问题诊断 