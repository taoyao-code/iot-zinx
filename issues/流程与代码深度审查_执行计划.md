# 流程与代码深度审查 - 执行计划

## 1. `pkg/monitor/tcp_monitor.go` 优化实施计划

对 `pkg/monitor/tcp_monitor.go` 的优化和实施，请参考 `issues/服务器端主从识别与会话管理问题排查_执行.md` 和 `issues/流程与代码深度审查纪要.md` 中的详细计划和最新进展。

## 2. `pkg/monitor/session_manager.go` 优化实施计划

- **任务 2.1**: 移除冗余字段 `physicalIDMap` 和 `iccidMap`。
  - **文件**: `pkg/monitor/session_manager.go`
  - **逻辑**: 移除这两个字段及其相关操作，确保功能通过 `sessions` map 和 `DeviceSession` 内部字段维护。
  - **预期**: 简化数据结构，减少冗余。
- **任务 2.2**: 明确 `HandleDeviceDisconnect` 和 `SuspendSession` 之间的关系和调用顺序。
  - **文件**: `pkg/monitor/session_manager.go`
  - **逻辑**: 分析调用流程，确保在设备断开时，会话状态被正确、无冲突地更新（例如，`SuspendSession` 是否应由 `HandleDeviceDisconnect` 内部调用，或者它们处理不同层面的断开逻辑）。
  - **预期**: 断开连接的逻辑清晰且无副作用。
- **任务 2.3**: 为 `DeviceSession.Status` 使用常量/枚举。
  - **文件**: `pkg/monitor/session_manager.go` (及可能相关的 `pkg/constants/status.go`)
  - **逻辑**: 定义设备会话状态的常量（如 `StatusOnline`, `StatusOffline`, `StatusSuspended`），并在代码中替换魔术字符串或数字。
  - **预期**: 提高代码可读性和可维护性。
- **任务 2.4**: 确保 `CleanupExpiredSessions` 被定期调用。
  - **文件**: (可能在 `pkg/init.go` 或其他初始化/定时任务模块)
  - **逻辑**: 检查或添加定时调用 `SessionManager.CleanupExpiredSessions` 的逻辑。
  - **预期**: 过期会话能被及时清理，释放资源。

## 3. `pkg/protocol/` 重构计划

- **任务 3.1**: 重构 DNY 解析器以统一逻辑并明确职责。
  - **文件**: `pkg/protocol/dny_decoder.go`, `dny_frame_parser.go`, `dny_protocol_parser.go`, `parser.go`
  - **逻辑**: 根据审查纪要中的建议（如统一校验和逻辑，整合特殊消息识别等），对解析器进行重构。
  - **预期**: 解析逻辑更清晰、高效、易于维护。
- **任务 3.2**: 审查 `pkg/protocol/sender.go` 中 `dnyProtocolSenderAdapter` 的必要性。
  - **文件**: `pkg/protocol/sender.go`
  - **逻辑**: 分析其是否引入了不必要的复杂性，或者其功能是否可以被更直接的方式替代。
  - **预期**: 简化发送逻辑（如果适用）。

## 4. `pkg/init.go` 改进计划

- **任务 4.1**: 为回调定义显式的命名接口，替代匿名函数类型。
  - **文件**: `pkg/init.go` (以及回调函数所在的包，如 `pkg/network/interface.go`, `pkg/heartbeat/interface.go`)
  - **逻辑**: 将匿名函数回调（如 `network.SetConnectionCallbacks(onConnStart, onConnStop)` 中的参数类型）替换为明确定义的接口类型。
  - **预期**: 提高代码的可读性和可测试性，更符合 Go 的接口最佳实践。
- **任务 4.2**: 明确 `dnyProtocolSenderAdapter` 的角色（原始发送 vs. 协议感知发送）。
  - **文件**: `pkg/init.go`, `pkg/protocol/sender.go`
  - **逻辑**: 根据任务 3.2 的审查结果，如果保留 `dnyProtocolSenderAdapter`，需明确其职责边界，确保其在初始化和使用时逻辑清晰。
  - **预期**: 消除关于发送器职责的歧义。

## 5. 文档更新与清理

- **任务 5.1**: 将本计划概要存入 `issues/流程与代码深度审查_执行计划.md`。
  - **文件**: `issues/流程与代码深度审查_执行计划.md`
  - **逻辑**: 创建新文件并写入上述计划。
  - **预期**: 有一个清晰的执行路线图。
