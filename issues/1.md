背景：总帐号的入账金额就是用户充值的流水，可以提现的，代理商的入账金额是所管设备的消费金额再按比例分配过后的金额。

用户类型 1.总账号、n 个代理商账号

分账逻辑：总账号设置每个代理商不同的分账比例，代理商的入账金额按照分账比例计算
设备

代理商管理的设备

小程序充值用户：小程序充值金额，到达微信资金池，然后点击设备(代理商管理或总账号管理)开始进行充电，消费的金额，划分到代理商的入账金额中，代理商提现金额 = 消费金额 \* 分账比例

## 系统架构图

### 1. 用户类型关系图

```mermaid
graph TD
    subgraph "管理层级"
        A[总账号<br/>🏢 系统管理员]
        A -->|设置分账比例| B[代理商1<br/>📊 比例: 70%]
        A -->|设置分账比例| C[代理商2<br/>📊 比例: 80%]
        A -->|设置分账比例| D[代理商n<br/>📊 比例: 60%]
    end

    subgraph "设备归属"
        B -->|管理| E[🔌 充电桩1-1]
        B -->|管理| F[🔌 充电桩1-2]
        C -->|管理| G[🔌 充电桩2-1]
        D -->|管理| H[🔌 充电桩n-1]
        A -->|直营| I[🔌 总账号设备]
    end

    subgraph "用户交互层"
        J[👤 小程序用户] -->|充值| K[💰 微信资金池]
        J -->|扫码使用| E
        J -->|扫码使用| F
        J -->|扫码使用| G
        J -->|扫码使用| H
        J -->|扫码使用| I
    end

    style A fill:#ff9999
    style B fill:#99ccff
    style C fill:#99ccff
    style D fill:#99ccff
    style K fill:#99ff99
```

### 2. 资金流转时序图

```mermaid
sequenceDiagram
    participant U as 👤小程序用户
    participant W as 💰微信资金池
    participant D as 🔌设备系统
    participant S as 🏢系统后台
    participant A as 📊代理商账户
    participant M as 🏦总账号

    U->>W: 1. 充值100元
    Note over W: 资金进入微信资金池

    U->>D: 2. 扫码开始充电
    D->>S: 3. 查询设备归属

    alt 代理商设备
        S->>S: 4a. 获取代理商分账比例(70%)
        Note over S: 充电结束，消费20元
        S->>A: 5a. 代理商入账: 20×70%=14元
        S->>M: 6a. 总账号入账: 20×30%=6元
        Note over A: 代理商可提现金额+14元
        Note over M: 总账号记录完整流水
    else 总账号直营设备
        Note over S: 充电结束，消费20元
        S->>M: 5b. 总账号入账: 20×100%=20元
        Note over M: 总账号全额收益+20元
    end

    S->>U: 7. 推送消费明细
```

### 3. 分账逻辑流程图

```mermaid
flowchart TD
    A[用户充电消费] --> B{设备归属查询}
    B -->|代理商管理| C[获取该代理商分账比例]
    B -->|总账号管理| D[100%归总账号]

    C --> E[计算: 消费金额 × 分账比例]
    E --> F[代理商账户入账]
    E --> G[计算剩余金额归总账号]
    G --> H[总账号账户入账]

    D --> I[总账号账户全额入账]

    F --> J[更新代理商可提现金额]
    H --> K[更新总账号可提现金额]
    I --> K

    J --> L[代理商提现申请]
    K --> M[总账号提现申请]

    L --> N[提现处理]
    M --> N

    style F fill:#e1f5fe
    style J fill:#e8f5e8
    style K fill:#fff3e0
    style N fill:#f3e5f5
```

### 4. 数据流向图

```mermaid
graph LR
    subgraph "💰资金来源"
        A[👤用户充值] --> B[💰微信资金池]
    end

    subgraph "🔌消费环节"
        B --> C[设备使用]
        C --> D[产生消费金额]
    end

    subgraph "📊分账处理"
        D --> E{🏢设备管理方}
        E -->|代理商设备| F[📈按比例分账]
        E -->|总账号设备| G[💯全额入账]
        F --> H[📊代理商入账]
        F --> I[🏦总账号入账]
        G --> I
    end

    subgraph "💳提现管理"
        H --> J[📤代理商提现]
        I --> K[📤总账号提现]
    end

    style A fill:#ffebee
    style B fill:#e8f5e8
    style H fill:#e1f5fe
    style I fill:#fff3e0
    style J fill:#f3e5f5
    style K fill:#f3e5f5
```
