# 架构简化删除计划

**任务类型**: 代码简化重构  
**优先级**: P0 (最高优先级)  
**创建时间**: 2025 年 7 月 30 日  
**目标**: 删除冗余的 DataBus 架构，实现简化的 3 层架构

---

## 🎯 **删除目标**

将复杂的 7-8 层抽象架构简化为：

- **Handler 层** → **GlobalStore 层** → **API 层**

遵循用户要求："不要保留冗余代码"

---

## 📋 **删除清单**

### **Phase 1: 完全删除 DataBus 系统**

#### 1.1 删除 DataBus 核心

- [ ] `pkg/databus/` 整个目录
  - [ ] `databus.go` - DataBus 接口和实现
  - [ ] `data_manager.go` - 数据管理器
  - [ ] `event_publisher.go` - 事件发布器
  - [ ] `storage.go` - 存储管理器
  - [ ] `converter.go` - 数据转换器
  - [ ] `validator.go` - 验证器
  - [ ] `interface.go` - 接口定义
  - [ ] `models*.go` - 数据模型
  - [ ] `adapters/` 整个目录

#### 1.2 删除 DataBus 适配器

- [ ] `pkg/databus/adapters/tcp_connection_adapter.go`
- [ ] `pkg/databus/adapters/tcp_event_publisher.go`
- [ ] `pkg/databus/adapters/tcp_session_manager.go`
- [ ] `pkg/databus/adapters/tcp_protocol_bridge.go`
- [ ] `pkg/databus/adapters/tcp_databus_integrator.go`
- [ ] `pkg/databus/adapters/device_register_adapter.go`
- [ ] `pkg/databus/adapters/protocol_data_adapter.go`

#### 1.3 删除全局 DataBus 集成

- [ ] `internal/app/global_databus.go` - 完全删除
- [ ] `internal/app/service_manager.go` - 删除 DataBus 相关代码

### **Phase 2: 简化网络管理组件**

#### 2.1 简化监控系统

- [ ] `pkg/monitor/` 中的复杂抽象
  - [ ] 保留基础监控，删除 DataBus 集成
  - [ ] 删除过度的适配器模式

#### 2.2 简化网络组件

- [ ] `pkg/network/` 中的过度抽象
  - [ ] 简化 command_manager.go
  - [ ] 删除复杂的 response_waiter.go 中的 DataBus 集成
  - [ ] 保留核心 TCP 功能

### **Phase 3: 删除重构任务文档**

- [ ] `issues/数据总线架构重构任务.md` - 删除，因为不再需要复杂架构

---

## 🔧 **替换组件**

### **新增简化组件**

#### 3.1 创建 GlobalStore

```go
// pkg/store/global_store.go
type GlobalStore struct {
    devices    map[string]*Device
    sessions   map[string]*Session
    commands   map[string]*Command
    mu         sync.RWMutex
}
```

#### 3.2 简化 Handler

```go
// internal/handler/protocol_handler.go
type ProtocolHandler struct {
    store *store.GlobalStore
}
```

#### 3.3 简化连接管理

```go
// pkg/connection/simple_manager.go
type SimpleConnectionManager struct {
    store *store.GlobalStore
}
```

---

## 📊 **保留组件**

### **核心保留组件**

- ✅ `pkg/protocol/` - 协议解析器（核心功能）
- ✅ `pkg/constants/` - 协议常量（不变）
- ✅ `pkg/session/` - 基础会话管理（简化版）
- ✅ `internal/ports/tcp_server.go` - TCP 服务器（简化）
- ✅ `internal/adapter/http/` - HTTP API（简化）

### **简化保留组件**

- 🔄 `pkg/network/command_manager.go` - 删除 DataBus 集成
- 🔄 `pkg/session/device_session.go` - 简化状态管理
- 🔄 `internal/ports/tcp_server.go` - 删除复杂适配器

---

## 🚀 **实施步骤**

### **Step 1: 创建新架构**

1. 创建 `pkg/store/global_store.go`
2. 创建 `internal/handler/` 简化处理器
3. 修改 `main.go` 使用新架构

### **Step 2: 删除 DataBus**

1. 删除 `pkg/databus/` 整个目录
2. 删除 `internal/app/global_databus.go`
3. 清理所有 DataBus 导入和调用

### **Step 3: 简化现有组件**

1. 简化网络组件
2. 简化监控组件
3. 简化会话管理

### **Step 4: 测试验证**

1. 运行单元测试
2. 集成测试
3. 功能验证

---

## ⚠️ **风险控制**

### **备份策略**

- 在新分支进行重构
- 关键功能先创建替代品再删除

### **验证标准**

- 协议解析正常
- TCP 连接稳定
- API 功能完整
- 性能不降低

---

## 📈 **预期效果**

### **代码简化**

- 删除 7000+行复杂抽象代码
- 减少 80%的适配器和管理器
- 简化到 3 层架构

### **维护性提升**

- 代码结构清晰简单
- 调试和问题定位容易
- 新功能开发直接

### **性能提升**

- 减少不必要的数据转换
- 消除复杂的事件发布开销
- 直接的数据访问路径
