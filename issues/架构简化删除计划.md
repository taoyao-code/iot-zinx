# æ¶æ„ç®€åŒ–åˆ é™¤è®¡åˆ’

**ä»»åŠ¡ç±»å‹**: ä»£ç ç®€åŒ–é‡æ„  
**ä¼˜å…ˆçº§**: P0 (æœ€é«˜ä¼˜å…ˆçº§)  
**åˆ›å»ºæ—¶é—´**: 2025 å¹´ 7 æœˆ 30 æ—¥  
**ç›®æ ‡**: åˆ é™¤å†—ä½™çš„ DataBus æ¶æ„ï¼Œå®ç°ç®€åŒ–çš„ 3 å±‚æ¶æ„

---

## ğŸ¯ **åˆ é™¤ç›®æ ‡**

å°†å¤æ‚çš„ 7-8 å±‚æŠ½è±¡æ¶æ„ç®€åŒ–ä¸ºï¼š

- **Handler å±‚** â†’ **GlobalStore å±‚** â†’ **API å±‚**

éµå¾ªç”¨æˆ·è¦æ±‚ï¼š"ä¸è¦ä¿ç•™å†—ä½™ä»£ç "

---

## ğŸ“‹ **åˆ é™¤æ¸…å•**

### **Phase 1: å®Œå…¨åˆ é™¤ DataBus ç³»ç»Ÿ**

#### 1.1 åˆ é™¤ DataBus æ ¸å¿ƒ

- [ ] `pkg/databus/` æ•´ä¸ªç›®å½•
  - [ ] `databus.go` - DataBus æ¥å£å’Œå®ç°
  - [ ] `data_manager.go` - æ•°æ®ç®¡ç†å™¨
  - [ ] `event_publisher.go` - äº‹ä»¶å‘å¸ƒå™¨
  - [ ] `storage.go` - å­˜å‚¨ç®¡ç†å™¨
  - [ ] `converter.go` - æ•°æ®è½¬æ¢å™¨
  - [ ] `validator.go` - éªŒè¯å™¨
  - [ ] `interface.go` - æ¥å£å®šä¹‰
  - [ ] `models*.go` - æ•°æ®æ¨¡å‹
  - [ ] `adapters/` æ•´ä¸ªç›®å½•

#### 1.2 åˆ é™¤ DataBus é€‚é…å™¨

- [ ] `pkg/databus/adapters/tcp_connection_adapter.go`
- [ ] `pkg/databus/adapters/tcp_event_publisher.go`
- [ ] `pkg/databus/adapters/tcp_session_manager.go`
- [ ] `pkg/databus/adapters/tcp_protocol_bridge.go`
- [ ] `pkg/databus/adapters/tcp_databus_integrator.go`
- [ ] `pkg/databus/adapters/device_register_adapter.go`
- [ ] `pkg/databus/adapters/protocol_data_adapter.go`

#### 1.3 åˆ é™¤å…¨å±€ DataBus é›†æˆ

- [ ] `internal/app/global_databus.go` - å®Œå…¨åˆ é™¤
- [ ] `internal/app/service_manager.go` - åˆ é™¤ DataBus ç›¸å…³ä»£ç 

### **Phase 2: ç®€åŒ–ç½‘ç»œç®¡ç†ç»„ä»¶**

#### 2.1 ç®€åŒ–ç›‘æ§ç³»ç»Ÿ

- [ ] `pkg/monitor/` ä¸­çš„å¤æ‚æŠ½è±¡
  - [ ] ä¿ç•™åŸºç¡€ç›‘æ§ï¼Œåˆ é™¤ DataBus é›†æˆ
  - [ ] åˆ é™¤è¿‡åº¦çš„é€‚é…å™¨æ¨¡å¼

#### 2.2 ç®€åŒ–ç½‘ç»œç»„ä»¶

- [ ] `pkg/network/` ä¸­çš„è¿‡åº¦æŠ½è±¡
  - [ ] ç®€åŒ– command_manager.go
  - [ ] åˆ é™¤å¤æ‚çš„ response_waiter.go ä¸­çš„ DataBus é›†æˆ
  - [ ] ä¿ç•™æ ¸å¿ƒ TCP åŠŸèƒ½

### **Phase 3: åˆ é™¤é‡æ„ä»»åŠ¡æ–‡æ¡£**

- [ ] `issues/æ•°æ®æ€»çº¿æ¶æ„é‡æ„ä»»åŠ¡.md` - åˆ é™¤ï¼Œå› ä¸ºä¸å†éœ€è¦å¤æ‚æ¶æ„

---

## ğŸ”§ **æ›¿æ¢ç»„ä»¶**

### **æ–°å¢ç®€åŒ–ç»„ä»¶**

#### 3.1 åˆ›å»º GlobalStore

```go
// pkg/store/global_store.go
type GlobalStore struct {
    devices    map[string]*Device
    sessions   map[string]*Session
    commands   map[string]*Command
    mu         sync.RWMutex
}
```

#### 3.2 ç®€åŒ– Handler

```go
// internal/handler/protocol_handler.go
type ProtocolHandler struct {
    store *store.GlobalStore
}
```

#### 3.3 ç®€åŒ–è¿æ¥ç®¡ç†

```go
// pkg/connection/simple_manager.go
type SimpleConnectionManager struct {
    store *store.GlobalStore
}
```

---

## ğŸ“Š **ä¿ç•™ç»„ä»¶**

### **æ ¸å¿ƒä¿ç•™ç»„ä»¶**

- âœ… `pkg/protocol/` - åè®®è§£æå™¨ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
- âœ… `pkg/constants/` - åè®®å¸¸é‡ï¼ˆä¸å˜ï¼‰
- âœ… `pkg/session/` - åŸºç¡€ä¼šè¯ç®¡ç†ï¼ˆç®€åŒ–ç‰ˆï¼‰
- âœ… `internal/ports/tcp_server.go` - TCP æœåŠ¡å™¨ï¼ˆç®€åŒ–ï¼‰
- âœ… `internal/adapter/http/` - HTTP APIï¼ˆç®€åŒ–ï¼‰

### **ç®€åŒ–ä¿ç•™ç»„ä»¶**

- ğŸ”„ `pkg/network/command_manager.go` - åˆ é™¤ DataBus é›†æˆ
- ğŸ”„ `pkg/session/device_session.go` - ç®€åŒ–çŠ¶æ€ç®¡ç†
- ğŸ”„ `internal/ports/tcp_server.go` - åˆ é™¤å¤æ‚é€‚é…å™¨

---

## ğŸš€ **å®æ–½æ­¥éª¤**

### **Step 1: åˆ›å»ºæ–°æ¶æ„**

1. åˆ›å»º `pkg/store/global_store.go`
2. åˆ›å»º `internal/handler/` ç®€åŒ–å¤„ç†å™¨
3. ä¿®æ”¹ `main.go` ä½¿ç”¨æ–°æ¶æ„

### **Step 2: åˆ é™¤ DataBus**

1. åˆ é™¤ `pkg/databus/` æ•´ä¸ªç›®å½•
2. åˆ é™¤ `internal/app/global_databus.go`
3. æ¸…ç†æ‰€æœ‰ DataBus å¯¼å…¥å’Œè°ƒç”¨

### **Step 3: ç®€åŒ–ç°æœ‰ç»„ä»¶**

1. ç®€åŒ–ç½‘ç»œç»„ä»¶
2. ç®€åŒ–ç›‘æ§ç»„ä»¶
3. ç®€åŒ–ä¼šè¯ç®¡ç†

### **Step 4: æµ‹è¯•éªŒè¯**

1. è¿è¡Œå•å…ƒæµ‹è¯•
2. é›†æˆæµ‹è¯•
3. åŠŸèƒ½éªŒè¯

---

## âš ï¸ **é£é™©æ§åˆ¶**

### **å¤‡ä»½ç­–ç•¥**

- åœ¨æ–°åˆ†æ”¯è¿›è¡Œé‡æ„
- å…³é”®åŠŸèƒ½å…ˆåˆ›å»ºæ›¿ä»£å“å†åˆ é™¤

### **éªŒè¯æ ‡å‡†**

- åè®®è§£ææ­£å¸¸
- TCP è¿æ¥ç¨³å®š
- API åŠŸèƒ½å®Œæ•´
- æ€§èƒ½ä¸é™ä½

---

## ğŸ“ˆ **é¢„æœŸæ•ˆæœ**

### **ä»£ç ç®€åŒ–**

- åˆ é™¤ 7000+è¡Œå¤æ‚æŠ½è±¡ä»£ç 
- å‡å°‘ 80%çš„é€‚é…å™¨å’Œç®¡ç†å™¨
- ç®€åŒ–åˆ° 3 å±‚æ¶æ„

### **ç»´æŠ¤æ€§æå‡**

- ä»£ç ç»“æ„æ¸…æ™°ç®€å•
- è°ƒè¯•å’Œé—®é¢˜å®šä½å®¹æ˜“
- æ–°åŠŸèƒ½å¼€å‘ç›´æ¥

### **æ€§èƒ½æå‡**

- å‡å°‘ä¸å¿…è¦çš„æ•°æ®è½¬æ¢
- æ¶ˆé™¤å¤æ‚çš„äº‹ä»¶å‘å¸ƒå¼€é”€
- ç›´æ¥çš„æ•°æ®è®¿é—®è·¯å¾„
