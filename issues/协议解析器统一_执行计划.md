# 协议解析器统一 执行计划

**任务目标**：将核心解析逻辑统一到 `pkg/protocol/dny_protocol_parser.go` 的 `ParseDNYProtocolData` 函数，并使 Zinx 的解码器 (`pkg/protocol/dny_decoder.go`) 使用此统一的解析服务。

**用户选定方案**：针对业务处理器兼容性，采用方案 A：直接改造处理器使用新模型。

**详细步骤清单**：

1.  **增强 `ParseDNYProtocolData` 函数 (`pkg/protocol/dny_protocol_parser.go`)**

    1.  **整合特殊消息处理**：
        - 分析 `pkg/protocol/dny_frame_parser.go` 中的 `parseFrame` 函数，提取对 ICCID 和 "link" 心跳等特殊消息的识别逻辑。
        - 将这些识别逻辑整合进 `ParseDNYProtocolData`。
    2.  **统一校验和计算**：
        - 确认 `pkg/protocol/dny_protocol_parser.go` 中的 `CalculatePacketChecksum` 函数能够覆盖 `pkg/protocol/dny_frame_parser.go` 中 `calculateDNYCrc` 的功能。
        - 计划废弃 `calculateDNYCrc`。
    3.  **返回统一结果结构**：
        - 确保 `ParseDNYProtocolData` 返回的 `*dny_protocol.Message` 结构体（定义在 `internal/domain/dny_protocol/frame.go`）能够承载所有类型消息的解析结果。
        - 在 `dny_protocol.Message` 中增加字段以区分消息类型（如 `MessageType`）和存储特殊消息数据（如 `ICCIDValue`, `ErrorMessage`）。

2.  **改造 `DNY_Decoder` 的 `Intercept` 方法 (`pkg/protocol/dny_decoder.go`)**

    1.  **调用统一解析服务**：
        - 修改 `Intercept` 方法，移除对 `parseFrame` 的调用，改为调用增强后的 `ParseDNYProtocolData`。
    2.  **适配 Zinx `IMessage`**：
        - 根据 `ParseDNYProtocolData` 返回的统一结果，正确设置 Zinx `IMessage` 的 `MsgID` 和 `Data`。
        - 为特殊消息（ICCID、"link" 心跳、解析错误）定义专门的 `MsgID` 用于路由。
    3.  **改造业务处理器接口 (方案 A)**：
        - 修改 `pkg/protocol/dny_frame_handler_base.go` 中的 `ExtractDecodedFrame` 方法，使其能够从 `request.GetResponse()` 中提取新的统一解析结果类型 (`*dny_protocol.Message`)。
        - 修改各个业务处理器，使其能够直接处理 `*dny_protocol.Message`。

3.  **重构或废弃 `pkg/protocol/dny_frame_parser.go`**

    1.  核心解析逻辑整合到 `pkg/protocol/dny_protocol_parser.go`。
    2.  `DecodedDNYFrame` 结构体 (`pkg/protocol/dny_types.go`) 将被废弃或大幅简化，因为业务处理器将使用 `*dny_protocol.Message`。
    3.  `calculateDNYCrc` 函数将被废弃。
    4.  `pkg/protocol/dny_frame_parser.go` 文件本身可能被大幅简化或完全移除。

4.  **审视并调整 `pkg/protocol/parser.go`**

    1.  确保此文件中的兼容性 API（如 `ParseDNYData`）内部调用的是最终统一的 `ParseDNYProtocolData` 逻辑，并能正确处理新的返回结构。

5.  **测试**
    1.  编写或更新单元测试，覆盖所有消息类型的解析。
    2.  进行集成测试，确保整个数据流的正确性。

**执行记录将在此文件下方追加。**

---
