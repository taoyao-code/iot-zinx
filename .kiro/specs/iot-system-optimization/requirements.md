# IoT 充电桩系统数据总线架构重构需求文档

## 项目概述

本项目旨在通过**数据总线架构模式**彻底重构现有的 IoT 充电桩系统。当前系统基于 Zinx 网络框架开发，负责处理充电桩设备的连接管理、DNY 协议解析、充电控制指令、实时数据上报等核心功能。

通过深入分析发现以下**根本性数据管理问题**：

- **数据重复存储严重**：同一设备数据在 6 个不同结构中重复存储（DeviceSession、UnifiedDeviceSession、UnifiedSession、ConnectionInfo、ConnectionMetrics、DeviceRegistrationState）
- **状态管理混乱**：设备状态在 5 个地方重复管理，数据不一致严重
- **业务数据流断裂**：充电流程数据无法串联，订单状态分散管理
- **数据转换性能损耗**：每次数据流转需要多次转换，消耗大量 CPU 资源
- **模块间耦合严重**：各模块直接访问其他模块数据，违反独立性原则

本次重构将采用**数据总线架构模式**，建立统一的数据管理和流转机制，实现"各个模块负责自己的事，但数据流保持一致"的架构目标。

## 功能需求

### 需求 1：数据总线核心架构

**用户故事：** 作为系统架构师，我希望建立统一的数据总线架构，消除数据重复存储和管理混乱问题，实现各模块独立但数据流一致的目标。

#### 验收标准

1. WHEN 系统启动时 THEN 系统 SHALL 初始化 DataBus 核心接口，包含数据发布、查询、订阅功能
2. WHEN 任何模块需要访问数据 THEN 系统 SHALL 强制通过 DataBus 接口，禁止直接访问其他模块数据
3. WHEN 数据发生变更 THEN 系统 SHALL 通过 DataBus 发布数据变更事件，通知所有订阅者
4. WHEN 多个模块同时访问同一数据 THEN 系统 SHALL 保证数据一致性，避免并发冲突
5. WHEN 系统运行时 THEN 系统 SHALL 提供数据流追踪能力，记录数据的完整流转路径

### 需求 2：数据分类和所有权管理

**用户故事：** 作为数据架构师，我希望明确每种数据的唯一所有者，建立清晰的数据分类和管理职责，避免数据管理混乱。

#### 验收标准

1. WHEN 设备基础数据需要管理 THEN 系统 SHALL 由 DeviceDataManager 作为唯一所有者，管理设备标识、属性、连接信息等
2. WHEN 设备状态数据需要管理 THEN 系统 SHALL 由 DeviceStateManager 作为唯一所有者，管理连接状态、业务状态、健康状态等
3. WHEN 端口数据需要管理 THEN 系统 SHALL 由 PortDataManager 作为唯一所有者，管理端口状态、实时数据、充电数据等
4. WHEN 订单数据需要管理 THEN 系统 SHALL 由 OrderDataManager 作为唯一所有者，管理订单基础、状态、时间、计费数据等
5. WHEN 协议数据需要管理 THEN 系统 SHALL 由 ProtocolDataManager 作为唯一所有者，管理原始数据、解析数据、转换规则等

### 需求 3：标准化数据模型

**用户故事：** 作为开发人员，我希望使用标准化的数据模型，避免各模块使用不同的数据结构导致转换复杂和错误。

#### 验收标准

1. WHEN 处理设备数据 THEN 系统 SHALL 使用统一的 DeviceData 结构，包含 deviceID、physicalID、ICCID、deviceType 等标准字段
2. WHEN 处理设备状态 THEN 系统 SHALL 使用统一的 DeviceState 结构，包含 connectionState、businessState、healthState 等标准字段
3. WHEN 处理端口数据 THEN 系统 SHALL 使用统一的 PortData 结构，统一使用 API 端口号(1-based)，包含状态、功率、电量等标准字段
4. WHEN 处理订单数据 THEN 系统 SHALL 使用统一的 OrderData 结构，包含订单 ID、状态、时间、费用等标准字段
5. WHEN 数据在模块间传递 THEN 系统 SHALL 禁止使用自定义数据结构，必须使用标准化数据模型

### 需求 4：数据流控制机制

**用户故事：** 作为系统架构师，我希望建立清晰的数据流控制规则，确保数据按照预定路径流转，避免数据流混乱。

#### 验收标准

1. WHEN 协议数据到达 THEN 系统 SHALL 按照"协议层 →ProtocolDataManager→DataBus→ 业务层"的路径流转
2. WHEN Handler 处理数据 THEN 系统 SHALL 按照"Handler 层 → 对应 DataManager→DataBus→Service 层"的路径流转
3. WHEN Service 处理业务 THEN 系统 SHALL 按照"Service 层 → 对应 DataManager→DataBus→ 存储层"的路径流转
4. WHEN 任何数据变更 THEN 系统 SHALL 强制通过 DataBus，禁止模块直接访问其他模块数据存储
5. WHEN 数据查询请求 THEN 系统 SHALL 通过 DataBus 标准接口，禁止直接访问底层存储

### 需求 5：数据一致性保证

**用户故事：** 作为系统可靠性工程师，我希望系统提供强数据一致性保证，避免分布式环境下的数据不一致问题。

#### 验收标准

1. WHEN 数据写入操作 THEN 系统 SHALL 提供数据验证机制，确保数据格式和内容正确
2. WHEN 数据格式转换 THEN 系统 SHALL 提供标准转换接口，避免转换错误和数据丢失
3. WHEN 检测到数据不一致 THEN 系统 SHALL 自动触发一致性检查，识别不一致的数据项
4. WHEN 发现数据不一致 THEN 系统 SHALL 自动修复不一致数据，从权威数据源恢复正确数据
5. WHEN 执行关键操作 THEN 系统 SHALL 提供事务支持，确保操作的原子性和一致性

### 需求 6：完整数据流转设计

**用户故事：** 作为业务开发人员，我希望了解完整的数据流转过程，确保业务逻辑正确实现。

#### 验收标准

1. WHEN 设备连接注册 THEN 系统 SHALL 按照"TCP 连接 → 协议解析 → 设备数据创建 → 状态更新 → 通知发送"的完整流程处理
2. WHEN 充电控制请求 THEN 系统 SHALL 按照"HTTP 请求 → 状态检查 → 订单创建 → 协议发送 → 状态更新 → 通知发送"的完整流程处理
3. WHEN 设备数据上报 THEN 系统 SHALL 按照"协议解析 → 数据分类 → 状态更新 → 订单更新 → 通知推送"的完整流程处理
4. WHEN 设备结算上报 THEN 系统 SHALL 按照"协议解析 → 订单完成 → 端口释放 → 计费处理 → 通知发送 → 审计记录"的完整流程处理
5. WHEN 异常情况发生 THEN 系统 SHALL 提供数据恢复流程，包括一致性检查、数据修复、状态恢复

### 需求 7：多级存储架构

**用户故事：** 作为数据架构师，我希望建立多级存储架构，优化数据访问性能，确保数据一致性。

#### 验收标准

1. WHEN 存储实时数据 THEN 系统 SHALL 使用 L1 内存缓存存储最新数据，提供最快访问速度
2. WHEN 存储热数据 THEN 系统 SHALL 使用 L2 Redis 缓存存储热数据，TTL 设置为 24 小时
3. WHEN 存储持久化数据 THEN 系统 SHALL 使用 L3 数据库存储历史数据和配置信息
4. WHEN 查询数据 THEN 系统 SHALL 按照 L1→L2→L3 的顺序查询，实现缓存穿透保护
5. WHEN 写入数据 THEN 系统 SHALL 按照 L1→L2→L3 的顺序异步写入，确保数据一致性

### 需求 8：事件驱动数据流转

**用户故事：** 作为系统架构师，我希望建立事件驱动的数据流转机制，确保数据变更能够及时传播到所有相关模块。

#### 验收标准

1. WHEN 设备状态变更 THEN 系统 SHALL 发布设备事件流：DeviceConnected→DeviceRegistered→DeviceOnline→DeviceCharging→DeviceIdle→DeviceOffline→DeviceDisconnected
2. WHEN 订单状态变更 THEN 系统 SHALL 发布订单事件流：OrderCreated→OrderActivated→OrderInProgress→OrderCompleted/OrderFailed→OrderSettled
3. WHEN 端口状态变更 THEN 系统 SHALL 发布端口事件流：PortIdle→PortReserved→PortCharging→PortCompleted→PortIdle
4. WHEN 状态发生变化 THEN 系统 SHALL 发布状态事件流：StateChanged→StateValidated→StatePersisted→StateNotified
5. WHEN 事件发布 THEN 系统 SHALL 通过 DataBus 分发给所有订阅者，确保数据流转的及时性和一致性

### 需求 9：强制执行规范

**用户故事：** 作为项目经理，我希望建立强制执行的开发规范，确保所有开发人员严格按照数据总线架构进行开发。

#### 验收标准

1. WHEN 开发人员编写代码 THEN 系统 SHALL 强制要求通过 DataBus 接口访问数据，禁止直接访问其他模块数据存储
2. WHEN 定义数据结构 THEN 系统 SHALL 强制要求使用标准化数据模型，禁止使用自定义数据结构
3. WHEN 处理事件 THEN 系统 SHALL 强制要求使用事件订阅机制，禁止直接调用其他服务方法
4. WHEN 代码审查 THEN 系统 SHALL 检查是否遵循数据总线架构规范，不符合规范的代码不得合并
5. WHEN 性能测试 THEN 系统 SHALL 验证数据查询响应时间<100ms、事件处理延迟<50ms、内存使用增长<30%、CPU 使用增长<25%

## 非功能性需求

### 性能需求

- **数据查询响应时间**：通过 DataBus 的数据查询响应时间不超过 100ms
- **事件处理延迟**：事件从发布到处理完成的延迟不超过 50ms
- **并发连接数**：系统应支持至少 1000 个并发 TCP 连接
- **缓存命中率**：多级缓存的整体命中率应达到 90%以上
- **内存使用增长**：相比当前系统，内存使用增长不超过 30%
- **CPU 使用增长**：相比当前系统，CPU 使用增长不超过 25%

### 数据一致性需求

- **强一致性保证**：关键业务数据（设备状态、订单信息、端口状态）必须保证强一致性
- **数据修复能力**：系统应能自动检测和修复数据不一致问题
- **事务支持**：关键操作必须支持事务，确保原子性和一致性
- **数据验证**：所有数据写入操作必须通过格式和内容验证
- **一致性检查**：系统应提供定期的数据一致性检查机制

### 可靠性需求

- **系统可用性**：99.9%的系统可用性（年停机时间不超过 8.76 小时）
- **故障恢复**：系统重启后能在 30 秒内恢复服务
- **数据恢复**：具备完整的数据恢复流程，包括一致性检查、数据修复、状态恢复
- **事件可靠性**：事件处理必须保证至少一次投递，支持重试和死信队列

### 可扩展性需求

- **模块独立性**：各模块必须保持独立，支持独立开发、测试、部署
- **水平扩展**：DataBus 支持集群部署，可通过增加节点扩展容量
- **热插拔能力**：支持模块的热插拔，新功能可通过事件订阅方式集成
- **配置热更新**：支持不重启服务的配置更新

### 可维护性需求

- **数据流追踪**：提供完整的数据流追踪能力，记录数据的完整流转路径
- **监控指标**：提供数据一致性、性能、业务等多维度监控指标
- **代码规范**：强制执行数据总线架构规范，代码审查必须检查规范遵循情况
- **测试覆盖**：单元测试覆盖率不低于 80%，集成测试覆盖核心流程
- **文档完整性**：提供完整的架构文档、API 文档、开发规范文档

## 约束条件

1. **架构强制要求**：必须严格按照数据总线架构模式进行重构，不得违反架构规范
2. **数据访问限制**：禁止模块间直接数据访问，必须通过 DataBus 接口
3. **数据模型标准**：必须使用标准化数据模型，禁止自定义数据结构
4. **协议兼容性**：必须保持与现有 DNY 协议的兼容性
5. **业务连续性**：必须保证系统升级过程中的业务连续性
6. **分阶段实施**：必须按照 4 个阶段逐步实施，每个阶段都要通过完整测试
7. **强制审查**：所有代码必须通过数据总线架构规范审查才能合并

## 验收标准

1. 所有功能需求的验收标准 100%通过
2. 性能测试指标达到预期目标
3. 兼容性测试通过，现有功能正常运行
4. 压力测试通过，系统在高负载下稳定运行
5. 安全测试通过，不存在新的安全漏洞
